# need Browser Mod 2.8.0-beta.2+ and UIX installed
type: custom:button-card
entity: sensor.anenji_inverter_load_power_total_output
update_interval: 12
triggers_update: []
name: anenji-flow-ui
show_icon: false
show_name: false
show_state: false
tap_action:
  action: none
variables:
  DEBUG_HIT: false
  HIT_LEFT: 22
  HIT_RIGHT: 78
  HIT_TOP: 36
  HIT_BOTTOM: 84
  HIT_SIZE: 120
  DC_HIT_X: 50
  DC_HIT_Y: 61
  DC_HIT_SIZE: 110
  link_x: 93
  link_y: 7
  link_size: 56
styles:
  card:
    - padding: "0"
    - margin: "0"
    - border-radius: 28px
    - overflow: hidden
    - position: relative
    - width: 100%
    - max-width: 420px
    - height: min(420px, 92vw)
    - aspect-ratio: 1 / 1
    - background: none
    - background-color: rgba(7,10,12,0.96)
    - background-image: >
        radial-gradient(circle at 50% 40%, rgba(160,220,230,0.35) 0%,
        rgba(10,16,18,0.92) 55%, rgba(7,10,12,0.96) 100%)
    - background-repeat: no-repeat
    - background-size: cover
    - "--ha-card-background": rgba(0,0,0,0)
    - "--card-background-color": rgba(0,0,0,0)
    - box-shadow: 0 10px 24px rgba(0,0,0,0.35)
  custom_fields:
    ui:
      - position: absolute
      - inset: "0"
      - width: 100%
      - max-width: 520px
      - height: 100%
      - z-index: "1"
      - pointer-events: none
    pv_hit:
      - position: absolute
      - left: "[[[ return variables.HIT_LEFT + '%'; ]]]"
      - top: "[[[ return variables.HIT_TOP + '%'; ]]]"
      - transform: translate(-50%, -50%)
      - z-index: "50"
      - pointer-events: auto
    grid_hit:
      - position: absolute
      - left: "[[[ return variables.HIT_RIGHT + '%'; ]]]"
      - top: "[[[ return variables.HIT_TOP + '%'; ]]]"
      - transform: translate(-50%, -50%)
      - z-index: "50"
      - pointer-events: auto
    bat_hit:
      - position: absolute
      - left: "[[[ return variables.HIT_LEFT + '%'; ]]]"
      - top: "[[[ return variables.HIT_BOTTOM + '%'; ]]]"
      - transform: translate(-50%, -50%)
      - z-index: "50"
      - pointer-events: auto
    home_hit:
      - position: absolute
      - left: "[[[ return variables.HIT_RIGHT + '%'; ]]]"
      - top: "[[[ return variables.HIT_BOTTOM + '%'; ]]]"
      - transform: translate(-50%, -50%)
      - z-index: "50"
      - pointer-events: auto
    dc_hit:
      - position: absolute
      - left: "[[[ return variables.DC_HIT_X + '%'; ]]]"
      - top: "[[[ return variables.DC_HIT_Y + '%'; ]]]"
      - transform: translate(-50%, -50%)
      - z-index: "55"
      - pointer-events: auto
    link_hit:
      - position: absolute
      - left: "[[[ return variables.link_x + '%'; ]]]"
      - top: "[[[ return variables.link_y + '%'; ]]]"
      - transform: translate(-50%, -50%)
      - z-index: "60"
      - pointer-events: auto
custom_fields:
  ui: |
    [[[
      const DEBUG_HIT = variables.DEBUG_HIT === true;

      if (!hass || !hass.states) {
        return `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.65);font-weight:700;">Loading…</div>`;
            }

      // helpers
      const st  = (eid) => hass.states[eid]?.state;
      const num = (eid) => {
        const v = parseFloat(st(eid));
        return Number.isFinite(v) ? v : 0;
            };

      // alarm
      const derActiveRaw = st('binary_sensor.anenji_inverter_der_alarm_active') ?? 'off';
      const isAlarm =
        (String(derActiveRaw).toLowerCase() === 'on') ||
        (String(derActiveRaw).toLowerCase() === 'true') ||
        (String(derActiveRaw) === '1');

      // entities
      const pvP   = num('sensor.anenji_inverter_pv1_power');
      const pvV   = num('sensor.anenji_inverter_pv1_voltage');

      const battP = num('sensor.anenji_inverter_battery_power_signed');
      const battV = num('sensor.anenji_inverter_battery_voltage');
      const soc   = num('sensor.anenji_inverter_battery_soc');

      const gridIn  = num('sensor.anenji_inverter_grid_import_power_filtered');
      const gridOut = num('sensor.anenji_inverter_grid_export_power_filtered');

      const homeP = num('sensor.anenji_inverter_load_power_total_output');

      // AC voltage (Shelly)
      const acV = num('sensor.shellyem_c4d8d500468f_channel_1_voltage');

      // signed grid power display (negative export)
      const gridP = (gridOut > gridIn) ? -gridOut : gridIn;

      // thresholds
      const TH = 25;
      const GRID_TH = 50;

      const showPV   = pvP > TH;
      const showHome = Math.abs(homeP) > TH;
      const showBat  = Math.abs(battP) > TH;
      const showGrid = Math.max(gridIn, gridOut) > GRID_TH;

      const batDir  = battP >= 0 ? 'charge' : 'discharge';
      const gridDir = (gridIn > GRID_TH && gridIn >= gridOut) ? 'import' : ((gridOut > GRID_TH && gridOut > gridIn) ? 'export' : 'idle');

      // formatters
      const fmtV = (v) => `${(Number.isFinite(v) ? v.toFixed(1) : 0)} V`;
      const fmtW = (w) => `${Math.round(Number.isFinite(w) ? w : 0)} W`;

      // colors
      const C_PV   = '#f5a623';
      const C_GRID = '#4da3ff';
      const C_BAT  = '#ff4ea1';
      const C_HOME = '#34d3c6';

      const ALARM_C = '#ff3b30';
      const OK_C    = 'rgba(255,255,255,0.70)';

      const linkColor = isAlarm ? ALARM_C : OK_C;
      const dcStroke  = isAlarm ? ALARM_C : '#2aa7c7';

      // soc gradient
      const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

      // Total throughput (used to pulse DC/AC ring) — tune divisor if needed
      const totalThroughput = Math.abs(pvP) + Math.abs(gridP) + Math.abs(battP) + Math.abs(homeP);
      const tDc = clamp(totalThroughput / 6000, 0, 1);
      const dcDur = (2.8 - 1.6 * tDc); // seconds (more throughput = faster pulse)
      const dcSwMin = (1.1 + 0.4 * tDc);
      const dcSwMax = (1.2 + 1.8 * tDc);
      const dcOpMin = (0.50 + 0.15 * tDc);
      const dcOpMax = (0.85 + 0.15 * tDc);

      const hexToRgb = (hex)=>{ const h=hex.replace('#',''); return {r:parseInt(h.slice(0,2),16),g:parseInt(h.slice(2,4),16),b:parseInt(h.slice(4,6),16)}; };
      const rgbToHex = ({r,g,b})=>`#${[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('')}`;
      const lerp = (a,b,t)=>a+(b-a)*t;
      const lerpColor=(c1,c2,t)=>{ const A=hexToRgb(c1),B=hexToRgb(c2); return rgbToHex({r:Math.round(lerp(A.r,B.r,t)),g:Math.round(lerp(A.g,B.g,t)),b:Math.round(lerp(A.b,B.b,t))}); };

      const SOC = clamp(soc,0,100);
      const socColor = (SOC<=50) ? lerpColor('#ff3b30','#ffd60a',SOC/50) : lerpColor('#ffd60a','#34c759',(SOC-50)/50);

      // layout (SVG coordinates)
      const SHIFT_Y = 6;

      const X_L = 22;
      const X_R = 78;
      const Y_T = 30;
      const Y_B = 78;
      const X_C = 50;
      const Y_C = 55;

      const R_NODE = 10.6;
      const R_DC   = 14.0;

      // curves
      const PV_FWD   = "M 22 30 C 34 38, 40 46, 46 52";
      const GRID_IN  = "M 78 30 C 66 38, 60 46, 54 52";
      const GRID_OUT = "M 54 52 C 60 46, 66 38, 78 30";
      const BAT_DIS  = "M 22 78 C 34 70, 40 62, 46 58";
      const BAT_CHG  = "M 46 58 C 40 62, 34 70, 22 78";
      const HOME_FWD = "M 54 58 C 60 62, 66 70, 78 78";

      const gridPath = (gridDir === 'import') ? GRID_IN : GRID_OUT;
      const batPath  = (batDir === 'charge') ? BAT_CHG : BAT_DIS;

      // channels
      const channel = (pathD, color, visible, active) => {
        if (!visible) return '';
        const base = `rgba(255,255,255,0.06)`;
        const hi   = active ? color : `rgba(255,255,255,0.08)`;
        const hiOp = active ? 0.22 : 0.09;
        return `
                <path d="${pathD}" fill="none" stroke="${base}" stroke-width="6.0" stroke-linecap="round" opacity="0.20" vector-effect="non-scaling-stroke"/>
                <path d="${pathD}" fill="none" stroke="${hi}"   stroke-width="2.8" stroke-linecap="round" opacity="${hiOp}" vector-effect="non-scaling-stroke"/>
              `;
            };

      // DASH-CHEVRON FLOW (mobile-safe)
      const chevronText = (pathId, color, visible, watts=0, baseDur=2.8, dir="fwd") => {
        if (!visible) return '';

        const MAX_W = 3200;
        const MIN_W = 40;
        // Smooth watts so animation speed doesn't jitter when sensors update
        const wRaw = Math.abs(watts);
        const now = Date.now();
        window.__anenjiFlowSmooth = window.__anenjiFlowSmooth || {};
        const st = window.__anenjiFlowSmooth[pathId] || (window.__anenjiFlowSmooth[pathId] = { w: wRaw, ts: now });

        const dt = Math.min(2000, Math.max(0, now - st.ts)); // ms
        const tau = (variables && variables.FLOW_SMOOTH_TAU_MS) ? Number(variables.FLOW_SMOOTH_TAU_MS) : 650; // ms
        const alpha = tau > 0 ? (1 - Math.exp(-dt / tau)) : 1;

        const w = st.w + alpha * (wRaw - st.w);
        st.w = w; st.ts = now;

        const t0 = clamp((w - MIN_W) / (MAX_W - MIN_W), 0, 1);
        const curve = (variables && variables.FLOW_SPEED_CURVE) ? Number(variables.FLOW_SPEED_CURVE) : 0.72;
        const t = Math.pow(t0, curve);

        // visuals
        const fs = (5.2 + 2.6 * t);
        const op = (0.12 + 0.38 * t);
        const ls = (-0.06 - 1.05 * t);

        // slower overall
        const durMax = (variables && variables.FLOW_DUR_MAX) ? Number(variables.FLOW_DUR_MAX) : (baseDur * 2.6);
        const durMin = (variables && variables.FLOW_DUR_MIN) ? Number(variables.FLOW_DUR_MIN) : 1.8;
        const dur = Math.max(durMin, durMax - (durMax - durMin) * t);

        const chevs =
          "❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯";

        const isRev = (dir === "rev");

        const a1_from = isRev ? "10%"    : "-110%";
        const a1_to   = isRev ? "110%"   : "10%";

        const a2_from = isRev ? "-40%"   : "-160%";
        const a2_to   = isRev ? "60%"    : "-40%";

        const strokeA = (0.045 + 0.075 * t);
        const strokeW = (0.06 + 0.08 * t);
        const glowPx = (0.3 + 0.5 * t);
        const glowA = (0.04 + 0.08 * t);

        const commonStyle =
                `font-size:${fs.toFixed(1)}px;font-weight:900;letter-spacing:${ls.toFixed(2)}px;` +
                `paint-order:stroke;stroke:rgba(255,255,255,${strokeA.toFixed(3)});` +
                `stroke-width:${strokeW.toFixed(2)};` +
                `filter: drop-shadow(0 0 ${glowPx.toFixed(1)}px rgba(255,255,255,${glowA.toFixed(3)}));`;

        const TL = 120;

        const layer = (from, to, oMul=1.0) => `
                <text fill="${color}" dominant-baseline="middle" style="${commonStyle}" opacity="${(oMul).toFixed(2)}">
                  <textPath href="#${pathId}" xlink:href="#${pathId}"
                      startOffset="${from}"
                      textLength="${TL}"
                      lengthAdjust="spacingAndGlyphs">
                    ${chevs}
                    <animate attributeName="startOffset"
                       dur="${dur.toFixed(2)}s"
                       repeatCount="indefinite"
                       values="${from};${to}"
                       calcMode="linear"/>
                  </textPath>
                </text>
              `;

        return `
                <g opacity="${op.toFixed(3)}">
                  ${layer(a1_from, a1_to, 1.00)}
                  ${layer(a2_from, a2_to, 0.70)}
                </g>
              `;
            };

      const glowFilterId = "glow";
      const powerStyle = (active, color, filterId=null) => `
        fill:${active ? color : "rgba(255,255,255,0.92)"};
        font-weight:900;
              ${active && filterId ? `filter:url(#${filterId});` : ``}
            `;

      const ICON_SCALE = 0.85;
      const SOC_IN_STYLE = `fill:${socColor};font-size:5.2px;font-weight:1000;`;

      // icons
      const iconPV = (cx, cy, active) => `
              <g transform="translate(${cx} ${cy}) scale(${ICON_SCALE})"
           opacity="0.95"
           style="${active ? 'animation:pulseSoft 3.6s ease-in-out infinite;' : ''}">
                <rect x="-8.5" y="-6" width="17" height="12" rx="2.2"
                fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.40)" stroke-width="0.9"/>
                <line x1="-8.5" y1="-2" x2="8.5" y2="-2" stroke="rgba(255,255,255,0.38)" stroke-width="0.8"/>
                <line x1="-8.5" y1="2"  x2="8.5" y2="2"  stroke="rgba(255,255,255,0.38)" stroke-width="0.8"/>
                <line x1="-2.8" y1="-6" x2="-2.8" y2="6" stroke="rgba(255,255,255,0.38)" stroke-width="0.8"/>
                <line x1="2.8"  y1="-6" x2="2.8"  y2="6" stroke="rgba(255,255,255,0.38)" stroke-width="0.8"/>
              </g>
            `;

      const iconGrid = (cx, cy) => `
              <g transform="translate(${cx} ${cy}) scale(${ICON_SCALE})" opacity="0.95">
                <polygon points="0,-8 4,-1 2,-1 6,8 0,2 -6,8 -2,-1 -4,-1" fill="rgba(255,255,255,0.42)"/>
                <line x1="-8" y1="8.2" x2="8" y2="8.2" stroke="rgba(255,255,255,0.40)" stroke-width="1"/>
              </g>
            `;

      const iconBattery = (cx, cy) => {
        const yTop=-7.0, yBot=7.3, h=(yBot-yTop);
        const fillH = h*(SOC/100);
        const fillY = yBot - fillH;
        return `
                <g transform="translate(${cx} ${cy}) scale(${ICON_SCALE})" opacity="0.95">
                  <rect x="-7.2" y="-9" width="14.4" height="18" rx="2.4"
                  fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.42)" stroke-width="0.9"/>
                  <rect x="-2.8" y="-11" width="5.6" height="2.6" rx="1.0" fill="rgba(255,255,255,0.42)"/>
                  <clipPath id="batClip"><rect x="-5.9" y="${yTop}" width="11.8" height="${h}" rx="1.8"/></clipPath>
                  <g clip-path="url(#batClip)">
                    <rect x="-5.9" y="${fillY}" width="11.8" height="${fillH}" rx="1.8"
                    fill="${socColor}" opacity="0.55"
                    style="${showBat ? 'animation:pulseFill 3.2s ease-in-out infinite;' : ''}"></rect>
                  </g>
                  <text x="0" y="2.0" text-anchor="middle" style="${SOC_IN_STYLE}">${Math.round(SOC)}%</text>
                </g>
              `;
            };

      const iconHome = (cx, cy) => `
              <g transform="translate(${cx} ${cy}) scale(${ICON_SCALE})" opacity="0.95">
                <polygon points="-7,1 0,-8 7,1" fill="rgba(255,255,255,0.22)" stroke="rgba(255,255,255,0.42)" stroke-width="0.9"/>
                <rect x="-6.5" y="1" width="13" height="7.5" fill="rgba(255,255,255,0.18)" stroke="rgba(255,255,255,0.42)" stroke-width="0.9"/>
                <rect x="-2.0" y="3.5" width="4.0" height="5.0" fill="rgba(255,255,255,0.35)"/>
              </g>
            `;

      // text blocks
      const TOP_DROP = -2;
      const BOT_LIFT = 2;
      const topAnchor = (yCircle, dy=0) => (yCircle - R_NODE - 13 + dy);

      const X_PV_TX   = X_L - 5;
      const X_GRID_TX = X_R + 5;
      const X_BAT_TX  = X_L - 5;
      const X_HOME_TX = X_R + 5;

      const block2 = (x, yCircle, vStr, pStr, active, color, dy=0, filterId=null) => {
        const y0 = topAnchor(yCircle, dy);
        return `
                <text x="${x}" y="${y0+6}"  text-anchor="middle" style="fill:rgba(255,255,255,0.66);font-size:4.8px;font-weight:900;">${vStr}</text>
                <text x="${x}" y="${y0+12}" text-anchor="middle" style="${powerStyle(active, color, filterId)}font-size:5.0px;font-weight:900;">${pStr}</text>
              `;
            };

      const blockBattery = (x, yCircle) => {
        const y0 = topAnchor(yCircle, -BOT_LIFT);
        return `
                <text x="${x}" y="${y0+6}"  text-anchor="middle" style="fill:rgba(255,255,255,0.66);font-size:4.8px;font-weight:900;">${fmtV(battV)}</text>
                <text x="${x}" y="${y0+12}" text-anchor="middle" style="${powerStyle(showBat, C_BAT, glowFilterId)}font-size:5.0px;font-weight:900;">${fmtW(battP)}</text>
              `;
            };

      // top-right link icon
      const SAFE_MARGIN_X = 10;
      const SAFE_MARGIN_Y = 5.5;
      const LINK_X = 100 - SAFE_MARGIN_X;
      const LINK_Y = SAFE_MARGIN_Y;

      const linkIcon = () => `
              <g transform="translate(${LINK_X} ${LINK_Y})" opacity="0.95" style="${isAlarm ? 'animation:pulseAlarm 1.2s ease-in-out infinite;' : ''}">
                <circle cx="0" cy="0" r="3.1" fill="rgba(0,0,0,0.25)" stroke="${linkColor}" stroke-width="0.8"/>
                <path d="M -1.5 0.2 c 0.0 -0.9 0.6 -1.5 1.5 -1.5 h 0.7 c 0.9 0 1.5 0.6 1.5 1.5 c 0.0 0.9 -0.6 1.5 -1.5 1.5 h -0.2"
                fill="none" stroke="${linkColor}" stroke-width="0.7" stroke-linecap="round"/>
                <path d="M 1.5 -0.2 c 0.0 0.9 -0.6 1.5 -1.5 1.5 h -0.7 c -0.9 0 -1.5 -0.6 -1.5 -1.5 c 0.0 -0.9 0.6 -1.5 1.5 -1.5 h 0.2"
                fill="none" stroke="${linkColor}" stroke-width="0.7" stroke-linecap="round"/>
              </g>
            `;

      const debugDots = DEBUG_HIT ? `
              <circle cx="22" cy="${30+SHIFT_Y}" r="7" fill="rgba(255,0,0,0.65)"/>
              <circle cx="78" cy="${30+SHIFT_Y}" r="7" fill="rgba(255,0,0,0.65)"/>
              <circle cx="22" cy="${78+SHIFT_Y}" r="7" fill="rgba(255,0,0,0.65)"/>
              <circle cx="78" cy="${78+SHIFT_Y}" r="7" fill="rgba(255,0,0,0.65)"/>
              <circle cx="${X_C}" cy="${Y_C+SHIFT_Y}" r="9" fill="rgba(255,0,0,0.65)"/>
            ` : '';

      const gridFlowDir = (gridDir === "import") ? "rev" : "fwd";
      const batFlowDir  = (batDir  === "charge") ? "rev" : "fwd";

      return `
              <div style="width:100%;height:100%;">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
               viewBox="0 0 100 100"
               preserveAspectRatio="xMidYMid meet"
               style="width:100%;height:100%;display:block;shape-rendering:geometricPrecision;text-rendering:geometricPrecision;">
                  <defs>
                    <filter id="${glowFilterId}" x="-60%" y="-60%" width="220%" height="220%">
                      <feGaussianBlur stdDeviation="1.2" result="blur"/>
                      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>

                    <filter id="arrowGlow" x="-80%" y="-80%" width="260%" height="260%">
                      <feGaussianBlur stdDeviation="0.9" result="blur"/>
                      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>

                    <!-- Motion paths (referenced by chevrons) -->
                    <path id="pvPath"   d="${PV_FWD}"   fill="none"/>
                    <path id="gridPath" d="${gridPath}" fill="none"/>
                    <path id="batPath"  d="${batPath}"  fill="none"/>
                    <path id="homePath" d="${HOME_FWD}" fill="none"/>

                    <style>
                      @keyframes pulseSoft { 0%,100% { opacity: .60; } 50% { opacity: .95; } }
                      @keyframes pulseFill { 0%,100% { opacity: .45; } 50% { opacity: .80; } }
                      @keyframes pulseAlarm { 0%,100% { opacity: .40; } 50% { opacity: 1.0; } }
                    /* --- FINAL spacing override (tight label + value + unit) --- */
                    .row{
                display: flex !important;
                align-items: center !important;
                justify-content: flex-start !important;
                gap: 14px !important;
                width: fit-content !important;
                max-width: var(--popup-width) !important;
                    }
                    .name{ flex: 0 0 auto !important; }
                    .val{  flex: 0 0 auto !important; margin: 0 !important; }
                    .unit{ flex: 0 0 auto !important; margin: 0 !important; opacity: 0.75 !important; }
                    /* --- Prevent parent stretch (key for tight pills) --- */
                    .grid{
                align-items: flex-start !important;
                    }
                    .row{
                align-self: flex-start !important;
                    }
                    /* --- Align values (fixed label width) --- */
              :root{
                --label-width: 170px;
                    }
                    @media (max-width: 600px){
                :root{
                  --label-width: 140px;
                      }
                    }
                    .row > :nth-child(1){
                flex: 0 0 var(--label-width) !important;
                width: var(--label-width) !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                    }
                    .row > :nth-child(2){
                min-width: 64px !important;
                text-align: right !important;
                    }
                    /***** INDUSTRIAL THEME *****/
              :root{
                --panel-bg: rgba(20,22,24,0.92);
                --pill-bg: rgba(255,255,255,0.04);
                --pill-border: rgba(255,255,255,0.10);
                --text-dim: rgba(255,255,255,0.72);
                --text-dimmer: rgba(255,255,255,0.55);
                --shadow-soft: 0 10px 30px rgba(0,0,0,0.35);
                --shadow-inset: inset 0 1px 0 rgba(255,255,255,0.05), inset 0 -1px 0 rgba(0,0,0,0.25);
                    }
              
                    .wrap{ width:100% !important; max-width:100% !important; }
                    .grid{
                width: 100% !important;
                max-width: var(--popup-width) !important;
                background: var(--panel-bg) !important;
                border: 1px solid rgba(255,255,255,0.06) !important;
                border-radius: 16px !important;
                padding: 14px 14px 12px !important;
                box-shadow: var(--shadow-soft) !important;
                    }
              
                    .row{
                width: 100% !important;
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                padding: 12px 14px !important;
                border-radius: 16px !important;
                background: var(--pill-bg) !important;
                border: 1px solid var(--pill-border) !important;
                box-shadow: var(--shadow-inset) !important;
                    }
              
                    .row > :nth-child(1){
                flex: 0 0 var(--label-width) !important;
                width: var(--label-width) !important;
                color: var(--text-dim) !important;
                font-weight: 700 !important;
                letter-spacing: 0.2px !important;
                text-transform: uppercase !important;
                font-size: 13px !important;
                    }
                    .row > :nth-child(2){
                font-variant-numeric: tabular-nums !important;
                font-weight: 800 !important;
                font-size: 22px !important;
                line-height: 1 !important;
                    }
                    .row > :nth-child(3){
                color: var(--text-dimmer) !important;
                font-weight: 700 !important;
                font-size: 13px !important;
                margin-left: 4px !important;
                letter-spacing: 0.4px !important;
                text-transform: uppercase !important;
                    }
              
                    .row + .row{
                margin-top: 10px !important;
                    }
              
                    @media (max-width: 600px){
                      .grid{ padding: 12px !important; border-radius: 14px !important; }
                      .row{ padding: 11px 12px !important; border-radius: 14px !important; }
                      .row > :nth-child(2){ font-size: 20px !important; }
                    }
                    /***** TESLA-STYLE UI (soft glow, glass pills, tight rhythm) *****/
              :root{
                --panel-bg: rgba(12,14,16,0.82);
                --panel-border: rgba(255,255,255,0.06);
                --pill-bg: rgba(255,255,255,0.055);
                --pill-bg-2: rgba(255,255,255,0.035);
                --pill-border: rgba(255,255,255,0.08);
                --text: rgba(255,255,255,0.92);
                --text-dim: rgba(255,255,255,0.72);
                --text-dimmer: rgba(255,255,255,0.55);
                --shadow: 0 18px 50px rgba(0,0,0,0.45);
                --inset: inset 0 1px 0 rgba(255,255,255,0.07), inset 0 -1px 0 rgba(0,0,0,0.35);
                --glow: 0 0 18px rgba(80,180,255,0.14);
                --radius: 18px;
                    }
              
                    /* Panel */
                    .wrap{ width:100% !important; max-width:100% !important; }
                    .grid{
                width: 100% !important;
                max-width: var(--popup-width) !important;
                background: radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00) 42%),
                            linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%),
                            var(--panel-bg) !important;
                border: 1px solid var(--panel-border) !important;
                border-radius: calc(var(--radius) + 2px) !important;
                padding: 12px 12px 10px !important;
                box-shadow: var(--shadow), var(--glow) !important;
                backdrop-filter: blur(10px);
                    }
              
                    /* Rows (glass pills) */
                    .row{
                width: 100% !important;
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                padding: 10px 12px !important;
                border-radius: var(--radius) !important;
                background: linear-gradient(180deg, var(--pill-bg) 0%, var(--pill-bg-2) 100%) !important;
                border: 1px solid var(--pill-border) !important;
                box-shadow: var(--inset) !important;
                    }
              
                    /* Tight rhythm */
                    .row + .row{ margin-top: 8px !important; }
              
                    /* Label / value / unit */
                    .row > :nth-child(1){
                flex: 0 0 var(--label-width) !important;
                width: var(--label-width) !important;
                color: var(--text-dim) !important;
                font-weight: 650 !important;
                letter-spacing: 0.18px !important;
                font-size: 13px !important;
                text-transform: none !important;
                    }
                    .row > :nth-child(2){
                color: var(--text) !important;
                font-variant-numeric: tabular-nums !important;
                font-weight: 800 !important;
                font-size: 22px !important;
                line-height: 1 !important;
                text-align: right !important;
                min-width: 68px !important;
                    }
                    .row > :nth-child(3){
                color: var(--text-dimmer) !important;
                font-weight: 700 !important;
                font-size: 12px !important;
                letter-spacing: 0.3px !important;
                text-transform: uppercase !important;
                    }
              
                    /* Subtle hover (desktop) */
                    @media (hover:hover){
                      .row:hover{
                  border-color: rgba(255,255,255,0.14) !important;
                  box-shadow: var(--inset), 0 0 18px rgba(255,255,255,0.06) !important;
                      }
                    }
              
                    /* Mobile tuning */
                    @media (max-width: 600px){
                      .grid{ padding: 10px !important; border-radius: 18px !important; }
                      .row{ padding: 10px 11px !important; border-radius: 16px !important; }
                      .row > :nth-child(2){ font-size: 20px !important; min-width: 62px !important; }
                      .row > :nth-child(1){ font-size: 12.5px !important; }
                    }
                    /***** TESLA POPUP REFINEMENT (based on your HTML structure) *****/
              
                    /* 1) Remove inner dark title (e.g., PV/Battery) */
                    .wrap > .title{
                display: none !important;
                    }
              
                    /* 2) Make panel/rows use full available width (kills right-side empty gap) */
                    .wrap{
                width: min(var(--popup-width), 95vw) !important;
                max-width: min(var(--popup-width), 95vw) !important;
                    }
                    .grid{
                width: 100% !important;
                max-width: 100% !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: stretch !important;   /* critical: prevents centered/narrow rows */
                    }
              
                    /* 3) Row layout: label left, value+unit tight right */
                    .row{
                width: 100% !important;
                display: grid !important;
                grid-template-columns: 1fr auto auto !important;
                column-gap: 10px !important;
                align-items: center !important;
                    }
              
                    /* 4) Typography: make labels bigger & consistent with values */
                    .name{
                font-size: 18px !important;
                font-weight: 650 !important;
                color: rgba(255,255,255,0.82) !important;
                letter-spacing: 0.12px !important;
                    }
                    .val{
                font-size: 30px !important;
                font-weight: 800 !important;
                line-height: 1 !important;
                text-align: right !important;
                font-variant-numeric: tabular-nums !important;
                    }
                    .unit{
                font-size: 16px !important;
                font-weight: 700 !important;
                opacity: 0.65 !important;
                letter-spacing: 0.3px !important;
                text-transform: uppercase !important;
                    }
              
                    /* Mobile tuning */
                    @media (max-width: 600px){
                      .name{ font-size: 17px !important; }
                      .val{ font-size: 28px !important; }
                      .unit{ font-size: 15px !important; }
                    }
                    /***** TESLA PILLS + FULL-WIDTH PANEL (ALL POPUPS) *****/
                    .wrap{ width:100% !important; box-sizing:border-box !important; padding:14px !important;
                background: radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00) 42%),
                            linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%),
                            rgba(12,14,16,0.86) !important;
                border:1px solid rgba(255,255,255,0.06) !important;
                border-radius:20px !important;
                box-shadow: 0 18px 50px rgba(0,0,0,0.45), 0 0 18px rgba(80,180,255,0.14) !important;
                backdrop-filter: blur(10px);
                    }
                    .wrap > .title{ display:none !important; }
                    .grid{ width:100% !important; max-width:100% !important; display:flex !important; flex-direction:column !important;
                gap:10px !important; padding:0 !important; background:transparent !important; border:none !important; box-shadow:none !important;
                    }
                    .row{ width:100% !important; display:grid !important; grid-template-columns: 1fr auto auto !important; column-gap:10px !important;
                align-items:center !important; padding:12px 14px !important; border-radius:18px !important;
                background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.035) 100%) !important;
                border:1px solid rgba(255,255,255,0.10) !important;
                box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), inset 0 -1px 0 rgba(0,0,0,0.38) !important;
                    }
                    .name{ font-size:18px !important; font-weight:650 !important; color:rgba(255,255,255,0.84) !important; }
                    .val{ font-size:30px !important; font-weight:800 !important; line-height:1 !important; font-variant-numeric: tabular-nums !important; text-align:right !important; }
                    .unit{ font-size:16px !important; font-weight:700 !important; opacity:0.65 !important; letter-spacing:0.3px !important; text-transform:uppercase !important; }
                    @media (max-width:600px){
                      .wrap{ padding:12px !important; border-radius:18px !important; }
                      .row{ padding:11px 12px !important; border-radius:16px !important; }
                      .name{ font-size:17px !important; }
                      .val{ font-size:28px !important; }
                      .unit{ font-size:15px !important; }
                    }
                    /***** FIX: make panel + pills stretch full width (no left-column cutout) *****/
                    .wrap{
                display:block !important;
                width:100% !important;
                max-width:none !important;
                min-width:0 !important;
                flex: 1 1 auto !important;
                    }
                    .grid{
                display:flex !important;
                flex-direction:column !important;
                align-items:stretch !important;
                justify-content:flex-start !important;
                width:100% !important;
                max-width:none !important;
                min-width:0 !important;
                    }
                    .row{
                width:100% !important;
                max-width:none !important;
                min-width:0 !important;
                    }
              
                    /* --- vNEXT: center panel + prevent right-cut (global) --- */
                    .wrap{
                width: 100% !important;
                display: flex !important;
                justify-content: center !important;
                    }
                    .grid{
                width: 100% !important;
                max-width: min(560px, 100%) !important;
                    }
                    .row{
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                display: grid !important;
                grid-template-columns: 1fr auto auto !important;
                column-gap: 14px !important;
                align-items: center !important;
                justify-content: initial !important;
                gap: 0 !important;
                overflow: visible !important;
                    }
                    .name{
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                min-width: 0 !important;
                    }
                    .val, .unit{
                white-space: nowrap !important;
                    }
                    .unit{ padding-right: 6px !important; }

                    /* Center the inner panel within the popup */

                    .wrap{

                      max-width: 520px !important;

                      margin: 0 auto !important;

                    }

                    /* ===== Typography + layout (global override) ===== */
                    .wrap {
                      width: min(900px, 100%) !important;
                      margin: 0 auto !important;
                    }
                    .grid {
                      width: 100% !important;
                    }
                    .row {
                      display: grid !important;
                      grid-template-columns: 1fr auto auto !important;
                      align-items: center !important;
                      column-gap: 12px !important;
                      padding: 14px 18px !important;
                      border-radius: 999px !important;
                    }
                    .name {
                      font-size: clamp(14px, 2.1vw, 18px) !important;
                      font-weight: 750 !important;
                      letter-spacing: 0.08em !important;
                      text-transform: uppercase !important;
                      opacity: 0.92 !important;
                    }
                    .val {
                      font-size: clamp(28px, 4.2vw, 46px) !important;
                      font-weight: 850 !important;
                      letter-spacing: -0.02em !important;
                      font-variant-numeric: tabular-nums !important;
                      line-height: 1 !important;
                      color: #f5a623 !important;
                    }
                    .unit {
                      font-size: clamp(13px, 1.9vw, 18px) !important;
                      font-weight: 750 !important;
                      letter-spacing: 0.06em !important;
                      text-transform: uppercase !important;
                      opacity: 0.55 !important;
                    }
                    </style>
                  </defs>

                  ${linkIcon()}
                  ${debugDots}

                  <g transform="translate(0 ${SHIFT_Y})">
                    ${channel(PV_FWD,   C_PV,   true,     showPV)}
                    ${channel(gridPath, C_GRID, showGrid, showGrid)}
                    ${channel(batPath,  C_BAT,  true,     showBat)}
                    ${channel(HOME_FWD, C_HOME, true,     showHome)}

                    ${chevronText("pvPath",   C_PV,   showPV,  pvP,  3.6, "fwd")}
                    ${chevronText("gridPath", C_GRID, showGrid, gridP, 2.8, gridFlowDir)}
                    ${chevronText("batPath",  C_BAT,  showBat,  battP, 2.2, batFlowDir)}
                    ${chevronText("homePath", C_HOME, showHome, homeP, 2.4, "fwd")}

                    <circle cx="${X_C}" cy="${Y_C}" r="${R_DC}" fill="#0d3c50" stroke="${dcStroke}"
                      stroke-width="${dcSwMin.toFixed(2)}" stroke-opacity="${dcOpMin.toFixed(2)}"
                      filter="url(#arrowGlow)">
                      <animate attributeName="stroke-width"
                         values="${dcSwMin.toFixed(2)};${dcSwMax.toFixed(2)};${dcSwMin.toFixed(2)}"
                         dur="${dcDur.toFixed(2)}s"
                         repeatCount="indefinite"/>
                      <animate attributeName="stroke-opacity"
                         values="${dcOpMin.toFixed(2)};${dcOpMax.toFixed(2)};${dcOpMin.toFixed(2)}"
                         dur="${dcDur.toFixed(2)}s"
                         repeatCount="indefinite"/>
                    </circle>
                    <text x="${X_C}" y="${Y_C-1}" text-anchor="middle" fill="white" font-size="6.2" font-weight="800">DC/AC</text>
                    <text x="${X_C}" y="${Y_C+6}" text-anchor="middle" fill="rgba(255,255,255,0.6)" font-size="5" font-weight="700">~ ~</text>

                    <circle cx="${X_L}" cy="${Y_T}" r="${R_NODE}" fill="#0d0f14" stroke="${C_PV}" stroke-width="2"/>
                    ${iconPV(X_L, Y_T, showPV)}
                    ${block2(X_PV_TX, Y_T, fmtV(pvV), fmtW(pvP), showPV, C_PV, TOP_DROP, glowFilterId)}

                    <circle cx="${X_R}" cy="${Y_T}" r="${R_NODE}" fill="#0d0f14" stroke="${C_GRID}" stroke-width="2"/>
                    ${iconGrid(X_R, Y_T)}
                    ${block2(X_GRID_TX, Y_T, fmtV(acV), fmtW(Math.abs(gridP)), showGrid, C_GRID, TOP_DROP, glowFilterId)}

                    <circle cx="${X_L}" cy="${Y_B}" r="${R_NODE}" fill="#0d0f14" stroke="${C_BAT}" stroke-width="2"/>
                    ${iconBattery(X_L, Y_B)}
                    ${blockBattery(X_BAT_TX, Y_B)}

                    <circle cx="${X_R}" cy="${Y_B}" r="${R_NODE}" fill="#0d0f14" stroke="${C_HOME}" stroke-width="2"/>
                    ${iconHome(X_R, Y_B)}
                    ${block2(X_HOME_TX, Y_B, fmtV(acV), fmtW(homeP), showHome, C_HOME, -BOT_LIFT, glowFilterId)}
                  </g>
                </svg>
              </div>
            `;
          ]]]
  pv_hit:
    card:
      type: custom:button-card
      show_name: false
      show_icon: false
      show_state: false
      styles:
        card:
          - width: "[[[ return variables.HIT_SIZE + 'px'; ]]]"
          - height: "[[[ return variables.HIT_SIZE + 'px'; ]]]"
          - z-index: 50
          - pointer-events: auto
          - z-index: 50
          - pointer-events: auto
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: "0"
          - margin: "0"
          - background: >
              [[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" :
              "transparent"; ]]]
          - opacity: |
              [[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]
          - "--mdc-ripple-color": transparent
          - "--mdc-ripple-press-opacity": "0"
      tap_action:
        action: fire-dom-event
        browser_mod:
          service: browser_mod.popup
          data:
            hide_header: true
            title: "PV"
            timeout: 0
            dismissable: true
            size: normal
            style: |
              /* OUTER popup surface = WHITE */
              ha-dialog::part(surface),
              .mdc-dialog__surface,
              wa-dialog::part(panel),
              .dialog__panel {
                background: #ffffff !important;
                border-radius: 26px !important;
              }

              /* Nuke native header/close if it still appears (BM 2.8 beta quirk) */
              ha-dialog::part(header),
              ha-dialog::part(close-button),
              .mdc-dialog__header,
              button[dialogAction="close"],
              button[aria-label="Close"] {
                display: none !important;
              }

              /* INNER content area = DARK (this is the big one for your case) */
              ha-dialog .mdc-dialog__content,
              ha-dialog .dialog__content,
              ha-dialog .content,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup > * {
                background: rgba(15,20,24,0.96) !important;
              }

              /* Entities/cards inside = DARK */
              ha-dialog ha-card,
              ha-dialog .card,
              ha-dialog .card-content,
              ha-dialog hui-card {
                background: rgba(15,20,24,0.96) !important;
                border-radius: 18px !important;
              }

              /* White text/icons inside */
              ha-dialog .mdc-dialog__content,
              ha-dialog .mdc-dialog__content *,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup * {
                color: rgba(255,255,255,0.92) !important;
                --primary-text-color: rgba(255,255,255,0.92) !important;
                --secondary-text-color: rgba(255,255,255,0.72) !important;
                --paper-item-icon-color: rgba(180,220,255,0.95) !important;
              }

              /* Layering */
              ha-dialog,
              .mdc-dialog,
              .mdc-dialog__container,
              wa-dialog,
              .dialog__panel {
                z-index: 999999 !important;
              }
            content:
              type: vertical-stack
              cards:
                - type: custom:button-card
                  name: PV
                  show_icon: false
                  show_name: true
                  show_state: false
                  tap_action:
                    action: fire-dom-event
                    browser_mod:
                      service: browser_mod.close_popup
                  custom_fields:
                    close: >-
                      [[[ return `<ha-icon icon="mdi:close"
                      style="width:22px;height:22px;"></ha-icon>` ]]]
                  styles:
                    card:
                      - display: none
                      - height: 44px
                      - padding: 0 14px
                      - border-radius: 14px
                      - background: rgba(15,20,24,0.95)
                      - box-shadow: none
                      - margin: 0 0 10px 0
                      - position: relative
                    name:
                      - font-size: 18px
                      - font-weight: "800"
                      - color: white
                      - justify-self: center
                      - align-self: center
                    custom_fields:
                      close:
                        - position: absolute
                        - right: 12px
                        - top: 10px
                        - color: rgba(255,255,255,0.9)
                - type: entities
                  show_header_toggle: false
                  entities:
                    - entity: sensor.anenji_inverter_pv1_voltage
                      name: PV1 Voltage
                    - entity: sensor.anenji_inverter_pv1_current
                      name: PV1 Current
                    - entity: sensor.anenji_inverter_pv1_power
                      name: PV1 Power
                    - entity: sensor.anenji_inverter_pv2_voltage
                      name: PV2 Voltage
                    - entity: sensor.anenji_inverter_pv2_current
                      name: PV2 Current
                    - entity: sensor.anenji_inverter_pv2_power
                      name: PV2 Power
          uix:
            style:
              ha-dialog $: |
                |
                  /* Hide native header (top-left X) */
                  ha-dialog-header,
                  ha-dialog-header *,
                  .mdc-dialog__header,
                  .mdc-dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .mdc-dialog__content { padding: 0 !important; }
                  
                  /* Surface visuals */
                  .mdc-dialog__surface{
                    background: rgba(15,20,24,0.96) !important;
                    box-shadow: none !important;
                  }
              ha-dialog $ wa-dialog $: |
                |
                  /* WebAwesome dialog header (BM 2.8) */
                  header,
                  header *,
                  .dialog__header,
                  .dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .dialog__panel,
                  .dialog__content { padding: 0 !important; }
  bat_hit:
    card:
      type: custom:button-card
      show_name: false
      show_icon: false
      show_state: false
      styles:
        card:
          - width: "[[[ return variables.HIT_SIZE + 'px'; ]]]"
          - height: "[[[ return variables.HIT_SIZE + 'px'; ]]]"
          - z-index: 50
          - pointer-events: auto
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: "0"
          - margin: "0"
          - background: >
              [[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" :
              "transparent"; ]]]
          - opacity: |
              [[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]
          - "--mdc-ripple-color": transparent
          - "--mdc-ripple-press-opacity": "0"
      tap_action:
        action: fire-dom-event
        browser_mod:
          service: browser_mod.popup
          data:
            hide_header: false
            title: "Battery"
            timeout: 0
            dismissable: true
            size: normal
            style: |
              /* OUTER popup surface = WHITE */
              ha-dialog::part(surface),
              .mdc-dialog__surface,
              wa-dialog::part(panel),
              .dialog__panel {
                background: #ffffff !important;
                border-radius: 26px !important;
              }

              /* Nuke native header/close if it still appears (BM 2.8 beta quirk) */
              ha-dialog::part(header),
              ha-dialog::part(close-button),
              .mdc-dialog__header,
              button[dialogAction="close"],
              button[aria-label="Close"] {
                display: none !important;
              }

              /* INNER content area = DARK (this is the big one for your case) */
              ha-dialog .mdc-dialog__content,
              ha-dialog .dialog__content,
              ha-dialog .content,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup > * {
                background: rgba(15,20,24,0.96) !important;
              }

              /* Entities/cards inside = DARK */
              ha-dialog ha-card,
              ha-dialog .card,
              ha-dialog .card-content,
              ha-dialog hui-card {
                background: rgba(15,20,24,0.96) !important;
                border-radius: 18px !important;
              }

              /* White text/icons inside */
              ha-dialog .mdc-dialog__content,
              ha-dialog .mdc-dialog__content *,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup * {
                color: rgba(255,255,255,0.92) !important;
                --primary-text-color: rgba(255,255,255,0.92) !important;
                --secondary-text-color: rgba(255,255,255,0.72) !important;
                --paper-item-icon-color: rgba(180,220,255,0.95) !important;
              }

              /* Layering */
              ha-dialog,
              .mdc-dialog,
              .mdc-dialog__container,
              wa-dialog,
              .dialog__panel {
                z-index: 999999 !important;
              }
            content:
              type: vertical-stack
              cards:
                - type: custom:button-card
                  name: Battery
                  show_icon: false
                  show_name: true
                  show_state: false
                  tap_action:
                    action: fire-dom-event
                    browser_mod:
                      service: browser_mod.close_popup
                  custom_fields:
                    close: >-
                      [[[ return `<ha-icon icon="mdi:close"
                      style="width:22px;height:22px;"></ha-icon>` ]]]
                  styles:
                    card:
                      - display: none
                      - height: 44px
                      - padding: 0 14px
                      - border-radius: 14px
                      - background: rgba(15,20,24,0.95)
                      - box-shadow: none
                      - margin: 0 0 10px 0
                      - position: relative
                    name:
                      - font-size: 18px
                      - font-weight: "800"
                      - color: white
                      - justify-self: center
                      - align-self: center
                    custom_fields:
                      close:
                        - position: absolute
                        - right: 12px
                        - top: 10px
                        - color: rgba(255,255,255,0.9)
                - type: entities
                  show_header_toggle: false
                  entities:
                    - entity: sensor.anenji_inverter_battery_voltage
                      name: Battery Voltage
                    - entity: sensor.anenji_inverter_battery_current
                      name: Battery Current
                    - entity: sensor.anenji_inverter_battery_power_signed
                      name: Battery Power
                    - entity: sensor.anenji_inverter_battery_soc
                      name: Battery %
          uix:
            style:
              ha-dialog $: |
                |
                  /* Hide native header (top-left X) */
                  ha-dialog-header,
                  ha-dialog-header *,
                  .mdc-dialog__header,
                  .mdc-dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .mdc-dialog__content { padding: 0 !important; }
                  
                  /* Surface visuals */
                  .mdc-dialog__surface{
                    background: rgba(15,20,24,0.96) !important;
                    box-shadow: none !important;
                  }
              ha-dialog $ wa-dialog $: |
                |
                  /* WebAwesome dialog header (BM 2.8) */
                  header,
                  header *,
                  .dialog__header,
                  .dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .dialog__panel,
                  .dialog__content { padding: 0 !important; }
  grid_hit:
    card:
      type: custom:button-card
      show_name: false
      show_icon: false
      show_state: false
      styles:
        card:
          - width: "[[[ return variables.HIT_SIZE + 'px'; ]]]"
          - height: "[[[ return variables.HIT_SIZE + 'px'; ]]]"
          - z-index: 50
          - pointer-events: auto
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: "0"
          - margin: "0"
          - background: >
              [[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" :
              "transparent"; ]]]
          - opacity: |
              [[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]
          - "--mdc-ripple-color": transparent
          - "--mdc-ripple-press-opacity": "0"
      tap_action:
        action: fire-dom-event
        browser_mod:
          service: browser_mod.popup
          data:
            hide_header: false
            title: "Grid"
            timeout: 0
            dismissable: true
            size: normal
            style: |
              /* OUTER popup surface = WHITE */
              ha-dialog::part(surface),
              .mdc-dialog__surface,
              wa-dialog::part(panel),
              .dialog__panel {
                background: #ffffff !important;
                border-radius: 26px !important;
              }

              /* Nuke native header/close if it still appears (BM 2.8 beta quirk) */
              ha-dialog::part(header),
              ha-dialog::part(close-button),
              .mdc-dialog__header,
              button[dialogAction="close"],
              button[aria-label="Close"] {
                display: none !important;
              }

              /* INNER content area = DARK (this is the big one for your case) */
              ha-dialog .mdc-dialog__content,
              ha-dialog .dialog__content,
              ha-dialog .content,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup > * {
                background: rgba(15,20,24,0.96) !important;
              }

              /* Entities/cards inside = DARK */
              ha-dialog ha-card,
              ha-dialog .card,
              ha-dialog .card-content,
              ha-dialog hui-card {
                background: rgba(15,20,24,0.96) !important;
                border-radius: 18px !important;
              }

              /* White text/icons inside */
              ha-dialog .mdc-dialog__content,
              ha-dialog .mdc-dialog__content *,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup * {
                color: rgba(255,255,255,0.92) !important;
                --primary-text-color: rgba(255,255,255,0.92) !important;
                --secondary-text-color: rgba(255,255,255,0.72) !important;
                --paper-item-icon-color: rgba(180,220,255,0.95) !important;
              }

              /* Layering */
              ha-dialog,
              .mdc-dialog,
              .mdc-dialog__container,
              wa-dialog,
              .dialog__panel {
                z-index: 999999 !important;
              }
            content:
              type: vertical-stack
              cards:
                - type: custom:button-card
                  name: Grid
                  show_icon: false
                  show_name: true
                  show_state: false
                  tap_action:
                    action: fire-dom-event
                    browser_mod:
                      service: browser_mod.close_popup
                  custom_fields:
                    close: >-
                      [[[ return `<ha-icon icon="mdi:close"
                      style="width:22px;height:22px;"></ha-icon>` ]]]
                  styles:
                    card:
                      - display: none
                      - height: 44px
                      - padding: 0 14px
                      - border-radius: 14px
                      - background: rgba(15,20,24,0.95)
                      - box-shadow: none
                      - margin: 0 0 10px 0
                      - position: relative
                    name:
                      - font-size: 18px
                      - font-weight: "800"
                      - color: white
                      - justify-self: center
                      - align-self: center
                    custom_fields:
                      close:
                        - position: absolute
                        - right: 12px
                        - top: 10px
                        - color: rgba(255,255,255,0.9)
                - type: entities
                  show_header_toggle: false
                  entities:
                    - entity: sensor.anenji_inverter_grid_import_power_filtered
                      name: Grid Power
                    - entity: sensor.anenji_inverter_mains_voltage_l1
                      name: Grid Line 1 Voltage
                    - entity: sensor.anenji_inverter_mains_current_l1
                      name: Grid Line 1 Amperage
                    - entity: sensor.anenji_inverter_mains_voltage_l2
                      name: Grid Line 2 Voltage
                    - entity: sensor.anenji_inverter_mains_current_l2
                      name: Grid Line 2 Amperage
          uix:
            style:
              ha-dialog $: |
                |
                  /* Hide native header (top-left X) */
                  ha-dialog-header,
                  ha-dialog-header *,
                  .mdc-dialog__header,
                  .mdc-dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .mdc-dialog__content { padding: 0 !important; }
                  
                  /* Surface visuals */
                  .mdc-dialog__surface{
                    background: rgba(15,20,24,0.96) !important;
                    box-shadow: none !important;
                  }
              ha-dialog $ wa-dialog $: |
                |
                  /* WebAwesome dialog header (BM 2.8) */
                  header,
                  header *,
                  .dialog__header,
                  .dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .dialog__panel,
                  .dialog__content { padding: 0 !important; }
  home_hit:
    card:
      type: custom:button-card
      show_name: false
      show_icon: false
      show_state: false
      styles:
        card:
          - width: "[[[ return variables.HIT_SIZE + 'px'; ]]]"
          - height: "[[[ return variables.HIT_SIZE + 'px'; ]]]"
          - z-index: 50
          - pointer-events: auto
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: "0"
          - margin: "0"
          - background: >
              [[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" :
              "transparent"; ]]]
          - opacity: |
              [[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]
          - "--mdc-ripple-color": transparent
          - "--mdc-ripple-press-opacity": "0"
      tap_action:
        action: fire-dom-event
        browser_mod:
          service: browser_mod.popup
          data:
            hide_header: false
            title: "Home"
            timeout: 0
            dismissable: true
            size: normal
            style: |
              /* OUTER popup surface = WHITE */
              ha-dialog::part(surface),
              .mdc-dialog__surface,
              wa-dialog::part(panel),
              .dialog__panel {
                background: #ffffff !important;
                border-radius: 26px !important;
              }

              /* Nuke native header/close if it still appears (BM 2.8 beta quirk) */
              ha-dialog::part(header),
              ha-dialog::part(close-button),
              .mdc-dialog__header,
              button[dialogAction="close"],
              button[aria-label="Close"] {
                display: none !important;
              }

              /* INNER content area = DARK (this is the big one for your case) */
              ha-dialog .mdc-dialog__content,
              ha-dialog .dialog__content,
              ha-dialog .content,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup > * {
                background: rgba(15,20,24,0.96) !important;
              }

              /* Entities/cards inside = DARK */
              ha-dialog ha-card,
              ha-dialog .card,
              ha-dialog .card-content,
              ha-dialog hui-card {
                background: rgba(15,20,24,0.96) !important;
                border-radius: 18px !important;
              }

              /* White text/icons inside */
              ha-dialog .mdc-dialog__content,
              ha-dialog .mdc-dialog__content *,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup * {
                color: rgba(255,255,255,0.92) !important;
                --primary-text-color: rgba(255,255,255,0.92) !important;
                --secondary-text-color: rgba(255,255,255,0.72) !important;
                --paper-item-icon-color: rgba(180,220,255,0.95) !important;
              }

              /* Layering */
              ha-dialog,
              .mdc-dialog,
              .mdc-dialog__container,
              wa-dialog,
              .dialog__panel {
                z-index: 999999 !important;
              }
            content:
              type: vertical-stack
              cards:
                - type: custom:button-card
                  name: Home
                  show_icon: false
                  show_name: true
                  show_state: false
                  tap_action:
                    action: fire-dom-event
                    browser_mod:
                      service: browser_mod.close_popup
                  custom_fields:
                    close: >-
                      [[[ return `<ha-icon icon="mdi:close"
                      style="width:22px;height:22px;"></ha-icon>` ]]]
                  styles:
                    card:
                      - display: none
                      - height: 44px
                      - padding: 0 14px
                      - border-radius: 14px
                      - background: rgba(15,20,24,0.95)
                      - box-shadow: none
                      - margin: 0 0 10px 0
                      - position: relative
                    name:
                      - font-size: 18px
                      - font-weight: "800"
                      - color: white
                      - justify-self: center
                      - align-self: center
                    custom_fields:
                      close:
                        - position: absolute
                        - right: 12px
                        - top: 10px
                        - color: rgba(255,255,255,0.9)
                - type: entities
                  show_header_toggle: false
                  entities:
                    - entity: sensor.anenji_inverter_load_power_total
                      name: Home Power
                    - entity: sensor.anenji_inverter_output_voltage_l1
                      name: Home Line 1 Voltage
                    - entity: sensor.anenji_inverter_output_current_l1
                      name: Home Line 1 Amperage
                    - entity: sensor.anenji_inverter_output_voltage_l2
                      name: Home Line 2 Voltage
                    - entity: sensor.anenji_inverter_output_current_l2
                      name: Home Line 2 Amperage
          uix:
            style:
              ha-dialog $: |
                |
                  /* Hide native header (top-left X) */
                  ha-dialog-header,
                  ha-dialog-header *,
                  .mdc-dialog__header,
                  .mdc-dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .mdc-dialog__content { padding: 0 !important; }
                  
                  /* Surface visuals */
                  .mdc-dialog__surface{
                    background: rgba(15,20,24,0.96) !important;
                    box-shadow: none !important;
                  }
              ha-dialog $ wa-dialog $: |
                |
                  /* WebAwesome dialog header (BM 2.8) */
                  header,
                  header *,
                  .dialog__header,
                  .dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .dialog__panel,
                  .dialog__content { padding: 0 !important; }
  dc_hit:
    card:
      type: custom:button-card
      show_name: false
      show_icon: false
      show_state: false
      styles:
        card:
          - width: "[[[ return variables.DC_HIT_SIZE + 'px'; ]]]"
          - height: "[[[ return variables.DC_HIT_SIZE + 'px'; ]]]"
          - z-index: 50
          - pointer-events: auto
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: "0"
          - margin: "0"
          - background: >
              [[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" :
              "transparent"; ]]]
          - opacity: |
              [[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]
          - "--mdc-ripple-color": transparent
          - "--mdc-ripple-press-opacity": "0"
      tap_action:
        action: fire-dom-event
        browser_mod:
          service: browser_mod.popup
          data:
            hide_header: false
            title: "DC/AC"
            timeout: 0
            dismissable: true
            size: normal
            style: |
              /* OUTER popup surface = WHITE */
              ha-dialog::part(surface),
              .mdc-dialog__surface,
              wa-dialog::part(panel),
              .dialog__panel {
                background: #ffffff !important;
                border-radius: 26px !important;
              }

              /* Nuke native header/close if it still appears (BM 2.8 beta quirk) */
              ha-dialog::part(header),
              ha-dialog::part(close-button),
              .mdc-dialog__header,
              button[dialogAction="close"],
              button[aria-label="Close"] {
                display: none !important;
              }

              /* INNER content area = DARK (this is the big one for your case) */
              ha-dialog .mdc-dialog__content,
              ha-dialog .dialog__content,
              ha-dialog .content,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup > * {
                background: rgba(15,20,24,0.96) !important;
              }

              /* Entities/cards inside = DARK */
              ha-dialog ha-card,
              ha-dialog .card,
              ha-dialog .card-content,
              ha-dialog hui-card {
                background: rgba(15,20,24,0.96) !important;
                border-radius: 18px !important;
              }

              /* White text/icons inside */
              ha-dialog .mdc-dialog__content,
              ha-dialog .mdc-dialog__content *,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup * {
                color: rgba(255,255,255,0.92) !important;
                --primary-text-color: rgba(255,255,255,0.92) !important;
                --secondary-text-color: rgba(255,255,255,0.72) !important;
                --paper-item-icon-color: rgba(180,220,255,0.95) !important;
              }

              /* Layering */
              ha-dialog,
              .mdc-dialog,
              .mdc-dialog__container,
              wa-dialog,
              .dialog__panel {
                z-index: 999999 !important;
              }
            content:
              type: vertical-stack
              cards:
                - type: custom:button-card
                  name: DC/AC
                  show_icon: false
                  show_name: true
                  show_state: false
                  tap_action:
                    action: fire-dom-event
                    browser_mod:
                      service: browser_mod.close_popup
                  custom_fields:
                    close: >-
                      [[[ return `<ha-icon icon="mdi:close"
                      style="width:22px;height:22px;"></ha-icon>` ]]]
                  styles:
                    card:
                      - display: none
                      - height: 44px
                      - padding: 0 14px
                      - border-radius: 14px
                      - background: rgba(15,20,24,0.95)
                      - box-shadow: none
                      - margin: 0 0 10px 0
                      - position: relative
                    name:
                      - font-size: 18px
                      - font-weight: "800"
                      - color: white
                      - justify-self: center
                      - align-self: center
                    custom_fields:
                      close:
                        - position: absolute
                        - right: 12px
                        - top: 10px
                        - color: rgba(255,255,255,0.9)
                - type: entities
                  show_header_toggle: false
                  entities:
                    - entity: sensor.anenji_inverter_pv_temp
                      name: PV Temperature
                    - entity: sensor.anenji_inverter_inverter_temp
                      name: Inverter Temperature
                    - entity: sensor.anenji_inverter_transformer_temp
                      name: Transformer Temperature
                    - entity: sensor.anenji_inverter_envir_temp
                      name: Envir Temperature
                    - entity: sensor.anenji_inverter_product_serial_number
                      name: Serial number
                    - entity: sensor.anenji_inverter_rated_active_power
                      name: Power Rate
                    - entity: sensor.anenji_inverter_hwver_m1_2
                      name: Hardware version M1
                    - entity: sensor.anenji_inverter_hwver_m2_2
                      name: Hardware version M2
                    - entity: sensor.anenji_inverter_hwver_s1_2
                      name: Hardware version S1
                    - entity: sensor.anenji_inverter_bus_voltage_positive
                      name: Bus Voltage pasitive
                    - entity: sensor.anenji_inverter_bus_voltage_negative
                      name: Bus Voltage negative
          uix:
            style:
              ha-dialog $: |
                |
                  /* Hide native header (top-left X) */
                  ha-dialog-header,
                  ha-dialog-header *,
                  .mdc-dialog__header,
                  .mdc-dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .mdc-dialog__content { padding: 0 !important; }
                  
                  /* Surface visuals */
                  .mdc-dialog__surface{
                    background: rgba(15,20,24,0.96) !important;
                    box-shadow: none !important;
                  }
              ha-dialog $ wa-dialog $: |
                |
                  /* WebAwesome dialog header (BM 2.8) */
                  header,
                  header *,
                  .dialog__header,
                  .dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .dialog__panel,
                  .dialog__content { padding: 0 !important; }
  link_hit:
    card:
      type: custom:button-card
      show_name: false
      show_icon: false
      show_state: false
      styles:
        card:
          - width: "[[[ return variables.DC_HIT_SIZE + 'px'; ]]]"
          - height: "[[[ return variables.DC_HIT_SIZE + 'px'; ]]]"
          - z-index: 50
          - pointer-events: auto
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: "0"
          - margin: "0"
          - background: >
              [[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" :
              "transparent"; ]]]
          - opacity: |
              [[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]
          - "--mdc-ripple-color": transparent
          - "--mdc-ripple-press-opacity": "0"
      tap_action:
        action: fire-dom-event
        browser_mod:
          service: browser_mod.popup
          data:
            hide_header: false
            title: "Alarm"
            timeout: 0
            dismissable: true
            size: normal
            style: |
              /* OUTER popup surface = WHITE */
              ha-dialog::part(surface),
              .mdc-dialog__surface,
              wa-dialog::part(panel),
              .dialog__panel {
                background: #ffffff !important;
                border-radius: 26px !important;
              }

              /* Nuke native header/close if it still appears (BM 2.8 beta quirk) */
              ha-dialog::part(header),
              ha-dialog::part(close-button),
              .mdc-dialog__header,
              button[dialogAction="close"],
              button[aria-label="Close"] {
                display: none !important;
              }

              /* INNER content area = DARK (this is the big one for your case) */
              ha-dialog .mdc-dialog__content,
              ha-dialog .dialog__content,
              ha-dialog .content,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup > * {
                background: rgba(15,20,24,0.96) !important;
              }

              /* Entities/cards inside = DARK */
              ha-dialog ha-card,
              ha-dialog .card,
              ha-dialog .card-content,
              ha-dialog hui-card {
                background: rgba(15,20,24,0.96) !important;
                border-radius: 18px !important;
              }

              /* White text/icons inside */
              ha-dialog .mdc-dialog__content,
              ha-dialog .mdc-dialog__content *,
              ha-dialog browser-mod-popup,
              ha-dialog browser-mod-popup * {
                color: rgba(255,255,255,0.92) !important;
                --primary-text-color: rgba(255,255,255,0.92) !important;
                --secondary-text-color: rgba(255,255,255,0.72) !important;
                --paper-item-icon-color: rgba(180,220,255,0.95) !important;
              }

              /* Layering */
              ha-dialog,
              .mdc-dialog,
              .mdc-dialog__container,
              wa-dialog,
              .dialog__panel {
                z-index: 999999 !important;
              }
            content:
              type: vertical-stack
              cards:
                - type: custom:button-card
                  name: Alarm
                  show_icon: false
                  show_name: true
                  show_state: false
                  tap_action:
                    action: fire-dom-event
                    browser_mod:
                      service: browser_mod.close_popup
                  custom_fields:
                    close: >-
                      [[[ return `<ha-icon icon="mdi:close"
                      style="width:22px;height:22px;"></ha-icon>` ]]]
                  styles:
                    card:
                      - display: none
                      - height: 44px
                      - padding: 0 14px
                      - border-radius: 14px
                      - background: rgba(15,20,24,0.95)
                      - box-shadow: none
                      - margin: 0 0 10px 0
                      - position: relative
                    name:
                      - font-size: 18px
                      - font-weight: "800"
                      - color: white
                      - justify-self: center
                      - align-self: center
                    custom_fields:
                      close:
                        - position: absolute
                        - right: 12px
                        - top: 10px
                        - color: rgba(255,255,255,0.9)
                - type: entities
                  show_header_toggle: false
                  entities:
                    - entity: sensor.anenji_inverter_fault_alarm
                      name: Fault Alarm
          uix:
            style:
              ha-dialog $: |
                |
                  /* Hide native header (top-left X) */
                  ha-dialog-header,
                  ha-dialog-header *,
                  .mdc-dialog__header,
                  .mdc-dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .mdc-dialog__content { padding: 0 !important; }
                  
                  /* Surface visuals */
                  .mdc-dialog__surface{
                    background: rgba(15,20,24,0.96) !important;
                    box-shadow: none !important;
                  }
              ha-dialog $ wa-dialog $: |
                |
                  /* WebAwesome dialog header (BM 2.8) */
                  header,
                  header *,
                  .dialog__header,
                  .dialog__header * {
                    display: none !important;
                  }
                  
                  /* Remove padding */
                  .dialog__panel,
                  .dialog__content { padding: 0 !important; }}

