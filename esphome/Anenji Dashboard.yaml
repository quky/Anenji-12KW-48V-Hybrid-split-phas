# need Browser Mod 2.8.0-beta.2+ and UIX installed
type: vertical-stack
cards:
- type: custom:button-card
  entity: sensor.anenji_inverter_load_power_total_output
  update_interval: 12
  triggers_update: []
  name: anenji-flow-ui
  show_icon: false
  show_name: false
  show_state: false
  tap_action:
    action: none
  variables:
    DEBUG_HIT: false
    HIT_LEFT: 22
    HIT_RIGHT: 78
    HIT_TOP: 36
    HIT_BOTTOM: 84
    HIT_SIZE: 96
    DC_HIT_X: 50
    DC_HIT_Y: 61
    DC_HIT_SIZE: 110
    link_x: 93
    link_y: 7
    link_size: 56
  styles:
    card:
    - padding: '0'
    - margin: '0'
    - border-radius: 28px
    - overflow: hidden
    - position: relative
    - width: 100%
    - max-width: 420px
    - height: min(420px, 92vw)
    - aspect-ratio: 1 / 1
    - background: none
    - background-color: rgba(7,10,12,0.96)
    - background-image: 'radial-gradient(circle at 50% 40%, rgba(160,220,230,0.35)
        0%, rgba(10,16,18,0.92) 55%, rgba(7,10,12,0.96) 100%)

        '
    - background-repeat: no-repeat
    - background-size: cover
    - --ha-card-background: rgba(0,0,0,0)
    - --card-background-color: rgba(0,0,0,0)
    - box-shadow: 0 10px 24px rgba(0,0,0,0.35)
    custom_fields:
      ui:
      - position: absolute
      - inset: '0'
      - width: 100%
      - max-width: 520px
      - height: 100%
      - z-index: '1'
      - pointer-events: none
      pv_hit:
      - position: absolute
      - left: '[[[ return variables.HIT_LEFT + ''%''; ]]]'
      - top: '[[[ return variables.HIT_TOP + ''%''; ]]]'
      - transform: translate(-50%, -50%)
      - z-index: '50'
      - pointer-events: auto
      grid_hit:
      - position: absolute
      - left: '[[[ return variables.HIT_RIGHT + ''%''; ]]]'
      - top: '[[[ return variables.HIT_TOP + ''%''; ]]]'
      - transform: translate(-50%, -50%)
      - z-index: '50'
      - pointer-events: auto
      bat_hit:
      - position: absolute
      - left: '[[[ return variables.HIT_LEFT + ''%''; ]]]'
      - top: '[[[ return variables.HIT_BOTTOM + ''%''; ]]]'
      - transform: translate(-50%, -50%)
      - z-index: '50'
      - pointer-events: auto
      home_hit:
      - position: absolute
      - left: '[[[ return variables.HIT_RIGHT + ''%''; ]]]'
      - top: '[[[ return variables.HIT_BOTTOM + ''%''; ]]]'
      - transform: translate(-50%, -50%)
      - z-index: '50'
      - pointer-events: auto
      dc_hit:
      - position: absolute
      - left: '[[[ return variables.DC_HIT_X + ''%''; ]]]'
      - top: '[[[ return variables.DC_HIT_Y + ''%''; ]]]'
      - transform: translate(-50%, -50%)
      - z-index: '55'
      - pointer-events: auto
      link_hit:
      - position: absolute
      - left: '[[[ return variables.link_x + ''%''; ]]]'
      - top: '[[[ return variables.link_y + ''%''; ]]]'
      - transform: translate(-50%, -50%)
      - z-index: '60'
      - pointer-events: auto
  custom_fields:
    ui: "[[[\n  const DEBUG_HIT = variables.DEBUG_HIT === true;\n\n  if (!hass ||\
      \ !hass.states) {\n    return `<div style=\"width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.65);font-weight:700;\"\
      >Loading…</div>`;\n        }\n\n  // helpers\n  const st  = (eid) => hass.states[eid]?.state;\n\
      \  const num = (eid) => {\n    const v = parseFloat(st(eid));\n    return Number.isFinite(v)\
      \ ? v : 0;\n        };\n\n  // alarm\n  const derActiveRaw = st('binary_sensor.anenji_inverter_der_alarm_active')\
      \ ?? 'off';\n  const isAlarm =\n    (String(derActiveRaw).toLowerCase() ===\
      \ 'on') ||\n    (String(derActiveRaw).toLowerCase() === 'true') ||\n    (String(derActiveRaw)\
      \ === '1');\n\n  // entities\n  const pvP   = num('sensor.anenji_inverter_pv1_power');\n\
      \  const pvV   = num('sensor.anenji_inverter_pv1_voltage');\n\n  const battP\
      \ = num('sensor.anenji_inverter_battery_power_signed');\n  const battV = num('sensor.anenji_inverter_battery_voltage');\n\
      \  const soc   = num('sensor.anenji_inverter_battery_soc');\n\n  const gridIn\
      \  = num('sensor.anenji_inverter_grid_import_power_filtered');\n  const gridOut\
      \ = num('sensor.anenji_inverter_grid_export_power_filtered');\n\n  const homeP\
      \ = num('sensor.anenji_inverter_load_power_total_output');\n\n  // AC voltage\
      \ (Shelly)\n  const acV = num('sensor.shellyem_c4d8d500468f_channel_1_voltage');\n\
      \n  // signed grid power display (negative export)\n  const gridP = (gridOut\
      \ > gridIn) ? -gridOut : gridIn;\n\n  // thresholds\n  const TH = 25;\n  const\
      \ GRID_TH = 50;\n\n  const showPV   = pvP > TH;\n  const showHome = Math.abs(homeP)\
      \ > TH;\n  const showBat  = Math.abs(battP) > TH;\n  const showGrid = Math.max(gridIn,\
      \ gridOut) > GRID_TH;\n\n  const batDir  = battP >= 0 ? 'charge' : 'discharge';\n\
      \  const gridDir = (gridIn > GRID_TH && gridIn >= gridOut) ? 'import' : ((gridOut > GRID_TH && gridOut > gridIn) ? 'export' : 'idle');\n\
      \n  // formatters\n  const fmtV = (v) => `${(Number.isFinite(v) ? v.toFixed(1)\
      \ : 0)} V`;\n  const fmtW = (w) => `${Math.round(Number.isFinite(w) ? w : 0)}\
      \ W`;\n\n  // colors\n  const C_PV   = '#f5a623';\n  const C_GRID = '#4da3ff';\n\
      \  const C_BAT  = '#ff4ea1';\n  const C_HOME = '#34d3c6';\n\n  const ALARM_C\
      \ = '#ff3b30';\n  const OK_C    = 'rgba(255,255,255,0.70)';\n\n  const linkColor\
      \ = isAlarm ? ALARM_C : OK_C;\n  const dcStroke  = isAlarm ? ALARM_C : '#2aa7c7';\n\
      \n  // soc gradient\n  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));\n\n\
      \  // Total throughput (used to pulse DC/AC ring) — tune divisor if needed\n\
      \  const totalThroughput = Math.abs(pvP) + Math.abs(gridP) + Math.abs(battP)\
      \ + Math.abs(homeP);\n  const tDc = clamp(totalThroughput / 6000, 0, 1);\n \
      \ const dcDur = (2.8 - 1.6 * tDc); // seconds (more throughput = faster pulse)\n\
      \  const dcSwMin = (1.1 + 0.4 * tDc);\n  const dcSwMax = (1.2 + 1.8 * tDc);\n\
      \  const dcOpMin = (0.50 + 0.15 * tDc);\n  const dcOpMax = (0.85 + 0.15 * tDc);\n\
      \n  const hexToRgb = (hex)=>{ const h=hex.replace('#',''); return {r:parseInt(h.slice(0,2),16),g:parseInt(h.slice(2,4),16),b:parseInt(h.slice(4,6),16)};\
      \ };\n  const rgbToHex = ({r,g,b})=>`#${[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('')}`;\n\
      \  const lerp = (a,b,t)=>a+(b-a)*t;\n  const lerpColor=(c1,c2,t)=>{ const A=hexToRgb(c1),B=hexToRgb(c2);\
      \ return rgbToHex({r:Math.round(lerp(A.r,B.r,t)),g:Math.round(lerp(A.g,B.g,t)),b:Math.round(lerp(A.b,B.b,t))});\
      \ };\n\n  const SOC = clamp(soc,0,100);\n  const socColor = (SOC<=50) ? lerpColor('#ff3b30','#ffd60a',SOC/50)\
      \ : lerpColor('#ffd60a','#34c759',(SOC-50)/50);\n\n  // layout (SVG coordinates)\n\
      \  const SHIFT_Y = 6;\n\n  const X_L = 22;\n  const X_R = 78;\n  const Y_T =\
      \ 30;\n  const Y_B = 78;\n  const X_C = 50;\n  const Y_C = 55;\n\n  const R_NODE\
      \ = 10.6;\n  const R_DC   = 14.0;\n\n  // curves\n  const PV_FWD   = \"M 22\
      \ 30 C 34 38, 40 46, 46 52\";\n  const GRID_IN  = \"M 78 30 C 66 38, 60 46,\
      \ 54 52\";\n  const GRID_OUT = \"M 54 52 C 60 46, 66 38, 78 30\";\n  const BAT_DIS\
      \  = \"M 22 78 C 34 70, 40 62, 46 58\";\n  const BAT_CHG  = \"M 46 58 C 40 62,\
      \ 34 70, 22 78\";\n  const HOME_FWD = \"M 54 58 C 60 62, 66 70, 78 78\";\n\n\
      \  const gridPath = (gridDir === 'import') ? GRID_IN : GRID_OUT;\n  const batPath\
      \  = (batDir === 'charge') ? BAT_CHG : BAT_DIS;\n\n  // channels\n  const channel\
      \ = (pathD, color, visible, active) => {\n    if (!visible) return '';\n   \
      \ const base = `rgba(255,255,255,0.06)`;\n    const hi   = active ? color :\
      \ `rgba(255,255,255,0.08)`;\n    const hiOp = active ? 0.22 : 0.09;\n    return\
      \ `\n            <path d=\"${pathD}\" fill=\"none\" stroke=\"${base}\" stroke-width=\"\
      6.0\" stroke-linecap=\"round\" opacity=\"0.20\" vector-effect=\"non-scaling-stroke\"\
      />\n            <path d=\"${pathD}\" fill=\"none\" stroke=\"${hi}\"   stroke-width=\"\
      2.8\" stroke-linecap=\"round\" opacity=\"${hiOp}\" vector-effect=\"non-scaling-stroke\"\
      />\n          `;\n        };\n\n  // DASH-CHEVRON FLOW (mobile-safe)\n  const\
      \ chevronText = (pathId, color, visible, watts=0, baseDur=2.8, dir=\"fwd\")\
      \ => {\n    if (!visible) return '';\n\n    const MAX_W = 3200;\n    const MIN_W\
      \ = 40;\n    // Smooth watts so animation speed doesn't jitter when sensors\
      \ update\n    const wRaw = Math.abs(watts);\n    const now = Date.now();\n \
      \   window.__anenjiFlowSmooth = window.__anenjiFlowSmooth || {};\n    const\
      \ st = window.__anenjiFlowSmooth[pathId] || (window.__anenjiFlowSmooth[pathId]\
      \ = { w: wRaw, ts: now });\n\n    const dt = Math.min(2000, Math.max(0, now\
      \ - st.ts)); // ms\n    const tau = (variables && variables.FLOW_SMOOTH_TAU_MS)\
      \ ? Number(variables.FLOW_SMOOTH_TAU_MS) : 650; // ms\n    const alpha = tau\
      \ > 0 ? (1 - Math.exp(-dt / tau)) : 1;\n\n    const w = st.w + alpha * (wRaw\
      \ - st.w);\n    st.w = w; st.ts = now;\n\n    const t0 = clamp((w - MIN_W) /\
      \ (MAX_W - MIN_W), 0, 1);\n    const curve = (variables && variables.FLOW_SPEED_CURVE)\
      \ ? Number(variables.FLOW_SPEED_CURVE) : 0.72;\n    const t = Math.pow(t0, curve);\n\
      \n    // visuals\n    const fs = (5.2 + 2.6 * t);\n    const op = (0.12 + 0.38\
      \ * t);\n    const ls = (-0.06 - 1.05 * t);\n\n    // slower overall\n    const\
      \ durMax = (variables && variables.FLOW_DUR_MAX) ? Number(variables.FLOW_DUR_MAX)\
      \ : (baseDur * 2.6);\n    const durMin = (variables && variables.FLOW_DUR_MIN)\
      \ ? Number(variables.FLOW_DUR_MIN) : 1.8;\n    const dur = Math.max(durMin,\
      \ durMax - (durMax - durMin) * t);\n\n    const chevs =\n      \"❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯❯\"\
      ;\n\n    const isRev = (dir === \"rev\");\n\n    const a1_from = isRev ? \"\
      10%\"    : \"-110%\";\n    const a1_to   = isRev ? \"110%\"   : \"10%\";\n\n\
      \    const a2_from = isRev ? \"-40%\"   : \"-160%\";\n    const a2_to   = isRev\
      \ ? \"60%\"    : \"-40%\";\n\n    const strokeA = (0.045 + 0.075 * t);\n   \
      \ const strokeW = (0.06 + 0.08 * t);\n    const glowPx = (0.3 + 0.5 * t);\n\
      \    const glowA = (0.04 + 0.08 * t);\n\n    const commonStyle =\n         \
      \   `font-size:${fs.toFixed(1)}px;font-weight:900;letter-spacing:${ls.toFixed(2)}px;`\
      \ +\n            `paint-order:stroke;stroke:rgba(255,255,255,${strokeA.toFixed(3)});`\
      \ +\n            `stroke-width:${strokeW.toFixed(2)};` +\n            `filter:\
      \ drop-shadow(0 0 ${glowPx.toFixed(1)}px rgba(255,255,255,${glowA.toFixed(3)}));`;\n\
      \n    const TL = 120;\n\n    const layer = (from, to, oMul=1.0) => `\n     \
      \       <text fill=\"${color}\" dominant-baseline=\"middle\" style=\"${commonStyle}\"\
      \ opacity=\"${(oMul).toFixed(2)}\">\n              <textPath href=\"#${pathId}\"\
      \ xlink:href=\"#${pathId}\"\n                  startOffset=\"${from}\"\n   \
      \               textLength=\"${TL}\"\n                  lengthAdjust=\"spacingAndGlyphs\"\
      >\n                ${chevs}\n                <animate attributeName=\"startOffset\"\
      \n                   dur=\"${dur.toFixed(2)}s\"\n                   repeatCount=\"\
      indefinite\"\n                   values=\"${from};${to}\"\n                \
      \   calcMode=\"linear\"/>\n              </textPath>\n            </text>\n\
      \          `;\n\n    return `\n            <g opacity=\"${op.toFixed(3)}\">\n\
      \              ${layer(a1_from, a1_to, 1.00)}\n              ${layer(a2_from,\
      \ a2_to, 0.70)}\n            </g>\n          `;\n        };\n\n  const glowFilterId\
      \ = \"glow\";\n  const powerStyle = (active, color, filterId=null) => `\n  \
      \  fill:${active ? color : \"rgba(255,255,255,0.92)\"};\n    font-weight:900;\n\
      \          ${active && filterId ? `filter:url(#${filterId});` : ``}\n      \
      \  `;\n\n  const ICON_SCALE = 0.85;\n  const SOC_IN_STYLE = `fill:${socColor};font-size:5.2px;font-weight:1000;`;\n\
      \n  // icons\n  const iconPV = (cx, cy, active) => `\n          <g transform=\"\
      translate(${cx} ${cy}) scale(${ICON_SCALE})\"\n       opacity=\"0.95\"\n   \
      \    style=\"${active ? 'animation:pulseSoft 3.6s ease-in-out infinite;' : ''}\"\
      >\n            <rect x=\"-8.5\" y=\"-6\" width=\"17\" height=\"12\" rx=\"2.2\"\
      \n            fill=\"rgba(255,255,255,0.08)\" stroke=\"rgba(255,255,255,0.40)\"\
      \ stroke-width=\"0.9\"/>\n            <line x1=\"-8.5\" y1=\"-2\" x2=\"8.5\"\
      \ y2=\"-2\" stroke=\"rgba(255,255,255,0.38)\" stroke-width=\"0.8\"/>\n     \
      \       <line x1=\"-8.5\" y1=\"2\"  x2=\"8.5\" y2=\"2\"  stroke=\"rgba(255,255,255,0.38)\"\
      \ stroke-width=\"0.8\"/>\n            <line x1=\"-2.8\" y1=\"-6\" x2=\"-2.8\"\
      \ y2=\"6\" stroke=\"rgba(255,255,255,0.38)\" stroke-width=\"0.8\"/>\n      \
      \      <line x1=\"2.8\"  y1=\"-6\" x2=\"2.8\"  y2=\"6\" stroke=\"rgba(255,255,255,0.38)\"\
      \ stroke-width=\"0.8\"/>\n          </g>\n        `;\n\n  const iconGrid = (cx,\
      \ cy) => `\n          <g transform=\"translate(${cx} ${cy}) scale(${ICON_SCALE})\"\
      \ opacity=\"0.95\">\n            <polygon points=\"0,-8 4,-1 2,-1 6,8 0,2 -6,8\
      \ -2,-1 -4,-1\" fill=\"rgba(255,255,255,0.42)\"/>\n            <line x1=\"-8\"\
      \ y1=\"8.2\" x2=\"8\" y2=\"8.2\" stroke=\"rgba(255,255,255,0.40)\" stroke-width=\"\
      1\"/>\n          </g>\n        `;\n\n  const iconBattery = (cx, cy) => {\n \
      \   const yTop=-7.0, yBot=7.3, h=(yBot-yTop);\n    const fillH = h*(SOC/100);\n\
      \    const fillY = yBot - fillH;\n    return `\n            <g transform=\"\
      translate(${cx} ${cy}) scale(${ICON_SCALE})\" opacity=\"0.95\">\n          \
      \    <rect x=\"-7.2\" y=\"-9\" width=\"14.4\" height=\"18\" rx=\"2.4\"\n   \
      \           fill=\"rgba(255,255,255,0.08)\" stroke=\"rgba(255,255,255,0.42)\"\
      \ stroke-width=\"0.9\"/>\n              <rect x=\"-2.8\" y=\"-11\" width=\"\
      5.6\" height=\"2.6\" rx=\"1.0\" fill=\"rgba(255,255,255,0.42)\"/>\n        \
      \      <clipPath id=\"batClip\"><rect x=\"-5.9\" y=\"${yTop}\" width=\"11.8\"\
      \ height=\"${h}\" rx=\"1.8\"/></clipPath>\n              <g clip-path=\"url(#batClip)\"\
      >\n                <rect x=\"-5.9\" y=\"${fillY}\" width=\"11.8\" height=\"\
      ${fillH}\" rx=\"1.8\"\n                fill=\"${socColor}\" opacity=\"0.55\"\
      \n                style=\"${showBat ? 'animation:pulseFill 3.2s ease-in-out\
      \ infinite;' : ''}\"></rect>\n              </g>\n              <text x=\"0\"\
      \ y=\"2.0\" text-anchor=\"middle\" style=\"${SOC_IN_STYLE}\">${Math.round(SOC)}%</text>\n\
      \            </g>\n          `;\n        };\n\n  const iconHome = (cx, cy) =>\
      \ `\n          <g transform=\"translate(${cx} ${cy}) scale(${ICON_SCALE})\"\
      \ opacity=\"0.95\">\n            <polygon points=\"-7,1 0,-8 7,1\" fill=\"rgba(255,255,255,0.22)\"\
      \ stroke=\"rgba(255,255,255,0.42)\" stroke-width=\"0.9\"/>\n            <rect\
      \ x=\"-6.5\" y=\"1\" width=\"13\" height=\"7.5\" fill=\"rgba(255,255,255,0.18)\"\
      \ stroke=\"rgba(255,255,255,0.42)\" stroke-width=\"0.9\"/>\n            <rect\
      \ x=\"-2.0\" y=\"3.5\" width=\"4.0\" height=\"5.0\" fill=\"rgba(255,255,255,0.35)\"\
      />\n          </g>\n        `;\n\n  // text blocks\n  const TOP_DROP = -2;\n\
      \  const BOT_LIFT = 2;\n  const topAnchor = (yCircle, dy=0) => (yCircle - R_NODE\
      \ - 13 + dy);\n\n  const X_PV_TX   = X_L - 5;\n  const X_GRID_TX = X_R + 5;\n\
      \  const X_BAT_TX  = X_L - 5;\n  const X_HOME_TX = X_R + 5;\n\n  const block2\
      \ = (x, yCircle, vStr, pStr, active, color, dy=0, filterId=null) => {\n    const\
      \ y0 = topAnchor(yCircle, dy);\n    return `\n            <text x=\"${x}\" y=\"\
      ${y0+6}\"  text-anchor=\"middle\" style=\"fill:rgba(255,255,255,0.66);font-size:4.8px;font-weight:900;\"\
      >${vStr}</text>\n            <text x=\"${x}\" y=\"${y0+12}\" text-anchor=\"\
      middle\" style=\"${powerStyle(active, color, filterId)}font-size:5.0px;font-weight:900;\"\
      >${pStr}</text>\n          `;\n        };\n\n  const blockBattery = (x, yCircle)\
      \ => {\n    const y0 = topAnchor(yCircle, -BOT_LIFT);\n    return `\n      \
      \      <text x=\"${x}\" y=\"${y0+6}\"  text-anchor=\"middle\" style=\"fill:rgba(255,255,255,0.66);font-size:4.8px;font-weight:900;\"\
      >${fmtV(battV)}</text>\n            <text x=\"${x}\" y=\"${y0+12}\" text-anchor=\"\
      middle\" style=\"${powerStyle(showBat, C_BAT, glowFilterId)}font-size:5.0px;font-weight:900;\"\
      >${fmtW(battP)}</text>\n          `;\n        };\n\n  // top-right link icon\n\
      \  const SAFE_MARGIN_X = 10;\n  const SAFE_MARGIN_Y = 5.5;\n  const LINK_X =\
      \ 100 - SAFE_MARGIN_X;\n  const LINK_Y = SAFE_MARGIN_Y;\n\n  const linkIcon\
      \ = () => `\n          <g transform=\"translate(${LINK_X} ${LINK_Y})\" opacity=\"\
      0.95\" style=\"${isAlarm ? 'animation:pulseAlarm 1.2s ease-in-out infinite;'\
      \ : ''}\">\n            <circle cx=\"0\" cy=\"0\" r=\"3.1\" fill=\"rgba(0,0,0,0.25)\"\
      \ stroke=\"${linkColor}\" stroke-width=\"0.8\"/>\n            <path d=\"M -1.5\
      \ 0.2 c 0.0 -0.9 0.6 -1.5 1.5 -1.5 h 0.7 c 0.9 0 1.5 0.6 1.5 1.5 c 0.0 0.9 -0.6\
      \ 1.5 -1.5 1.5 h -0.2\"\n            fill=\"none\" stroke=\"${linkColor}\" stroke-width=\"\
      0.7\" stroke-linecap=\"round\"/>\n            <path d=\"M 1.5 -0.2 c 0.0 0.9\
      \ -0.6 1.5 -1.5 1.5 h -0.7 c -0.9 0 -1.5 -0.6 -1.5 -1.5 c 0.0 -0.9 0.6 -1.5\
      \ 1.5 -1.5 h 0.2\"\n            fill=\"none\" stroke=\"${linkColor}\" stroke-width=\"\
      0.7\" stroke-linecap=\"round\"/>\n          </g>\n        `;\n\n  const debugDots\
      \ = DEBUG_HIT ? `\n          <circle cx=\"22\" cy=\"${30+SHIFT_Y}\" r=\"7\"\
      \ fill=\"rgba(255,0,0,0.65)\"/>\n          <circle cx=\"78\" cy=\"${30+SHIFT_Y}\"\
      \ r=\"7\" fill=\"rgba(255,0,0,0.65)\"/>\n          <circle cx=\"22\" cy=\"${78+SHIFT_Y}\"\
      \ r=\"7\" fill=\"rgba(255,0,0,0.65)\"/>\n          <circle cx=\"78\" cy=\"${78+SHIFT_Y}\"\
      \ r=\"7\" fill=\"rgba(255,0,0,0.65)\"/>\n          <circle cx=\"${X_C}\" cy=\"\
      ${Y_C+SHIFT_Y}\" r=\"9\" fill=\"rgba(255,0,0,0.65)\"/>\n        ` : '';\n\n\
      \  const gridFlowDir = (gridDir === \"import\") ? \"rev\" : \"fwd\";\n  const\
      \ batFlowDir  = (batDir  === \"charge\") ? \"rev\" : \"fwd\";\n\n  return `\n\
      \          <div style=\"width:100%;height:100%;\">\n            <svg xmlns=\"\
      http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"\n\
      \           viewBox=\"0 0 100 100\"\n           preserveAspectRatio=\"xMidYMid\
      \ meet\"\n           style=\"width:100%;height:100%;display:block;shape-rendering:geometricPrecision;text-rendering:geometricPrecision;\"\
      >\n              <defs>\n                <filter id=\"${glowFilterId}\" x=\"\
      -60%\" y=\"-60%\" width=\"220%\" height=\"220%\">\n                  <feGaussianBlur\
      \ stdDeviation=\"1.2\" result=\"blur\"/>\n                  <feMerge><feMergeNode\
      \ in=\"blur\"/><feMergeNode in=\"SourceGraphic\"/></feMerge>\n             \
      \   </filter>\n\n                <filter id=\"arrowGlow\" x=\"-80%\" y=\"-80%\"\
      \ width=\"260%\" height=\"260%\">\n                  <feGaussianBlur stdDeviation=\"\
      0.9\" result=\"blur\"/>\n                  <feMerge><feMergeNode in=\"blur\"\
      /><feMergeNode in=\"SourceGraphic\"/></feMerge>\n                </filter>\n\
      \n                <!-- Motion paths (referenced by chevrons) -->\n         \
      \       <path id=\"pvPath\"   d=\"${PV_FWD}\"   fill=\"none\"/>\n          \
      \      <path id=\"gridPath\" d=\"${gridPath}\" fill=\"none\"/>\n           \
      \     <path id=\"batPath\"  d=\"${batPath}\"  fill=\"none\"/>\n            \
      \    <path id=\"homePath\" d=\"${HOME_FWD}\" fill=\"none\"/>\n\n           \
      \     <style>\n                  @keyframes pulseSoft { 0%,100% { opacity: .60;\
      \ } 50% { opacity: .95; } }\n                  @keyframes pulseFill { 0%,100%\
      \ { opacity: .45; } 50% { opacity: .80; } }\n                  @keyframes pulseAlarm\
      \ { 0%,100% { opacity: .40; } 50% { opacity: 1.0; } }\n                /* ---\
      \ FINAL spacing override (tight label + value + unit) --- */\n             \
      \   .row{\n            display: flex !important;\n            align-items: center\
      \ !important;\n            justify-content: flex-start !important;\n       \
      \     gap: 14px !important;\n            width: fit-content !important;\n  \
      \          max-width: var(--popup-width) !important;\n                }\n  \
      \              .name{ flex: 0 0 auto !important; }\n                .val{  flex:\
      \ 0 0 auto !important; margin: 0 !important; }\n                .unit{ flex:\
      \ 0 0 auto !important; margin: 0 !important; opacity: 0.75 !important; }\n \
      \               /* --- Prevent parent stretch (key for tight pills) --- */\n\
      \                .grid{\n            align-items: flex-start !important;\n \
      \               }\n                .row{\n            align-self: flex-start\
      \ !important;\n                }\n                /* --- Align values (fixed\
      \ label width) --- */\n          :root{\n            --label-width: 170px;\n\
      \                }\n                @media (max-width: 600px){\n           \
      \ :root{\n              --label-width: 140px;\n                  }\n       \
      \         }\n                .row > :nth-child(1){\n            flex: 0 0 var(--label-width)\
      \ !important;\n            width: var(--label-width) !important;\n         \
      \   white-space: nowrap !important;\n            overflow: hidden !important;\n\
      \            text-overflow: ellipsis !important;\n                }\n      \
      \          .row > :nth-child(2){\n            min-width: 64px !important;\n\
      \            text-align: right !important;\n                }\n            \
      \    /***** INDUSTRIAL THEME *****/\n          :root{\n            --panel-bg:\
      \ rgba(20,22,24,0.92);\n            --pill-bg: rgba(255,255,255,0.04);\n   \
      \         --pill-border: rgba(255,255,255,0.10);\n            --text-dim: rgba(255,255,255,0.72);\n\
      \            --text-dimmer: rgba(255,255,255,0.55);\n            --shadow-soft:\
      \ 0 10px 30px rgba(0,0,0,0.35);\n            --shadow-inset: inset 0 1px 0 rgba(255,255,255,0.05),\
      \ inset 0 -1px 0 rgba(0,0,0,0.25);\n                }\n          \n        \
      \        .wrap{ width:100% !important; max-width:100% !important; }\n      \
      \          .grid{\n            width: 100% !important;\n            max-width:\
      \ var(--popup-width) !important;\n            background: var(--panel-bg) !important;\n\
      \            border: 1px solid rgba(255,255,255,0.06) !important;\n        \
      \    border-radius: 16px !important;\n            padding: 14px 14px 12px !important;\n\
      \            box-shadow: var(--shadow-soft) !important;\n                }\n\
      \          \n                .row{\n            width: 100% !important;\n  \
      \          display: flex !important;\n            align-items: center !important;\n\
      \            gap: 10px !important;\n            padding: 12px 14px !important;\n\
      \            border-radius: 16px !important;\n            background: var(--pill-bg)\
      \ !important;\n            border: 1px solid var(--pill-border) !important;\n\
      \            box-shadow: var(--shadow-inset) !important;\n                }\n\
      \          \n                .row > :nth-child(1){\n            flex: 0 0 var(--label-width)\
      \ !important;\n            width: var(--label-width) !important;\n         \
      \   color: var(--text-dim) !important;\n            font-weight: 700 !important;\n\
      \            letter-spacing: 0.2px !important;\n            text-transform:\
      \ uppercase !important;\n            font-size: 13px !important;\n         \
      \       }\n                .row > :nth-child(2){\n            font-variant-numeric:\
      \ tabular-nums !important;\n            font-weight: 800 !important;\n     \
      \       font-size: 22px !important;\n            line-height: 1 !important;\n\
      \                }\n                .row > :nth-child(3){\n            color:\
      \ var(--text-dimmer) !important;\n            font-weight: 700 !important;\n\
      \            font-size: 13px !important;\n            margin-left: 4px !important;\n\
      \            letter-spacing: 0.4px !important;\n            text-transform:\
      \ uppercase !important;\n                }\n          \n                .row\
      \ + .row{\n            margin-top: 10px !important;\n                }\n   \
      \       \n                @media (max-width: 600px){\n                  .grid{\
      \ padding: 12px !important; border-radius: 14px !important; }\n            \
      \      .row{ padding: 11px 12px !important; border-radius: 14px !important;\
      \ }\n                  .row > :nth-child(2){ font-size: 20px !important; }\n\
      \                }\n                /***** TESLA-STYLE UI (soft glow, glass\
      \ pills, tight rhythm) *****/\n          :root{\n            --panel-bg: rgba(12,14,16,0.82);\n\
      \            --panel-border: rgba(255,255,255,0.06);\n            --pill-bg:\
      \ rgba(255,255,255,0.055);\n            --pill-bg-2: rgba(255,255,255,0.035);\n\
      \            --pill-border: rgba(255,255,255,0.08);\n            --text: rgba(255,255,255,0.92);\n\
      \            --text-dim: rgba(255,255,255,0.72);\n            --text-dimmer:\
      \ rgba(255,255,255,0.55);\n            --shadow: 0 18px 50px rgba(0,0,0,0.45);\n\
      \            --inset: inset 0 1px 0 rgba(255,255,255,0.07), inset 0 -1px 0 rgba(0,0,0,0.35);\n\
      \            --glow: 0 0 18px rgba(80,180,255,0.14);\n            --radius:\
      \ 18px;\n                }\n          \n                /* Panel */\n      \
      \          .wrap{ width:100% !important; max-width:100% !important; }\n    \
      \            .grid{\n            width: 100% !important;\n            max-width:\
      \ var(--popup-width) !important;\n            background: radial-gradient(120%\
      \ 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00) 42%),\n \
      \                       linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02)\
      \ 100%),\n                        var(--panel-bg) !important;\n            border:\
      \ 1px solid var(--panel-border) !important;\n            border-radius: calc(var(--radius)\
      \ + 2px) !important;\n            padding: 12px 12px 10px !important;\n    \
      \        box-shadow: var(--shadow), var(--glow) !important;\n            backdrop-filter:\
      \ blur(10px);\n                }\n          \n                /* Rows (glass\
      \ pills) */\n                .row{\n            width: 100% !important;\n  \
      \          display: flex !important;\n            align-items: center !important;\n\
      \            gap: 10px !important;\n            padding: 10px 12px !important;\n\
      \            border-radius: var(--radius) !important;\n            background:\
      \ linear-gradient(180deg, var(--pill-bg) 0%, var(--pill-bg-2) 100%) !important;\n\
      \            border: 1px solid var(--pill-border) !important;\n            box-shadow:\
      \ var(--inset) !important;\n                }\n          \n                /*\
      \ Tight rhythm */\n                .row + .row{ margin-top: 8px !important;\
      \ }\n          \n                /* Label / value / unit */\n              \
      \  .row > :nth-child(1){\n            flex: 0 0 var(--label-width) !important;\n\
      \            width: var(--label-width) !important;\n            color: var(--text-dim)\
      \ !important;\n            font-weight: 650 !important;\n            letter-spacing:\
      \ 0.18px !important;\n            font-size: 13px !important;\n            text-transform:\
      \ none !important;\n                }\n                .row > :nth-child(2){\n\
      \            color: var(--text) !important;\n            font-variant-numeric:\
      \ tabular-nums !important;\n            font-weight: 800 !important;\n     \
      \       font-size: 22px !important;\n            line-height: 1 !important;\n\
      \            text-align: right !important;\n            min-width: 68px !important;\n\
      \                }\n                .row > :nth-child(3){\n            color:\
      \ var(--text-dimmer) !important;\n            font-weight: 700 !important;\n\
      \            font-size: 12px !important;\n            letter-spacing: 0.3px\
      \ !important;\n            text-transform: uppercase !important;\n         \
      \       }\n          \n                /* Subtle hover (desktop) */\n      \
      \          @media (hover:hover){\n                  .row:hover{\n          \
      \    border-color: rgba(255,255,255,0.14) !important;\n              box-shadow:\
      \ var(--inset), 0 0 18px rgba(255,255,255,0.06) !important;\n              \
      \    }\n                }\n          \n                /* Mobile tuning */\n\
      \                @media (max-width: 600px){\n                  .grid{ padding:\
      \ 10px !important; border-radius: 18px !important; }\n                  .row{\
      \ padding: 10px 11px !important; border-radius: 16px !important; }\n       \
      \           .row > :nth-child(2){ font-size: 20px !important; min-width: 62px\
      \ !important; }\n                  .row > :nth-child(1){ font-size: 12.5px !important;\
      \ }\n                }\n                /***** TESLA POPUP REFINEMENT (based\
      \ on your HTML structure) *****/\n          \n                /* 1) Remove inner\
      \ dark title (e.g., PV/Battery) */\n                .wrap > .title{\n      \
      \      display: none !important;\n                }\n          \n          \
      \      /* 2) Make panel/rows use full available width (kills right-side empty\
      \ gap) */\n                .wrap{\n            width: min(var(--popup-width),\
      \ 95vw) !important;\n            max-width: min(var(--popup-width), 95vw) !important;\n\
      \                }\n                .grid{\n            width: 100% !important;\n\
      \            max-width: 100% !important;\n            display: flex !important;\n\
      \            flex-direction: column !important;\n            align-items: stretch\
      \ !important;   /* critical: prevents centered/narrow rows */\n            \
      \    }\n          \n                /* 3) Row layout: label left, value+unit\
      \ tight right */\n                .row{\n            width: 100% !important;\n\
      \            display: grid !important;\n            grid-template-columns: 1fr\
      \ auto auto !important;\n            column-gap: 10px !important;\n        \
      \    align-items: center !important;\n                }\n          \n      \
      \          /* 4) Typography: make labels bigger & consistent with values */\n\
      \                .name{\n            font-size: 18px !important;\n         \
      \   font-weight: 650 !important;\n            color: rgba(255,255,255,0.82)\
      \ !important;\n            letter-spacing: 0.12px !important;\n            \
      \    }\n                .val{\n            font-size: 30px !important;\n   \
      \         font-weight: 800 !important;\n            line-height: 1 !important;\n\
      \            text-align: right !important;\n            font-variant-numeric:\
      \ tabular-nums !important;\n                }\n                .unit{\n    \
      \        font-size: 16px !important;\n            font-weight: 700 !important;\n\
      \            opacity: 0.65 !important;\n            letter-spacing: 0.3px !important;\n\
      \            text-transform: uppercase !important;\n                }\n    \
      \      \n                /* Mobile tuning */\n                @media (max-width:\
      \ 600px){\n                  .name{ font-size: 17px !important; }\n        \
      \          .val{ font-size: 28px !important; }\n                  .unit{ font-size:\
      \ 15px !important; }\n                }\n                /***** TESLA PILLS\
      \ + FULL-WIDTH PANEL (ALL POPUPS) *****/\n                .wrap{ width:100%\
      \ !important; box-sizing:border-box !important; padding:14px !important;\n \
      \           background: radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10)\
      \ 0%, rgba(255,255,255,0.00) 42%),\n                        linear-gradient(180deg,\
      \ rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%),\n               \
      \         rgba(12,14,16,0.86) !important;\n            border:1px solid rgba(255,255,255,0.06)\
      \ !important;\n            border-radius:20px !important;\n            box-shadow:\
      \ 0 18px 50px rgba(0,0,0,0.45), 0 0 18px rgba(80,180,255,0.14) !important;\n\
      \            backdrop-filter: blur(10px);\n                }\n             \
      \   .wrap > .title{ display:none !important; }\n                .grid{ width:100%\
      \ !important; max-width:100% !important; display:flex !important; flex-direction:column\
      \ !important;\n            gap:10px !important; padding:0 !important; background:transparent\
      \ !important; border:none !important; box-shadow:none !important;\n        \
      \        }\n                .row{ width:100% !important; display:grid !important;\
      \ grid-template-columns: 1fr auto auto !important; column-gap:10px !important;\n\
      \            align-items:center !important; padding:12px 14px !important; border-radius:18px\
      \ !important;\n            background: linear-gradient(180deg, rgba(255,255,255,0.06)\
      \ 0%, rgba(255,255,255,0.035) 100%) !important;\n            border:1px solid\
      \ rgba(255,255,255,0.10) !important;\n            box-shadow: inset 0 1px 0\
      \ rgba(255,255,255,0.08), inset 0 -1px 0 rgba(0,0,0,0.38) !important;\n    \
      \            }\n                .name{ font-size:18px !important; font-weight:650\
      \ !important; color:rgba(255,255,255,0.84) !important; }\n                .val{\
      \ font-size:30px !important; font-weight:800 !important; line-height:1 !important;\
      \ font-variant-numeric: tabular-nums !important; text-align:right !important;\
      \ }\n                .unit{ font-size:16px !important; font-weight:700 !important;\
      \ opacity:0.65 !important; letter-spacing:0.3px !important; text-transform:uppercase\
      \ !important; }\n                @media (max-width:600px){\n               \
      \   .wrap{ padding:12px !important; border-radius:18px !important; }\n     \
      \             .row{ padding:11px 12px !important; border-radius:16px !important;\
      \ }\n                  .name{ font-size:17px !important; }\n               \
      \   .val{ font-size:28px !important; }\n                  .unit{ font-size:15px\
      \ !important; }\n                }\n                /***** FIX: make panel +\
      \ pills stretch full width (no left-column cutout) *****/\n                .wrap{\n\
      \            display:block !important;\n            width:100% !important;\n\
      \            max-width:none !important;\n            min-width:0 !important;\n\
      \            flex: 1 1 auto !important;\n                }\n               \
      \ .grid{\n            display:flex !important;\n            flex-direction:column\
      \ !important;\n            align-items:stretch !important;\n            justify-content:flex-start\
      \ !important;\n            width:100% !important;\n            max-width:none\
      \ !important;\n            min-width:0 !important;\n                }\n    \
      \            .row{\n            width:100% !important;\n            max-width:none\
      \ !important;\n            min-width:0 !important;\n                }\n    \
      \      \n                /* --- vNEXT: center panel + prevent right-cut (global)\
      \ --- */\n                .wrap{\n            width: 100% !important;\n    \
      \        display: flex !important;\n            justify-content: center !important;\n\
      \                }\n                .grid{\n            width: 100% !important;\n\
      \            max-width: min(560px, 100%) !important;\n                }\n  \
      \              .row{\n            width: 100% !important;\n            max-width:\
      \ 100% !important;\n            box-sizing: border-box !important;\n       \
      \     display: grid !important;\n            grid-template-columns: 1fr auto\
      \ auto !important;\n            column-gap: 14px !important;\n            align-items:\
      \ center !important;\n            justify-content: initial !important;\n   \
      \         gap: 0 !important;\n            overflow: visible !important;\n  \
      \              }\n                .name{\n            white-space: nowrap !important;\n\
      \            overflow: hidden !important;\n            text-overflow: ellipsis\
      \ !important;\n            min-width: 0 !important;\n                }\n   \
      \             .val, .unit{\n            white-space: nowrap !important;\n  \
      \              }\n                .unit{ padding-right: 6px !important; }\n\n\
      \                /* Center the inner panel within the popup */\n\n         \
      \       .wrap{\n\n                  max-width: 520px !important;\n\n       \
      \           margin: 0 auto !important;\n\n                }\n\n            \
      \    /* ===== Typography + layout (global override) ===== */\n             \
      \   .wrap {\n                  width: min(900px, 100%) !important;\n       \
      \           margin: 0 auto !important;\n                }\n                .grid\
      \ {\n                  width: 100% !important;\n                }\n        \
      \        .row {\n                  display: grid !important;\n             \
      \     grid-template-columns: 1fr auto auto !important;\n                  align-items:\
      \ center !important;\n                  column-gap: 12px !important;\n     \
      \             padding: 14px 18px !important;\n                  border-radius:\
      \ 999px !important;\n                }\n                .name {\n          \
      \        font-size: clamp(14px, 2.1vw, 18px) !important;\n                 \
      \ font-weight: 750 !important;\n                  letter-spacing: 0.08em !important;\n\
      \                  text-transform: uppercase !important;\n                 \
      \ opacity: 0.92 !important;\n                }\n                .val {\n   \
      \               font-size: clamp(28px, 4.2vw, 46px) !important;\n          \
      \        font-weight: 850 !important;\n                  letter-spacing: -0.02em\
      \ !important;\n                  font-variant-numeric: tabular-nums !important;\n\
      \                  line-height: 1 !important;\n                  color: #f5a623\
      \ !important;\n                }\n                .unit {\n                \
      \  font-size: clamp(13px, 1.9vw, 18px) !important;\n                  font-weight:\
      \ 750 !important;\n                  letter-spacing: 0.06em !important;\n  \
      \                text-transform: uppercase !important;\n                  opacity:\
      \ 0.55 !important;\n                }\n                </style>\n          \
      \    </defs>\n\n              ${linkIcon()}\n              ${debugDots}\n\n\
      \              <g transform=\"translate(0 ${SHIFT_Y})\">\n                ${channel(PV_FWD,\
      \   C_PV,   true,     showPV)}\n                ${channel(gridPath, C_GRID,\
      \ showGrid, showGrid)}\n                ${channel(batPath,  C_BAT,  true,  \
      \   showBat)}\n                ${channel(HOME_FWD, C_HOME, true,     showHome)}\n\
      \n                ${chevronText(\"pvPath\",   C_PV,   showPV,  pvP,  3.6, \"\
      fwd\")}\n                ${chevronText(\"gridPath\", C_GRID, showGrid, gridP,\
      \ 2.8, gridFlowDir)}\n                ${chevronText(\"batPath\",  C_BAT,  showBat,\
      \  battP, 2.2, batFlowDir)}\n                ${chevronText(\"homePath\", C_HOME,\
      \ showHome, homeP, 2.4, \"fwd\")}\n\n                <circle cx=\"${X_C}\" cy=\"\
      ${Y_C}\" r=\"${R_DC}\" fill=\"#0d3c50\" stroke=\"${dcStroke}\"\n           \
      \       stroke-width=\"${dcSwMin.toFixed(2)}\" stroke-opacity=\"${dcOpMin.toFixed(2)}\"\
      \n                  filter=\"url(#arrowGlow)\">\n                  <animate\
      \ attributeName=\"stroke-width\"\n                     values=\"${dcSwMin.toFixed(2)};${dcSwMax.toFixed(2)};${dcSwMin.toFixed(2)}\"\
      \n                     dur=\"${dcDur.toFixed(2)}s\"\n                     repeatCount=\"\
      indefinite\"/>\n                  <animate attributeName=\"stroke-opacity\"\n\
      \                     values=\"${dcOpMin.toFixed(2)};${dcOpMax.toFixed(2)};${dcOpMin.toFixed(2)}\"\
      \n                     dur=\"${dcDur.toFixed(2)}s\"\n                     repeatCount=\"\
      indefinite\"/>\n                </circle>\n                <text x=\"${X_C}\"\
      \ y=\"${Y_C-1}\" text-anchor=\"middle\" fill=\"white\" font-size=\"6.2\" font-weight=\"\
      800\">DC/AC</text>\n                <text x=\"${X_C}\" y=\"${Y_C+6}\" text-anchor=\"\
      middle\" fill=\"rgba(255,255,255,0.6)\" font-size=\"5\" font-weight=\"700\"\
      >~ ~</text>\n\n                <circle cx=\"${X_L}\" cy=\"${Y_T}\" r=\"${R_NODE}\"\
      \ fill=\"#0d0f14\" stroke=\"${C_PV}\" stroke-width=\"2\"/>\n               \
      \ ${iconPV(X_L, Y_T, showPV)}\n                ${block2(X_PV_TX, Y_T, fmtV(pvV),\
      \ fmtW(pvP), showPV, C_PV, TOP_DROP, glowFilterId)}\n\n                <circle\
      \ cx=\"${X_R}\" cy=\"${Y_T}\" r=\"${R_NODE}\" fill=\"#0d0f14\" stroke=\"${C_GRID}\"\
      \ stroke-width=\"2\"/>\n                ${iconGrid(X_R, Y_T)}\n            \
      \    ${block2(X_GRID_TX, Y_T, fmtV(acV), fmtW(Math.abs(gridP)), showGrid, C_GRID,\
      \ TOP_DROP, glowFilterId)}\n\n                <circle cx=\"${X_L}\" cy=\"${Y_B}\"\
      \ r=\"${R_NODE}\" fill=\"#0d0f14\" stroke=\"${C_BAT}\" stroke-width=\"2\"/>\n\
      \                ${iconBattery(X_L, Y_B)}\n                ${blockBattery(X_BAT_TX,\
      \ Y_B)}\n\n                <circle cx=\"${X_R}\" cy=\"${Y_B}\" r=\"${R_NODE}\"\
      \ fill=\"#0d0f14\" stroke=\"${C_HOME}\" stroke-width=\"2\"/>\n             \
      \   ${iconHome(X_R, Y_B)}\n                ${block2(X_HOME_TX, Y_B, fmtV(acV),\
      \ fmtW(homeP), showHome, C_HOME, -BOT_LIFT, glowFilterId)}\n              </g>\n\
      \            </svg>\n          </div>\n        `;\n      ]]]\n"
    pv_hit:
      card:
        type: custom:button-card
        show_name: false
        show_icon: false
        show_state: false
        styles:
          card:
          - width: '[[[ return variables.HIT_SIZE + ''px''; ]]]'
          - height: '[[[ return variables.HIT_SIZE + ''px''; ]]]'
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: '0'
          - margin: '0'
          - background: '[[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" : "transparent";
              ]]]

              '
          - opacity: '[[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]

              '
          - --mdc-ripple-color: transparent
          - --mdc-ripple-press-opacity: '0'
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              popup_card_id: pv_popup
    bat_hit:
      card:
        type: custom:button-card
        show_name: false
        show_icon: false
        show_state: false
        styles:
          card:
          - width: '[[[ return variables.HIT_SIZE + ''px''; ]]]'
          - height: '[[[ return variables.HIT_SIZE + ''px''; ]]]'
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: '0'
          - margin: '0'
          - background: '[[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" : "transparent";
              ]]]

              '
          - opacity: '[[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]

              '
          - --mdc-ripple-color: transparent
          - --mdc-ripple-press-opacity: '0'
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              popup_card_id: battery_popup
    grid_hit:
      card:
        type: custom:button-card
        show_name: false
        show_icon: false
        show_state: false
        styles:
          card:
          - width: '[[[ return variables.HIT_SIZE + ''px''; ]]]'
          - height: '[[[ return variables.HIT_SIZE + ''px''; ]]]'
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: '0'
          - margin: '0'
          - background: '[[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" : "transparent";
              ]]]

              '
          - opacity: '[[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]

              '
          - --mdc-ripple-color: transparent
          - --mdc-ripple-press-opacity: '0'
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              popup_card_id: grid_popup
    home_hit:
      card:
        type: custom:button-card
        show_name: false
        show_icon: false
        show_state: false
        styles:
          card:
          - width: '[[[ return variables.HIT_SIZE + ''px''; ]]]'
          - height: '[[[ return variables.HIT_SIZE + ''px''; ]]]'
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: '0'
          - margin: '0'
          - background: '[[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" : "transparent";
              ]]]

              '
          - opacity: '[[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]

              '
          - --mdc-ripple-color: transparent
          - --mdc-ripple-press-opacity: '0'
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              popup_card_id: home_popup
    dc_hit:
      card:
        type: custom:button-card
        show_name: false
        show_icon: false
        show_state: false
        styles:
          card:
          - width: '[[[ return variables.DC_HIT_SIZE + ''px''; ]]]'
          - height: '[[[ return variables.DC_HIT_SIZE + ''px''; ]]]'
          - border-radius: 999px
          - box-shadow: none
          - border: none
          - padding: '0'
          - margin: '0'
          - background: '[[[ return variables.DEBUG_HIT ? "rgba(255,0,0,0.55)" : "transparent";
              ]]]

              '
          - opacity: '[[[ return variables.DEBUG_HIT ? 1 : 0.001; ]]]

              '
          - --mdc-ripple-color: transparent
          - --mdc-ripple-press-opacity: '0'
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              popup_card_id: dcac_popup
    link_hit:
      card:
        type: custom:button-card
        show_name: false
        show_icon: false
        show_state: false
        styles:
          card:
          - width: '[[[ return variables.link_size + ''px''; ]]]'
          - height: '[[[ return variables.link_size + ''px''; ]]]'
          - border-radius: 999px
          - background: transparent
          - box-shadow: none
          - border: none
          - opacity: '0.001'
          - padding: '0'
          - margin: '0'
          - --mdc-ripple-color: transparent
          - --mdc-ripple-press-opacity: '0'
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              popup_card_id: alarm_popup
- type: custom:popup-card
  popup_card_id: pv_popup
  title: PV
  timeout: 0
  dismissable: true
  size: normal
  style: "\nha-dialog .mdc-dialog__content { padding: 0 !important; } ha-dialog .mdc-dialog__surface\
    \ { background: transparent !important; } ha-dialog::part(header) { display: none\
    \ !important; }\nbrowser-mod-popup::part(header) { display: none !important; }\n\
    \      /* Desktop centered modal */\nha-dialog .mdc-dialog__surface { border-radius:\
    \ 26px !important; overflow: hidden !important; width: min(var(--popup-width,\
    \ 420px), 95vw) !important; max-width: 95vw !important; }\n      /* Mobile bottom\
    \ sheet */\n      @media (max-width: 800px) {\n  ha-dialog .mdc-dialog__surface\
    \ {\n    position: fixed !important; left: 0 !important; right: 0 !important;\
    \ bottom: 0 !important; top: auto !important;\n    margin: 0 !important; width:\
    \ 100vw !important; max-width: 100vw !important;\n    border-radius: 26px 26px\
    \ 0 0 !important;\n        }\n      }\n"
  card:
    type: custom:button-card
    triggers_update:
    - binary_sensor.anenji_inverter_der_alarm_active
    - sensor.anenji_inverter_battery_charge_power
    - sensor.anenji_inverter_battery_current
    - sensor.anenji_inverter_battery_power_signed
    - sensor.anenji_inverter_battery_soc
    - sensor.anenji_inverter_battery_voltage
    - sensor.anenji_inverter_fault_alarm
    - sensor.anenji_inverter_grid_export_power_filtered
    - sensor.anenji_inverter_grid_import_power_filtered
    - sensor.anenji_inverter_load_power_total_output
    - sensor.anenji_inverter_pv1_current
    - sensor.anenji_inverter_pv1_power
    - sensor.anenji_inverter_pv1_voltage
    - sensor.anenji_inverter_pv2_current
    - sensor.anenji_inverter_pv2_power
    - sensor.anenji_inverter_pv2_voltage
    - sensor.shellyem_c4d8d500468f_channel_1_power
    - sensor.shellyem_c4d8d500468f_channel_2_power
    update_interval: 1
    show_name: false
    show_icon: false
    show_state: false
    styles:
      card:
      - padding: 14px 14px 12px
      - border-radius: 0px
      - overflow: hidden
      - box-shadow: none
      - background: rgba(13,18,22,0.82)
      - border: none
      - color: '#fff'
      grid:
      - grid-template-areas: '"rows"'
      - grid-template-columns: 1fr
      - justify-items: center
      - align-items: start
      - text-align: left
      custom_fields:
        rows:
        - justify-self: center
        - align-self: start
        - text-align: left
        - width: 100%
        - max-width: 520px
    custom_fields:
      rows: "[[[\n  const H = hass;\n  const st = (eid) => H?.states?.[eid]?.state;\n\
        \  const num = (eid) => { const v = parseFloat(st(eid)); return Number.isFinite(v)\
        \ ? v : 0; };\n\n  const fmtV = (v) => `${v.toFixed(1)}`;\n  const fmtA =\
        \ (a) => `${a.toFixed(1)}`;\n  const fmtP = (w) => (Math.abs(w) >= 1000) ?\
        \ (w/1000).toFixed(2) : String(Math.round(w));\n  const unitP = (w) => (Math.abs(w)\
        \ >= 1000) ? \"kW\" : \"W\";\n  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));\n\
        \  const t = (w, maxW=5000) => clamp(Math.abs(w)/maxW, 0, 1);\n\n  const C=\"\
        #f5a623\"; // PV orange\n\n  const row = (label, value, unit, glow=0.35, idx=0)\
        \ => `\n    <div class=\"row\" data-i=\"${idx}\">\n      <div class=\"name\"\
        >${label}</div>\n      <div class=\"val\" style=\"color:${C}; text-shadow:\
        \ 0 0 ${6+10*glow}px rgba(245,166,35,${0.18+0.24*glow});\">${value}</div>\n\
        \      <div class=\"unit\">${unit}</div>\n    </div>\n        `;\n\n  const\
        \ pv1v = num(\"sensor.anenji_inverter_pv1_voltage\");\n  const pv1a = num(\"\
        sensor.anenji_inverter_pv1_current\");\n  const pv1p = num(\"sensor.anenji_inverter_pv1_power\"\
        );\n\n  const pv2v = num(\"sensor.anenji_inverter_pv2_voltage\");\n  const\
        \ pv2a = num(\"sensor.anenji_inverter_pv2_current\");\n  const pv2p = num(\"\
        sensor.anenji_inverter_pv2_power\");\n\n  return `\n    <style>\n      /*\
        \ --- Popup header compact + remove big white area --- */\n      .wrap{background:\
        \ rgba(15,20,24,0.94) !important; padding: 12px !important; border-radius:\
        \ 22px !important; gap: 10px !important;}\n      .title{margin: 0 0 8px 0\
        \ !important; font-size: 18px !important; font-weight: 800 !important; letter-spacing:\
        \ .3px !important; color: #fff !important; text-align: center !important;\
        \ width: 100% !important;}\n\n      .wrap{display:flex;flex-direction:column;gap:10px;}\n\
        \        .wrap{\n          align-items:flex-start;\n          justify-content:flex-start;\n\
        \        }\n                                    :root{--popup-width:380px;}\n\
        \        @media (max-width: 600px){\n          :root{--popup-width:95vw;}\n\
        \        }\n        .grid{\n          align-items:flex-start;\n          justify-content:flex-start;\n\
        \          width: fit-content;\n          max-width: var(--popup-width);\n\
        \        }\n        /* --- Elegant compact list tweaks --- */\n          \
        \                          :root{--popup-width:380px;}\n        @media (max-width:\
        \ 600px){\n          :root{--popup-width:95vw;}\n        }\n        .grid{\n\
        \          max-width: var(--popup-width);\n          width: fit-content;\n\
        \        }\n        .row{\n          padding: 10px 14px !important;\n    \
        \      border-radius: 18px !important;\n          border: 1px solid rgba(255,255,255,0.06)\
        \ !important;\n          background: rgba(255,255,255,0.04) !important;\n\
        \          box-shadow: inset 0 0 0 1px rgba(0,0,0,0.12);\n        }\n    \
        \    .row + .row{\n          margin-top: 10px !important;\n        }\n   \
        \     .row > :nth-child(1){\n          font-size: 18px !important;\n     \
        \     font-weight: 700 !important;\n          letter-spacing: 0.2px;\n   \
        \     }\n        .row > :nth-child(2){\n          font-variant-numeric: tabular-nums;\n\
        \          font-size: 20px !important;\n          font-weight: 800 !important;\n\
        \          margin-left: 10px;\n        }\n        .row > :nth-child(3){\n\
        \          font-size: 16px !important;\n          font-weight: 700 !important;\n\
        \          opacity: 0.75 !important;\n          margin-left: 6px;\n      \
        \  }\n        /* Make the card title area feel tighter */\n        .title{\n\
        \          margin: 0 0 12px 0 !important;\n          font-size: 20px !important;\n\
        \          letter-spacing: 0.3px;\n        }\n        /* Reduce empty space\
        \ on the right by shrinking the outer container */\n        .wrap{\n     \
        \     width: fit-content;\n          max-width: var(--popup-width);\n    \
        \    }\n      .title{font-weight:900;letter-spacing:.3px;font-size:14px;color:#fff;text-shadow:0\
        \ 0 10px rgba(255,255,255,0.22);}\n                                  :root{--popup-width:380px;}\n\
        \        @media (max-width: 600px){\n          :root{--popup-width:95vw;}\n\
        \        }\n        .grid{display:flex;flex-direction:column;gap:8px;}\n \
        \       /* --- Elegant compact list tweaks --- */\n                      \
        \              :root{--popup-width:380px;}\n        @media (max-width: 600px){\n\
        \          :root{--popup-width:95vw;}\n        }\n        .grid{\n       \
        \   max-width: var(--popup-width);\n          width: fit-content;\n      \
        \  }\n        .row{\n          padding: 10px 14px !important;\n          border-radius:\
        \ 18px !important;\n          border: 1px solid rgba(255,255,255,0.06) !important;\n\
        \          background: rgba(255,255,255,0.04) !important;\n          box-shadow:\
        \ inset 0 0 0 1px rgba(0,0,0,0.12);\n        }\n        .row + .row{\n   \
        \       margin-top: 10px !important;\n        }\n        .row > :nth-child(1){\n\
        \          font-size: 18px !important;\n          font-weight: 700 !important;\n\
        \          letter-spacing: 0.2px;\n        }\n        .row > :nth-child(2){\n\
        \          font-variant-numeric: tabular-nums;\n          font-size: 20px\
        \ !important;\n          font-weight: 800 !important;\n          margin-left:\
        \ 10px;\n        }\n        .row > :nth-child(3){\n          font-size: 16px\
        \ !important;\n          font-weight: 700 !important;\n          opacity:\
        \ 0.75 !important;\n          margin-left: 6px;\n        }\n        /* Make\
        \ the card title area feel tighter */\n        .title{\n          margin:\
        \ 0 0 12px 0 !important;\n          font-size: 20px !important;\n        \
        \  letter-spacing: 0.3px;\n        }\n        /* Reduce empty space on the\
        \ right by shrinking the outer container */\n        .wrap{\n          width:\
        \ fit-content;\n          max-width: var(--popup-width);\n        }\n    \
        \  .row{\n        display:grid;\n        box-sizing:border-box;\n        max-width:\
        \ fit-content;\n        grid-template-columns: 1fr auto auto;\n        column-gap:\
        \ 10px;\n        align-items:baseline;\n        gap:10px;\n        padding:8px\
        \ 10px;\n        border-radius:14px;\n        background: rgba(255,255,255,0.04);\n\
        \        border: 1px solid rgba(255,255,255,0.06);\n      }\n        .row\
        \ > :nth-child(2){\n          justify-self: start;\n          text-align:\
        \ left;\n          font-weight: 600;\n        }\n        .row > :nth-child(3){\n\
        \          justify-self: start;\n          text-align: left;\n          opacity:\
        \ 0.8;\n        }\n      .name{color:rgba(255,255,255,0.80);font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}\n\
        \      /* LEFT-anchored value */\n      .val{justify-self:start;font-weight:1000;font-size:14px;line-height:1;}\n\
        \      .unit{justify-self:start;color:rgba(255,255,255,0.55);font-weight:900;font-size:12px;letter-spacing:.2px;}\n\
        \      @media (max-width: 768px){\n        .row{grid-template-columns: 150px\
        \ 1fr 30px; padding:7px 9px;}\n        .name{font-size:12.5px;}\n        .val{font-size:13.5px;}\n\
        \        .unit{font-size:11.5px;}\n      /* PV1 Current, PV2 Current */\n\
        \      }\n    /* --- FINAL spacing override (tight label + value + unit) ---\
        \ */\n    .row{\n      display: flex !important;\n      align-items: center\
        \ !important;\n      justify-content: flex-start !important;\n      gap: 14px\
        \ !important;\n      width: fit-content !important;\n      max-width: var(--popup-width)\
        \ !important;\n    }\n    .name{ flex: 0 0 auto !important; }\n    .val{ \
        \ flex: 0 0 auto !important; margin: 0 !important; }\n    .unit{ flex: 0 0\
        \ auto !important; margin: 0 !important; opacity: 0.75 !important; }\n   \
        \ /* --- Prevent parent stretch (key for tight pills) --- */\n    .grid{\n\
        \      align-items: flex-start !important;\n    }\n    .row{\n      align-self:\
        \ flex-start !important;\n    }\n    /* --- Align values (fixed label width)\
        \ --- */\n    :root{\n      --label-width: 170px;\n    }\n    @media (max-width:\
        \ 600px){\n      :root{\n        --label-width: 140px;\n      }\n    }\n \
        \   .row > :nth-child(1){\n      flex: 0 0 var(--label-width) !important;\n\
        \      width: var(--label-width) !important;\n      white-space: nowrap !important;\n\
        \      overflow: hidden !important;\n      text-overflow: ellipsis !important;\n\
        \    }\n    .row > :nth-child(2){\n      min-width: 64px !important;\n   \
        \   text-align: right !important;\n    }\n    /***** INDUSTRIAL THEME *****/\n\
        \    :root{\n      --panel-bg: rgba(20,22,24,0.92);\n      --pill-bg: rgba(255,255,255,0.04);\n\
        \      --pill-border: rgba(255,255,255,0.10);\n      --text-dim: rgba(255,255,255,0.72);\n\
        \      --text-dimmer: rgba(255,255,255,0.55);\n      --shadow-soft: 0 10px\
        \ 30px rgba(0,0,0,0.35);\n      --shadow-inset: inset 0 1px 0 rgba(255,255,255,0.05),\
        \ inset 0 -1px 0 rgba(0,0,0,0.25);\n    }\n    \n    .wrap{ width:100% !important;\
        \ max-width:100% !important; }\n    .grid{\n      width: 100% !important;\n\
        \      max-width: var(--popup-width) !important;\n      background: var(--panel-bg)\
        \ !important;\n      border: 1px solid rgba(255,255,255,0.06) !important;\n\
        \      border-radius: 16px !important;\n      padding: 14px 14px 12px !important;\n\
        \      box-shadow: var(--shadow-soft) !important;\n    }\n    \n    .row{\n\
        \      width: 100% !important;\n      display: flex !important;\n      align-items:\
        \ center !important;\n      gap: 10px !important;\n      padding: 12px 14px\
        \ !important;\n      border-radius: 16px !important;\n      background: var(--pill-bg)\
        \ !important;\n      border: 1px solid var(--pill-border) !important;\n  \
        \    box-shadow: var(--shadow-inset) !important;\n    }\n    \n    .row >\
        \ :nth-child(1){\n      flex: 0 0 var(--label-width) !important;\n      width:\
        \ var(--label-width) !important;\n      color: var(--text-dim) !important;\n\
        \      font-weight: 700 !important;\n      letter-spacing: 0.2px !important;\n\
        \      text-transform: uppercase !important;\n      font-size: 13px !important;\n\
        \    }\n    .row > :nth-child(2){\n      font-variant-numeric: tabular-nums\
        \ !important;\n      font-weight: 800 !important;\n      font-size: 22px !important;\n\
        \      line-height: 1 !important;\n    }\n    .row > :nth-child(3){\n    \
        \  color: var(--text-dimmer) !important;\n      font-weight: 700 !important;\n\
        \      font-size: 13px !important;\n      margin-left: 4px !important;\n \
        \     letter-spacing: 0.4px !important;\n      text-transform: uppercase !important;\n\
        \    }\n    \n    .row + .row{\n      margin-top: 10px !important;\n    }\n\
        \    \n    @media (max-width: 600px){\n      .grid{ padding: 12px !important;\
        \ border-radius: 14px !important; }\n      .row{ padding: 11px 12px !important;\
        \ border-radius: 14px !important; }\n      .row > :nth-child(2){ font-size:\
        \ 20px !important; }\n    }\n    /***** TESLA-STYLE UI (soft glow, glass pills,\
        \ tight rhythm) *****/\n    :root{\n      --panel-bg: rgba(12,14,16,0.82);\n\
        \      --panel-border: rgba(255,255,255,0.06);\n      --pill-bg: rgba(255,255,255,0.055);\n\
        \      --pill-bg-2: rgba(255,255,255,0.035);\n      --pill-border: rgba(255,255,255,0.08);\n\
        \      --text: rgba(255,255,255,0.92);\n      --text-dim: rgba(255,255,255,0.72);\n\
        \      --text-dimmer: rgba(255,255,255,0.55);\n      --shadow: 0 18px 50px\
        \ rgba(0,0,0,0.45);\n      --inset: inset 0 1px 0 rgba(255,255,255,0.07),\
        \ inset 0 -1px 0 rgba(0,0,0,0.35);\n      --glow: 0 0 18px rgba(80,180,255,0.14);\n\
        \      --radius: 18px;\n    }\n    \n    /* Panel */\n    .wrap{ width:100%\
        \ !important; max-width:100% !important; }\n    .grid{\n      width: 100%\
        \ !important;\n      max-width: var(--popup-width) !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  var(--panel-bg) !important;\n\
        \      border: 1px solid var(--panel-border) !important;\n      border-radius:\
        \ calc(var(--radius) + 2px) !important;\n      padding: 12px 12px 10px !important;\n\
        \      box-shadow: var(--shadow), var(--glow) !important;\n      backdrop-filter:\
        \ blur(10px);\n    }\n    \n    /* Rows (glass pills) */\n    .row{\n    \
        \  width: 100% !important;\n      display: flex !important;\n      align-items:\
        \ center !important;\n      gap: 10px !important;\n      padding: 10px 12px\
        \ !important;\n      border-radius: var(--radius) !important;\n      background:\
        \ linear-gradient(180deg, var(--pill-bg) 0%, var(--pill-bg-2) 100%) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--inset) !important;\n    }\n    \n    /* Tight rhythm */\n    .row\
        \ + .row{ margin-top: 8px !important; }\n    \n    /* Label / value / unit\
        \ */\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width) !important;\n\
        \      width: var(--label-width) !important;\n      color: var(--text-dim)\
        \ !important;\n      font-weight: 650 !important;\n      letter-spacing: 0.18px\
        \ !important;\n      font-size: 13px !important;\n      text-transform: none\
        \ !important;\n    }\n    .row > :nth-child(2){\n      color: var(--text)\
        \ !important;\n      font-variant-numeric: tabular-nums !important;\n    \
        \  font-weight: 800 !important;\n      font-size: 22px !important;\n     \
        \ line-height: 1 !important;\n      text-align: right !important;\n      min-width:\
        \ 68px !important;\n    }\n    .row > :nth-child(3){\n      color: var(--text-dimmer)\
        \ !important;\n      font-weight: 700 !important;\n      font-size: 12px !important;\n\
        \      letter-spacing: 0.3px !important;\n      text-transform: uppercase\
        \ !important;\n    }\n    \n    /* Subtle hover (desktop) */\n    @media (hover:hover){\n\
        \      .row:hover{\n        border-color: rgba(255,255,255,0.14) !important;\n\
        \        box-shadow: var(--inset), 0 0 18px rgba(255,255,255,0.06) !important;\n\
        \      }\n    }\n    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n\
        \      .grid{ padding: 10px !important; border-radius: 18px !important; }\n\
        \      .row{ padding: 10px 11px !important; border-radius: 16px !important;\
        \ }\n      .row > :nth-child(2){ font-size: 20px !important; min-width: 62px\
        \ !important; }\n      .row > :nth-child(1){ font-size: 12.5px !important;\
        \ }\n    }\n    /***** TESLA POPUP REFINEMENT (based on your HTML structure)\
        \ *****/\n    \n    /* 1) Remove inner dark title (e.g., PV/Battery) */\n\
        \    .wrap > .title{\n      display: none !important;\n    }\n    \n    /*\
        \ 2) Make panel/rows use full available width (kills right-side empty gap)\
        \ */\n    .wrap{\n      width: min(var(--popup-width), 95vw) !important;\n\
        \      max-width: min(var(--popup-width), 95vw) !important;\n    }\n    .grid{\n\
        \      width: 100% !important;\n      max-width: 100% !important;\n      display:\
        \ flex !important;\n      flex-direction: column !important;\n      align-items:\
        \ stretch !important;   /* critical: prevents centered/narrow rows */\n  \
        \  }\n    \n    /* 3) Row layout: label left, value+unit tight right */\n\
        \    .row{\n      width: 100% !important;\n      display: grid !important;\n\
        \      grid-template-columns: 1fr auto auto !important;\n      column-gap:\
        \ 10px !important;\n      align-items: center !important;\n    }\n    \n \
        \   /* 4) Typography: make labels bigger & consistent with values */\n   \
        \ .name{\n      font-size: 18px !important;\n      font-weight: 650 !important;\n\
        \      color: rgba(255,255,255,0.82) !important;\n      letter-spacing: 0.12px\
        \ !important;\n    }\n    .val{\n      font-size: 30px !important;\n     \
        \ font-weight: 800 !important;\n      line-height: 1 !important;\n      text-align:\
        \ right !important;\n      font-variant-numeric: tabular-nums !important;\n\
        \    }\n    .unit{\n      font-size: 16px !important;\n      font-weight:\
        \ 700 !important;\n      opacity: 0.65 !important;\n      letter-spacing:\
        \ 0.3px !important;\n      text-transform: uppercase !important;\n    }\n\
        \    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n      .name{\
        \ font-size: 17px !important; }\n      .val{ font-size: 28px !important; }\n\
        \      .unit{ font-size: 15px !important; }\n    }\n    /***** TESLA PILLS\
        \ + FULL-WIDTH PANEL (ALL POPUPS) *****/\n    .wrap{ width:100% !important;\
        \ box-sizing:border-box !important; padding:14px !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  rgba(12,14,16,0.86)\
        \ !important;\n      border:1px solid rgba(255,255,255,0.06) !important;\n\
        \      border-radius:20px !important;\n      box-shadow: 0 18px 50px rgba(0,0,0,0.45),\
        \ 0 0 18px rgba(80,180,255,0.14) !important;\n      backdrop-filter: blur(10px);\n\
        \    }\n    .wrap > .title{ display:none !important; }\n    .grid{ width:100%\
        \ !important; max-width:100% !important; display:flex !important; flex-direction:column\
        \ !important;\n      gap:10px !important; padding:0 !important; background:transparent\
        \ !important; border:none !important; box-shadow:none !important;\n    }\n\
        \    .row{ width:100% !important; display:grid !important; grid-template-columns:\
        \ 1fr auto auto !important; column-gap:10px !important;\n      align-items:center\
        \ !important; padding:12px 14px !important; border-radius:18px !important;\n\
        \      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.035)\
        \ 100%) !important;\n      border:1px solid rgba(255,255,255,0.10) !important;\n\
        \      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), inset 0 -1px 0 rgba(0,0,0,0.38)\
        \ !important;\n    }\n    .name{ font-size:18px !important; font-weight:650\
        \ !important; color:rgba(255,255,255,0.84) !important; }\n    .val{ font-size:30px\
        \ !important; font-weight:800 !important; line-height:1 !important; font-variant-numeric:\
        \ tabular-nums !important; text-align:right !important; }\n    .unit{ font-size:16px\
        \ !important; font-weight:700 !important; opacity:0.65 !important; letter-spacing:0.3px\
        \ !important; text-transform:uppercase !important; }\n    @media (max-width:600px){\n\
        \      .wrap{ padding:12px !important; border-radius:18px !important; }\n\
        \      .row{ padding:11px 12px !important; border-radius:16px !important;\
        \ }\n      .name{ font-size:17px !important; }\n      .val{ font-size:28px\
        \ !important; }\n      .unit{ font-size:15px !important; }\n    }\n    /*****\
        \ FIX: make panel + pills stretch full width (no left-column cutout) *****/\n\
        \    .wrap{\n      display:block !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n      flex:\
        \ 1 1 auto !important;\n    }\n    .grid{\n      display:flex !important;\n\
        \      flex-direction:column !important;\n      align-items:stretch !important;\n\
        \      justify-content:flex-start !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n    }\n\
        \    .row{\n      width:100% !important;\n      max-width:none !important;\n\
        \      min-width:0 !important;\n    }\n    \n    /* --- vNEXT: center panel\
        \ + prevent right-cut (global) --- */\n    .wrap{\nwidth: 100% !important;\n\
        display: flex !important;\njustify-content: center !important;\n    }\n  \
        \  .grid{\nwidth: 100% !important;\nmax-width: min(560px, 100%) !important;\n\
        \    }\n    .row{\nwidth: 100% !important;\nmax-width: 100% !important;\n\
        box-sizing: border-box !important;\ndisplay: grid !important;\ngrid-template-columns:\
        \ 1fr auto auto !important;\ncolumn-gap: 14px !important;\nalign-items: center\
        \ !important;\njustify-content: initial !important;\ngap: 0 !important;\n\
        overflow: visible !important;\n    }\n    .name{\nwhite-space: nowrap !important;\n\
        overflow: hidden !important;\ntext-overflow: ellipsis !important;\nmin-width:\
        \ 0 !important;\n    }\n    .val, .unit{\nwhite-space: nowrap !important;\n\
        \    }\n    .unit{ padding-right: 6px !important; }\n\n    /* Center the inner\
        \ panel within the popup */\n\n    .wrap{\n\n      max-width: 520px !important;\n\
        \n      margin: 0 auto !important;\n\n    }\n\n    /* ===== Typography + layout\
        \ (global override) ===== */\n    .wrap {\n      width: min(900px, 100%) !important;\n\
        \      margin: 0 auto !important;\n    }\n    .grid {\n      width: 100% !important;\n\
        \    }\n    .row {\n      display: grid !important;\n      grid-template-columns:\
        \ 1fr auto auto !important;\n      align-items: center !important;\n     \
        \ column-gap: 12px !important;\n      padding: 14px 18px !important;\n   \
        \   border-radius: 999px !important;\n    }\n    .name {\n      font-size:\
        \ clamp(14px, 2.1vw, 18px) !important;\n      font-weight: 750 !important;\n\
        \      letter-spacing: 0.08em !important;\n      text-transform: uppercase\
        \ !important;\n      opacity: 0.92 !important;\n    }\n    .val {\n      font-size:\
        \ clamp(28px, 4.2vw, 46px) !important;\n      font-weight: 850 !important;\n\
        \      letter-spacing: -0.02em !important;\n      font-variant-numeric: tabular-nums\
        \ !important;\n      line-height: 1 !important;\n      color: #f5a623 !important;\n\
        \    }\n    .unit {\n      font-size: clamp(13px, 1.9vw, 18px) !important;\n\
        \      font-weight: 750 !important;\n      letter-spacing: 0.06em !important;\n\
        \      text-transform: uppercase !important;\n      opacity: 0.55 !important;\n\
        \    }\n    </style>\n    <div class=\"wrap\">\n      <div class=\"title\"\
        >PV</div>\n      <div class=\"grid\">\n        ${row(\"PV1 Voltage\", fmtV(pv1v),\
        \ \"V\", 0.20, 0)}\n        ${row(\"PV1 Current\", fmtA(pv1a), \"A\", 0.20,\
        \ 1)}\n        ${row(\"PV1 Power\",   fmtP(pv1p), unitP(pv1p), t(pv1p), 2)}\n\
        \        ${row(\"PV2 Voltage\", fmtV(pv2v), \"V\", 0.20, 3)}\n        ${row(\"\
        PV2 Current\", fmtA(pv2a), \"A\", 0.20, 4)}\n        ${row(\"PV2 Power\",\
        \   fmtP(pv2p), unitP(pv2p), t(pv2p), 5)}\n      </div>\n    </div>\n    \
        \    `;\n      ]]]\n"
- type: custom:popup-card
  popup_card_id: battery_popup
  title: Battery
  timeout: 0
  dismissable: true
  size: normal
  style: "\nha-dialog .mdc-dialog__content { padding: 0 !important; } ha-dialog .mdc-dialog__surface\
    \ { background: transparent !important; } ha-dialog::part(header) { display: none\
    \ !important; }\nbrowser-mod-popup::part(header) { display: none !important; }\n\
    ha-dialog .mdc-dialog__surface { border-radius: 26px !important; overflow: hidden\
    \ !important; width: min(var(--popup-width, 420px), 95vw) !important; max-width:\
    \ 95vw !important; }\n      @media (max-width: 800px) {\n  ha-dialog .mdc-dialog__surface\
    \ {\n    position: fixed !important; left: 0 !important; right: 0 !important;\
    \ bottom: 0 !important; top: auto !important;\n    margin: 0 !important; width:\
    \ 100vw !important; max-width: 100vw !important; border-radius: 26px 26px 0 0\
    \ !important;\n        }\n      }\n"
  card:
    type: custom:button-card
    triggers_update:
    - binary_sensor.anenji_inverter_der_alarm_active
    - sensor.anenji_inverter_battery_charge_power
    - sensor.anenji_inverter_battery_current
    - sensor.anenji_inverter_battery_power_signed
    - sensor.anenji_inverter_battery_soc
    - sensor.anenji_inverter_battery_voltage
    - sensor.anenji_inverter_fault_alarm
    - sensor.anenji_inverter_grid_export_power_filtered
    - sensor.anenji_inverter_grid_import_power_filtered
    - sensor.anenji_inverter_load_power_total_output
    - sensor.anenji_inverter_pv1_current
    - sensor.anenji_inverter_pv1_power
    - sensor.anenji_inverter_pv1_voltage
    - sensor.anenji_inverter_pv2_current
    - sensor.anenji_inverter_pv2_power
    - sensor.anenji_inverter_pv2_voltage
    - sensor.shellyem_c4d8d500468f_channel_1_power
    - sensor.shellyem_c4d8d500468f_channel_2_power
    update_interval: 1
    show_name: false
    show_icon: false
    show_state: false
    styles:
      card:
      - padding: 14px 14px 12px
      - border-radius: 0px
      - overflow: hidden
      - box-shadow: none
      - background: rgba(13,18,22,0.82)
      - border: none
      - color: '#fff'
      grid:
      - grid-template-areas: '"rows"'
      - grid-template-columns: 1fr
      - justify-items: center
      - align-items: start
      - text-align: left
      custom_fields:
        rows:
        - justify-self: center
        - align-self: start
        - text-align: left
        - width: 100%
        - max-width: 520px
    custom_fields:
      rows: "[[[\n  const H=hass;\n  const st=(eid)=>H?.states?.[eid]?.state;\n  const\
        \ num=(eid)=>{const v=parseFloat(st(eid)); return Number.isFinite(v)?v:0;};\n\
        \n  const fmtV=(v)=>`${v.toFixed(1)}`;\n  const fmtA=(a)=>`${a.toFixed(1)}`;\n\
        \  const fmtSOC=(s)=>`${Math.round(s)}`;\n  const fmtP=(w)=> (Math.abs(w)>=1000)\
        \ ? (w/1000).toFixed(2) : String(Math.round(w));\n  const unitP=(w)=> (Math.abs(w)>=1000)\
        \ ? \"kW\" : \"W\";\n\n  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));\n\
        \  const SOC=clamp(num(\"sensor.anenji_inverter_battery_soc\"),0,100);\n\n\
        \  const lerp=(a,b,t)=>a+(b-a)*t;\n  const hexToRgb=(h)=>{h=h.replace('#','');return\
        \ {r:parseInt(h.slice(0,2),16),g:parseInt(h.slice(2,4),16),b:parseInt(h.slice(4,6),16)}};\n\
        \  const rgbToHex=({r,g,b})=>`#${[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('')}`;\n\
        \  const lerpColor=(c1,c2,t)=>{const A=hexToRgb(c1),B=hexToRgb(c2);return\
        \ rgbToHex({r:Math.round(lerp(A.r,B.r,t)),g:Math.round(lerp(A.g,B.g,t)),b:Math.round(lerp(A.b,B.b,t))});};\n\
        \  const socColor = (SOC<=50) ? lerpColor(\"#ff3b30\",\"#ffd60a\",SOC/50)\
        \ : lerpColor(\"#ffd60a\",\"#34c759\",(SOC-50)/50);\n\n  const battV=num(\"\
        sensor.anenji_inverter_battery_voltage\");\n  const battA=num(\"sensor.anenji_inverter_battery_current\"\
        );\n  const battP=num(\"sensor.anenji_inverter_battery_power_signed\");\n\
        \  const chgP=num(\"sensor.anenji_inverter_battery_charge_power\");\n\n  const\
        \ C=\"#f5a623\";\n  const t=(w,maxW=5000)=>clamp(Math.abs(w)/maxW,0,1);\n\n\
        \  const ACCENT=\"#f5a623\";\n  const ACCENT_RGB=\"245,166,35\";\n  const\
        \ row=(label, value, unit, color=ACCENT, glow=0.25, idx=0)=>`\n    <div class=\"\
        row\" data-i=\"${idx}\">\n      <div class=\"name\">${label}</div>\n     \
        \ <div class=\"val\" style=\"color:${ACCENT}; text-shadow: 0 0 ${6+14*glow}px\
        \ rgba(245,166,35,${0.16+0.24*glow});\">${value}</div>\n      <div class=\"\
        unit\">${unit}</div>\n    </div>\n  `;\n\n  return `\n    <style>\n      /*\
        \ --- Popup header compact + remove big white area --- */\n      .wrap{background:\
        \ rgba(15,20,24,0.94) !important; padding: 12px !important; border-radius:\
        \ 22px !important; gap: 10px !important;}\n      .title{margin: 0 0 8px 0\
        \ !important; font-size: 18px !important; font-weight: 800 !important; letter-spacing:\
        \ .3px !important; color: #fff !important; text-align: center !important;\
        \ width: 100% !important;}\n\n      .wrap{display:flex;flex-direction:column;gap:10px;}\n\
        \      .title{font-weight:900;letter-spacing:.3px;font-size:14px;color:#fff;text-shadow:0\
        \ 0 10px rgba(255,255,255,0.22);}\n                                  :root{--popup-width:380px;}\n\
        \        @media (max-width: 600px){\n          :root{--popup-width:95vw;}\n\
        \        }\n        .grid{display:flex;flex-direction:column;gap:8px;}\n \
        \       /* --- Elegant compact list tweaks --- */\n                      \
        \              :root{--popup-width:380px;}\n        @media (max-width: 600px){\n\
        \          :root{--popup-width:95vw;}\n        }\n        .grid{\n       \
        \   max-width: var(--popup-width);\n          width: fit-content;\n      \
        \  }\n        .row{\n          padding: 10px 14px !important;\n          border-radius:\
        \ 18px !important;\n          border: 1px solid rgba(255,255,255,0.06) !important;\n\
        \          background: rgba(255,255,255,0.04) !important;\n          box-shadow:\
        \ inset 0 0 0 1px rgba(0,0,0,0.12);\n        }\n        .row + .row{\n   \
        \       margin-top: 10px !important;\n        }\n        .row > :nth-child(1){\n\
        \          font-size: 18px !important;\n          font-weight: 700 !important;\n\
        \          letter-spacing: 0.2px;\n        }\n        .row > :nth-child(2){\n\
        \          font-variant-numeric: tabular-nums;\n          font-size: 20px\
        \ !important;\n          font-weight: 800 !important;\n          margin-left:\
        \ 10px;\n        }\n        .row > :nth-child(3){\n          font-size: 16px\
        \ !important;\n          font-weight: 700 !important;\n          opacity:\
        \ 0.75 !important;\n          margin-left: 6px;\n        }\n        /* Make\
        \ the card title area feel tighter */\n        .title{\n          margin:\
        \ 0 0 12px 0 !important;\n          font-size: 20px !important;\n        \
        \  letter-spacing: 0.3px;\n        }\n        /* Reduce empty space on the\
        \ right by shrinking the outer container */\n        .wrap{\n          width:\
        \ fit-content;\n          max-width: var(--popup-width);\n        }\n    \
        \  .row{display:grid;\n        max-width: fit-content;grid-template-columns:\
        \ 1fr auto auto;\n        column-gap: 10px;align-items:baseline;gap:10px;padding:8px\
        \ 10px;border-radius:14px;background:rgba(255,255,255,0.04);border:1px solid\
        \ rgba(255,255,255,0.06);}\n      .name{color:rgba(255,255,255,0.80);font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}\n\
        \      .val{justify-self:start;font-weight:1000;font-size:14px;line-height:1;}\n\
        \      .unit{justify-self:start;color:rgba(255,255,255,0.55);font-weight:900;font-size:12px;letter-spacing:.2px;}\n\
        \      @media (max-width:768px){\n        .row{grid-template-columns:150px\
        \ 1fr 30px;padding:7px 9px;}\n        .name{font-size:12.5px;}\n        .val{font-size:13.5px;}\n\
        \        .unit{font-size:11.5px;}\n      }\n    /* --- FINAL spacing override\
        \ (tight label + value + unit) --- */\n    .row{\n      display: flex !important;\n\
        \      align-items: center !important;\n      justify-content: flex-start\
        \ !important;\n      gap: 14px !important;\n      width: fit-content !important;\n\
        \      max-width: var(--popup-width) !important;\n    }\n    .name{ flex:\
        \ 0 0 auto !important; }\n    .val{  flex: 0 0 auto !important; margin: 0\
        \ !important; }\n    .unit{ flex: 0 0 auto !important; margin: 0 !important;\
        \ opacity: 0.75 !important; }\n    /* --- Prevent parent stretch (key for\
        \ tight pills) --- */\n    .grid{\n      align-items: flex-start !important;\n\
        \    }\n    .row{\n      align-self: flex-start !important;\n    }\n    /*\
        \ --- Align values (fixed label width) --- */\n    :root{\n      --label-width:\
        \ 170px;\n    }\n    @media (max-width: 600px){\n      :root{\n        --label-width:\
        \ 140px;\n      }\n    }\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width)\
        \ !important;\n      width: var(--label-width) !important;\n      white-space:\
        \ nowrap !important;\n      overflow: hidden !important;\n      text-overflow:\
        \ ellipsis !important;\n    }\n    .row > :nth-child(2){\n      min-width:\
        \ 64px !important;\n      text-align: right !important;\n    }\n    /*****\
        \ INDUSTRIAL THEME *****/\n    :root{\n      --panel-bg: rgba(20,22,24,0.92);\n\
        \      --pill-bg: rgba(255,255,255,0.04);\n      --pill-border: rgba(255,255,255,0.10);\n\
        \      --text-dim: rgba(255,255,255,0.72);\n      --text-dimmer: rgba(255,255,255,0.55);\n\
        \      --shadow-soft: 0 10px 30px rgba(0,0,0,0.35);\n      --shadow-inset:\
        \ inset 0 1px 0 rgba(255,255,255,0.05), inset 0 -1px 0 rgba(0,0,0,0.25);\n\
        \    }\n    \n    .wrap{ width:100% !important; max-width:100% !important;\
        \ }\n    .grid{\n      width: 100% !important;\n      max-width: var(--popup-width)\
        \ !important;\n      background: var(--panel-bg) !important;\n      border:\
        \ 1px solid rgba(255,255,255,0.06) !important;\n      border-radius: 16px\
        \ !important;\n      padding: 14px 14px 12px !important;\n      box-shadow:\
        \ var(--shadow-soft) !important;\n    }\n    \n    .row{\n      width: 100%\
        \ !important;\n      display: flex !important;\n      align-items: center\
        \ !important;\n      gap: 10px !important;\n      padding: 12px 14px !important;\n\
        \      border-radius: 16px !important;\n      background: var(--pill-bg) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--shadow-inset) !important;\n    }\n    \n    .row > :nth-child(1){\n\
        \      flex: 0 0 var(--label-width) !important;\n      width: var(--label-width)\
        \ !important;\n      color: var(--text-dim) !important;\n      font-weight:\
        \ 700 !important;\n      letter-spacing: 0.2px !important;\n      text-transform:\
        \ uppercase !important;\n      font-size: 13px !important;\n    }\n    .row\
        \ > :nth-child(2){\n      font-variant-numeric: tabular-nums !important;\n\
        \      font-weight: 800 !important;\n      font-size: 22px !important;\n \
        \     line-height: 1 !important;\n    }\n    .row > :nth-child(3){\n     \
        \ color: var(--text-dimmer) !important;\n      font-weight: 700 !important;\n\
        \      font-size: 13px !important;\n      margin-left: 4px !important;\n \
        \     letter-spacing: 0.4px !important;\n      text-transform: uppercase !important;\n\
        \    }\n    \n    .row + .row{\n      margin-top: 10px !important;\n    }\n\
        \    \n    @media (max-width: 600px){\n      .grid{ padding: 12px !important;\
        \ border-radius: 14px !important; }\n      .row{ padding: 11px 12px !important;\
        \ border-radius: 14px !important; }\n      .row > :nth-child(2){ font-size:\
        \ 20px !important; }\n    }\n    /***** TESLA-STYLE UI (soft glow, glass pills,\
        \ tight rhythm) *****/\n    :root{\n      --panel-bg: rgba(12,14,16,0.82);\n\
        \      --panel-border: rgba(255,255,255,0.06);\n      --pill-bg: rgba(255,255,255,0.055);\n\
        \      --pill-bg-2: rgba(255,255,255,0.035);\n      --pill-border: rgba(255,255,255,0.08);\n\
        \      --text: rgba(255,255,255,0.92);\n      --text-dim: rgba(255,255,255,0.72);\n\
        \      --text-dimmer: rgba(255,255,255,0.55);\n      --shadow: 0 18px 50px\
        \ rgba(0,0,0,0.45);\n      --inset: inset 0 1px 0 rgba(255,255,255,0.07),\
        \ inset 0 -1px 0 rgba(0,0,0,0.35);\n      --glow: 0 0 18px rgba(80,180,255,0.14);\n\
        \      --radius: 18px;\n    }\n    \n    /* Panel */\n    .wrap{ width:100%\
        \ !important; max-width:100% !important; }\n    .grid{\n      width: 100%\
        \ !important;\n      max-width: var(--popup-width) !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  var(--panel-bg) !important;\n\
        \      border: 1px solid var(--panel-border) !important;\n      border-radius:\
        \ calc(var(--radius) + 2px) !important;\n      padding: 12px 12px 10px !important;\n\
        \      box-shadow: var(--shadow), var(--glow) !important;\n      backdrop-filter:\
        \ blur(10px);\n    }\n    \n    /* Rows (glass pills) */\n    .row{\n    \
        \  width: 100% !important;\n      display: flex !important;\n      align-items:\
        \ center !important;\n      gap: 10px !important;\n      padding: 10px 12px\
        \ !important;\n      border-radius: var(--radius) !important;\n      background:\
        \ linear-gradient(180deg, var(--pill-bg) 0%, var(--pill-bg-2) 100%) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--inset) !important;\n    }\n    \n    /* Tight rhythm */\n    .row\
        \ + .row{ margin-top: 8px !important; }\n    \n    /* Label / value / unit\
        \ */\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width) !important;\n\
        \      width: var(--label-width) !important;\n      color: var(--text-dim)\
        \ !important;\n      font-weight: 650 !important;\n      letter-spacing: 0.18px\
        \ !important;\n      font-size: 13px !important;\n      text-transform: none\
        \ !important;\n    }\n    .row > :nth-child(2){\n      color: var(--text)\
        \ !important;\n      font-variant-numeric: tabular-nums !important;\n    \
        \  font-weight: 800 !important;\n      font-size: 22px !important;\n     \
        \ line-height: 1 !important;\n      text-align: right !important;\n      min-width:\
        \ 68px !important;\n    }\n    .row > :nth-child(3){\n      color: var(--text-dimmer)\
        \ !important;\n      font-weight: 700 !important;\n      font-size: 12px !important;\n\
        \      letter-spacing: 0.3px !important;\n      text-transform: uppercase\
        \ !important;\n    }\n    \n    /* Subtle hover (desktop) */\n    @media (hover:hover){\n\
        \      .row:hover{\n        border-color: rgba(255,255,255,0.14) !important;\n\
        \        box-shadow: var(--inset), 0 0 18px rgba(255,255,255,0.06) !important;\n\
        \      }\n    }\n    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n\
        \      .grid{ padding: 10px !important; border-radius: 18px !important; }\n\
        \      .row{ padding: 10px 11px !important; border-radius: 16px !important;\
        \ }\n      .row > :nth-child(2){ font-size: 20px !important; min-width: 62px\
        \ !important; }\n      .row > :nth-child(1){ font-size: 12.5px !important;\
        \ }\n    }\n    /***** TESLA POPUP REFINEMENT (based on your HTML structure)\
        \ *****/\n    \n    /* 1) Remove inner dark title (e.g., PV/Battery) */\n\
        \    .wrap > .title{\n      display: none !important;\n    }\n    \n    /*\
        \ 2) Make panel/rows use full available width (kills right-side empty gap)\
        \ */\n    .wrap{\n      width: min(var(--popup-width), 95vw) !important;\n\
        \      max-width: min(var(--popup-width), 95vw) !important;\n    }\n    .grid{\n\
        \      width: 100% !important;\n      max-width: 100% !important;\n      display:\
        \ flex !important;\n      flex-direction: column !important;\n      align-items:\
        \ stretch !important;   /* critical: prevents centered/narrow rows */\n  \
        \  }\n    \n    /* 3) Row layout: label left, value+unit tight right */\n\
        \    .row{\n      width: 100% !important;\n      display: grid !important;\n\
        \      grid-template-columns: 1fr auto auto !important;\n      column-gap:\
        \ 10px !important;\n      align-items: center !important;\n    }\n    \n \
        \   /* 4) Typography: make labels bigger & consistent with values */\n   \
        \ .name{\n      font-size: 18px !important;\n      font-weight: 650 !important;\n\
        \      color: rgba(255,255,255,0.82) !important;\n      letter-spacing: 0.12px\
        \ !important;\n    }\n    .val{\n      font-size: 30px !important;\n     \
        \ font-weight: 800 !important;\n      line-height: 1 !important;\n      text-align:\
        \ right !important;\n      font-variant-numeric: tabular-nums !important;\n\
        \    }\n    .unit{\n      font-size: 16px !important;\n      font-weight:\
        \ 700 !important;\n      opacity: 0.65 !important;\n      letter-spacing:\
        \ 0.3px !important;\n      text-transform: uppercase !important;\n    }\n\
        \    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n      .name{\
        \ font-size: 17px !important; }\n      .val{ font-size: 28px !important; }\n\
        \      .unit{ font-size: 15px !important; }\n    }\n    /***** TESLA PILLS\
        \ + FULL-WIDTH PANEL (ALL POPUPS) *****/\n    .wrap{ width:100% !important;\
        \ box-sizing:border-box !important; padding:14px !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  rgba(12,14,16,0.86)\
        \ !important;\n      border:1px solid rgba(255,255,255,0.06) !important;\n\
        \      border-radius:20px !important;\n      box-shadow: 0 18px 50px rgba(0,0,0,0.45),\
        \ 0 0 18px rgba(80,180,255,0.14) !important;\n      backdrop-filter: blur(10px);\n\
        \    }\n    .wrap > .title{ display:none !important; }\n    .grid{ width:100%\
        \ !important; max-width:100% !important; display:flex !important; flex-direction:column\
        \ !important;\n      gap:10px !important; padding:0 !important; background:transparent\
        \ !important; border:none !important; box-shadow:none !important;\n    }\n\
        \    .row{ width:100% !important; display:grid !important; grid-template-columns:\
        \ 1fr auto auto !important; column-gap:10px !important;\n      align-items:center\
        \ !important; padding:12px 14px !important; border-radius:18px !important;\n\
        \      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.035)\
        \ 100%) !important;\n      border:1px solid rgba(255,255,255,0.10) !important;\n\
        \      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), inset 0 -1px 0 rgba(0,0,0,0.38)\
        \ !important;\n    }\n    .name{ font-size:18px !important; font-weight:650\
        \ !important; color:rgba(255,255,255,0.84) !important; }\n    .val{ font-size:30px\
        \ !important; font-weight:800 !important; line-height:1 !important; font-variant-numeric:\
        \ tabular-nums !important; text-align:right !important; }\n    .unit{ font-size:16px\
        \ !important; font-weight:700 !important; opacity:0.65 !important; letter-spacing:0.3px\
        \ !important; text-transform:uppercase !important; }\n    @media (max-width:600px){\n\
        \      .wrap{ padding:12px !important; border-radius:18px !important; }\n\
        \      .row{ padding:11px 12px !important; border-radius:16px !important;\
        \ }\n      .name{ font-size:17px !important; }\n      .val{ font-size:28px\
        \ !important; }\n      .unit{ font-size:15px !important; }\n    }\n    /*****\
        \ FIX: make panel + pills stretch full width (no left-column cutout) *****/\n\
        \    .wrap{\n      display:block !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n      flex:\
        \ 1 1 auto !important;\n    }\n    .grid{\n      display:flex !important;\n\
        \      flex-direction:column !important;\n      align-items:stretch !important;\n\
        \      justify-content:flex-start !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n    }\n\
        \    .row{\n      width:100% !important;\n      max-width:none !important;\n\
        \      min-width:0 !important;\n    }\n    \n    /* --- vNEXT: center panel\
        \ + prevent right-cut (global) --- */\n    .wrap{\nwidth: 100% !important;\n\
        display: flex !important;\njustify-content: center !important;\n    }\n  \
        \  .grid{\nwidth: 100% !important;\nmax-width: min(560px, 100%) !important;\n\
        \    }\n    .row{\nwidth: 100% !important;\nmax-width: 100% !important;\n\
        box-sizing: border-box !important;\ndisplay: grid !important;\ngrid-template-columns:\
        \ 1fr auto auto !important;\ncolumn-gap: 14px !important;\nalign-items: center\
        \ !important;\njustify-content: initial !important;\ngap: 0 !important;\n\
        overflow: visible !important;\n    }\n    .name{\nwhite-space: nowrap !important;\n\
        overflow: hidden !important;\ntext-overflow: ellipsis !important;\nmin-width:\
        \ 0 !important;\n    }\n    .val, .unit{\nwhite-space: nowrap !important;\n\
        \    }\n    .unit{ padding-right: 6px !important; }\n\n    /* Center the inner\
        \ panel within the popup */\n\n    .wrap{\n\n      max-width: 520px !important;\n\
        \n      margin: 0 auto !important;\n\n    }\n\n    /* ===== Typography + layout\
        \ (global override) ===== */\n    .wrap {\n      width: min(900px, 100%) !important;\n\
        \      margin: 0 auto !important;\n    }\n    .grid {\n      width: 100% !important;\n\
        \    }\n    .row {\n      display: grid !important;\n      grid-template-columns:\
        \ 1fr auto auto !important;\n      align-items: center !important;\n     \
        \ column-gap: 12px !important;\n      padding: 14px 18px !important;\n   \
        \   border-radius: 999px !important;\n    }\n    .name {\n      font-size:\
        \ clamp(14px, 2.1vw, 18px) !important;\n      font-weight: 750 !important;\n\
        \      letter-spacing: 0.08em !important;\n      text-transform: uppercase\
        \ !important;\n      opacity: 0.92 !important;\n    }\n    .val {\n      font-size:\
        \ clamp(28px, 4.2vw, 46px) !important;\n      font-weight: 850 !important;\n\
        \      letter-spacing: -0.02em !important;\n      font-variant-numeric: tabular-nums\
        \ !important;\n      line-height: 1 !important;\n      color: #f5a623 !important;\n\
        \    }\n    .unit {\n      font-size: clamp(13px, 1.9vw, 18px) !important;\n\
        \      font-weight: 750 !important;\n      letter-spacing: 0.06em !important;\n\
        \      text-transform: uppercase !important;\n      opacity: 0.55 !important;\n\
        \    }\n    </style>\n    <div class=\"wrap\">\n      <div class=\"title\"\
        >Battery</div>\n      <div class=\"grid\">\n        ${row(\"Battery Voltage\"\
        , fmtV(battV), \"V\", \"rgba(255,255,255,0.92)\", 0.15, 0)}\n        ${row(\"\
        Battery Current\", fmtA(battA), \"A\", \"rgba(255,255,255,0.92)\", 0.15, 1)}\n\
        \        ${row(\"Battery Power\",   fmtP(battP), unitP(battP), C, t(battP),\
        \ 2)}\n        ${row(\"Battery %\",       fmtSOC(SOC), \"%\", socColor, 0.22,\
        \ 4)}\n      </div>\n    </div>\n        `;\n      ]]]\n"
- type: custom:popup-card
  popup_card_id: grid_popup
  title: Grid
  timeout: 0
  dismissable: true
  size: normal
  style: "\nha-dialog .mdc-dialog__content { padding: 0 !important; } ha-dialog .mdc-dialog__surface\
    \ { background: transparent !important; } ha-dialog::part(header) { display: none\
    \ !important; }\nbrowser-mod-popup::part(header) { display: none !important; }\n\
    ha-dialog .mdc-dialog__surface { border-radius: 26px !important; overflow: hidden\
    \ !important; width: min(var(--popup-width, 420px), 95vw) !important; max-width:\
    \ 95vw !important; }\n      @media (max-width: 800px) {\n  ha-dialog .mdc-dialog__surface\
    \ {\n    position: fixed !important; left: 0 !important; right: 0 !important;\
    \ bottom: 0 !important; top: auto !important;\n    margin: 0 !important; width:\
    \ 100vw !important; max-width: 100vw !important; border-radius: 26px 26px 0 0\
    \ !important;\n        }\n      }\n"
  card:
    type: custom:button-card
    triggers_update:
    - binary_sensor.anenji_inverter_der_alarm_active
    - sensor.anenji_inverter_battery_charge_power
    - sensor.anenji_inverter_battery_current
    - sensor.anenji_inverter_battery_power_signed
    - sensor.anenji_inverter_battery_soc
    - sensor.anenji_inverter_battery_voltage
    - sensor.anenji_inverter_fault_alarm
    - sensor.anenji_inverter_grid_export_power_filtered
    - sensor.anenji_inverter_grid_import_power_filtered
    - sensor.anenji_inverter_load_power_total_output
    - sensor.anenji_inverter_pv1_current
    - sensor.anenji_inverter_pv1_power
    - sensor.anenji_inverter_pv1_voltage
    - sensor.anenji_inverter_pv2_current
    - sensor.anenji_inverter_pv2_power
    - sensor.anenji_inverter_pv2_voltage
    - sensor.shellyem_c4d8d500468f_channel_1_power
    - sensor.shellyem_c4d8d500468f_channel_2_power
    update_interval: 1
    show_name: false
    show_icon: false
    show_state: false
    styles:
      card:
      - padding: 14px 14px 12px
      - border-radius: 0px
      - overflow: hidden
      - box-shadow: none
      - background: rgba(13,18,22,0.82)
      - border: none
      - color: '#fff'
      grid:
      - grid-template-areas: '"rows"'
      - grid-template-columns: 1fr
      - justify-items: center
      - align-items: start
      - text-align: left
      custom_fields:
        rows:
        - justify-self: center
        - align-self: start
        - text-align: left
        - width: 100%
        - max-width: 520px
    custom_fields:
      rows: "[[[\n  const H=hass;\n  const st=(eid)=>H?.states?.[eid]?.state;\n  const\
        \ num=(eid)=>{const v=parseFloat(st(eid)); return Number.isFinite(v)?v:0;};\n\
        \n  const fmtV=(v)=>`${v.toFixed(1)}`;\n  const fmtP=(w)=> (Math.abs(w)>=1000)\
        \ ? (w/1000).toFixed(2) : String(Math.round(w));\n  const unitP=(w)=> (Math.abs(w)>=1000)\
        \ ? \"kW\" : \"W\";\n  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));\n \
        \ const t=(w,maxW=8000)=>clamp(Math.abs(w)/maxW,0,1);\n\n  const gridIn=num(\"\
        sensor.anenji_inverter_grid_import_power_filtered\");\n  const gridOut=num(\"\
        sensor.anenji_inverter_grid_export_power_filtered\");\n  const gridL1V=num(\"\
        sensor.anenji_inverter_mains_voltage_l1\");\n  const gridL2V=num(\"sensor.anenji_inverter_mains_voltage_l2\"\
        );\n  const gridL1A=num(\"sensor.anenji_inverter_mains_current_l1\");\n  const\
        \ gridL2A=num(\"sensor.anenji_inverter_mains_current_l2\");\n  const acV=num(\"\
        sensor.shellyem_c4d8d500468f_channel_1_voltage\");\n\n  const C=\"#f5a623\"\
        ;\n  const ACCENT=\"#f5a623\";\n  const ACCENT_RGB=\"245,166,35\";\n  const\
        \ row=(label, value, unit, color=ACCENT, glow=0.25, idx=0)=>`\n    <div class=\"\
        row\" data-i=\"${idx}\">\n      <div class=\"name\">${label}</div>\n     \
        \ <div class=\"val\" style=\"color:${ACCENT}; text-shadow: 0 0 ${6+14*glow}px\
        \ rgba(245,166,35,${0.16+0.24*glow});\">${value}</div>\n      <div class=\"\
        unit\">${unit}</div>\n    </div>\n  `;\n\n  return `\n    <style>\n      /*\
        \ --- Popup header compact + remove big white area --- */\n      .wrap{background:\
        \ rgba(15,20,24,0.94) !important; padding: 12px !important; border-radius:\
        \ 22px !important; gap: 10px !important;}\n      .title{margin: 0 0 8px 0\
        \ !important; font-size: 18px !important; font-weight: 800 !important; letter-spacing:\
        \ .3px !important; color: #fff !important; text-align: center !important;\
        \ width: 100% !important;}\n\n      .wrap{display:flex;flex-direction:column;gap:10px;}\n\
        \      .title{font-weight:900;letter-spacing:.3px;font-size:14px;color:#fff;text-shadow:0\
        \ 0 10px rgba(255,255,255,0.22);}\n                                  :root{--popup-width:380px;}\n\
        \        @media (max-width: 600px){\n          :root{--popup-width:95vw;}\n\
        \        }\n        .grid{display:flex;flex-direction:column;gap:8px;}\n \
        \       /* --- Elegant compact list tweaks --- */\n                      \
        \              :root{--popup-width:380px;}\n        @media (max-width: 600px){\n\
        \          :root{--popup-width:95vw;}\n        }\n        .grid{\n       \
        \   max-width: var(--popup-width);\n          width: fit-content;\n      \
        \  }\n        .row{\n          padding: 10px 14px !important;\n          border-radius:\
        \ 18px !important;\n          border: 1px solid rgba(255,255,255,0.06) !important;\n\
        \          background: rgba(255,255,255,0.04) !important;\n          box-shadow:\
        \ inset 0 0 0 1px rgba(0,0,0,0.12);\n        }\n        .row + .row{\n   \
        \       margin-top: 10px !important;\n        }\n        .row > :nth-child(1){\n\
        \          font-size: 18px !important;\n          font-weight: 700 !important;\n\
        \          letter-spacing: 0.2px;\n        }\n        .row > :nth-child(2){\n\
        \          font-variant-numeric: tabular-nums;\n          font-size: 20px\
        \ !important;\n          font-weight: 800 !important;\n          margin-left:\
        \ 10px;\n        }\n        .row > :nth-child(3){\n          font-size: 16px\
        \ !important;\n          font-weight: 700 !important;\n          opacity:\
        \ 0.75 !important;\n          margin-left: 6px;\n        }\n        /* Make\
        \ the card title area feel tighter */\n        .title{\n          margin:\
        \ 0 0 12px 0 !important;\n          font-size: 20px !important;\n        \
        \  letter-spacing: 0.3px;\n        }\n        /* Reduce empty space on the\
        \ right by shrinking the outer container */\n        .wrap{\n          width:\
        \ fit-content;\n          max-width: var(--popup-width);\n        }\n    \
        \  .row{display:grid;\n        max-width: fit-content;grid-template-columns:\
        \ 1fr auto auto;\n        column-gap: 10px;align-items:baseline;gap:10px;padding:8px\
        \ 10px;border-radius:14px;background:rgba(255,255,255,0.04);border:1px solid\
        \ rgba(255,255,255,0.06);}\n      .name{color:rgba(255,255,255,0.80);font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}\n\
        \      .val{justify-self:start;font-weight:1000;font-size:14px;line-height:1;}\n\
        \      .unit{justify-self:start;color:rgba(255,255,255,0.55);font-weight:900;font-size:12px;letter-spacing:.2px;}\n\
        \      @media (max-width:768px){\n        .row{grid-template-columns:150px\
        \ 1fr 30px;padding:7px 9px;}\n        .name{font-size:12.5px;}\n        .val{font-size:13.5px;}\n\
        \        .unit{font-size:11.5px;}\n      }\n    /* --- FINAL spacing override\
        \ (tight label + value + unit) --- */\n    .row{\n      display: flex !important;\n\
        \      align-items: center !important;\n      justify-content: flex-start\
        \ !important;\n      gap: 14px !important;\n      width: fit-content !important;\n\
        \      max-width: var(--popup-width) !important;\n    }\n    .name{ flex:\
        \ 0 0 auto !important; }\n    .val{  flex: 0 0 auto !important; margin: 0\
        \ !important; }\n    .unit{ flex: 0 0 auto !important; margin: 0 !important;\
        \ opacity: 0.75 !important; }\n    /* --- Prevent parent stretch (key for\
        \ tight pills) --- */\n    .grid{\n      align-items: flex-start !important;\n\
        \    }\n    .row{\n      align-self: flex-start !important;\n    }\n    /*\
        \ --- Align values (fixed label width) --- */\n    :root{\n      --label-width:\
        \ 170px;\n    }\n    @media (max-width: 600px){\n      :root{\n        --label-width:\
        \ 140px;\n      }\n    }\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width)\
        \ !important;\n      width: var(--label-width) !important;\n      white-space:\
        \ nowrap !important;\n      overflow: hidden !important;\n      text-overflow:\
        \ ellipsis !important;\n    }\n    .row > :nth-child(2){\n      min-width:\
        \ 64px !important;\n      text-align: right !important;\n    }\n    /*****\
        \ INDUSTRIAL THEME *****/\n    :root{\n      --panel-bg: rgba(20,22,24,0.92);\n\
        \      --pill-bg: rgba(255,255,255,0.04);\n      --pill-border: rgba(255,255,255,0.10);\n\
        \      --text-dim: rgba(255,255,255,0.72);\n      --text-dimmer: rgba(255,255,255,0.55);\n\
        \      --shadow-soft: 0 10px 30px rgba(0,0,0,0.35);\n      --shadow-inset:\
        \ inset 0 1px 0 rgba(255,255,255,0.05), inset 0 -1px 0 rgba(0,0,0,0.25);\n\
        \    }\n    \n    .wrap{ width:100% !important; max-width:100% !important;\
        \ }\n    .grid{\n      width: 100% !important;\n      max-width: var(--popup-width)\
        \ !important;\n      background: var(--panel-bg) !important;\n      border:\
        \ 1px solid rgba(255,255,255,0.06) !important;\n      border-radius: 16px\
        \ !important;\n      padding: 14px 14px 12px !important;\n      box-shadow:\
        \ var(--shadow-soft) !important;\n    }\n    \n    .row{\n      width: 100%\
        \ !important;\n      display: flex !important;\n      align-items: center\
        \ !important;\n      gap: 10px !important;\n      padding: 12px 14px !important;\n\
        \      border-radius: 16px !important;\n      background: var(--pill-bg) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--shadow-inset) !important;\n    }\n    \n    .row > :nth-child(1){\n\
        \      flex: 0 0 var(--label-width) !important;\n      width: var(--label-width)\
        \ !important;\n      color: var(--text-dim) !important;\n      font-weight:\
        \ 700 !important;\n      letter-spacing: 0.2px !important;\n      text-transform:\
        \ uppercase !important;\n      font-size: 13px !important;\n    }\n    .row\
        \ > :nth-child(2){\n      font-variant-numeric: tabular-nums !important;\n\
        \      font-weight: 800 !important;\n      font-size: 22px !important;\n \
        \     line-height: 1 !important;\n    }\n    .row > :nth-child(3){\n     \
        \ color: var(--text-dimmer) !important;\n      font-weight: 700 !important;\n\
        \      font-size: 13px !important;\n      margin-left: 4px !important;\n \
        \     letter-spacing: 0.4px !important;\n      text-transform: uppercase !important;\n\
        \    }\n    \n    .row + .row{\n      margin-top: 10px !important;\n    }\n\
        \    \n    @media (max-width: 600px){\n      .grid{ padding: 12px !important;\
        \ border-radius: 14px !important; }\n      .row{ padding: 11px 12px !important;\
        \ border-radius: 14px !important; }\n      .row > :nth-child(2){ font-size:\
        \ 20px !important; }\n    }\n    /***** TESLA-STYLE UI (soft glow, glass pills,\
        \ tight rhythm) *****/\n    :root{\n      --panel-bg: rgba(12,14,16,0.82);\n\
        \      --panel-border: rgba(255,255,255,0.06);\n      --pill-bg: rgba(255,255,255,0.055);\n\
        \      --pill-bg-2: rgba(255,255,255,0.035);\n      --pill-border: rgba(255,255,255,0.08);\n\
        \      --text: rgba(255,255,255,0.92);\n      --text-dim: rgba(255,255,255,0.72);\n\
        \      --text-dimmer: rgba(255,255,255,0.55);\n      --shadow: 0 18px 50px\
        \ rgba(0,0,0,0.45);\n      --inset: inset 0 1px 0 rgba(255,255,255,0.07),\
        \ inset 0 -1px 0 rgba(0,0,0,0.35);\n      --glow: 0 0 18px rgba(80,180,255,0.14);\n\
        \      --radius: 18px;\n    }\n    \n    /* Panel */\n    .wrap{ width:100%\
        \ !important; max-width:100% !important; }\n    .grid{\n      width: 100%\
        \ !important;\n      max-width: var(--popup-width) !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  var(--panel-bg) !important;\n\
        \      border: 1px solid var(--panel-border) !important;\n      border-radius:\
        \ calc(var(--radius) + 2px) !important;\n      padding: 12px 12px 10px !important;\n\
        \      box-shadow: var(--shadow), var(--glow) !important;\n      backdrop-filter:\
        \ blur(10px);\n    }\n    \n    /* Rows (glass pills) */\n    .row{\n    \
        \  width: 100% !important;\n      display: flex !important;\n      align-items:\
        \ center !important;\n      gap: 10px !important;\n      padding: 10px 12px\
        \ !important;\n      border-radius: var(--radius) !important;\n      background:\
        \ linear-gradient(180deg, var(--pill-bg) 0%, var(--pill-bg-2) 100%) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--inset) !important;\n    }\n    \n    /* Tight rhythm */\n    .row\
        \ + .row{ margin-top: 8px !important; }\n    \n    /* Label / value / unit\
        \ */\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width) !important;\n\
        \      width: var(--label-width) !important;\n      color: var(--text-dim)\
        \ !important;\n      font-weight: 650 !important;\n      letter-spacing: 0.18px\
        \ !important;\n      font-size: 13px !important;\n      text-transform: none\
        \ !important;\n    }\n    .row > :nth-child(2){\n      color: var(--text)\
        \ !important;\n      font-variant-numeric: tabular-nums !important;\n    \
        \  font-weight: 800 !important;\n      font-size: 22px !important;\n     \
        \ line-height: 1 !important;\n      text-align: right !important;\n      min-width:\
        \ 68px !important;\n    }\n    .row > :nth-child(3){\n      color: var(--text-dimmer)\
        \ !important;\n      font-weight: 700 !important;\n      font-size: 12px !important;\n\
        \      letter-spacing: 0.3px !important;\n      text-transform: uppercase\
        \ !important;\n    }\n    \n    /* Subtle hover (desktop) */\n    @media (hover:hover){\n\
        \      .row:hover{\n        border-color: rgba(255,255,255,0.14) !important;\n\
        \        box-shadow: var(--inset), 0 0 18px rgba(255,255,255,0.06) !important;\n\
        \      }\n    }\n    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n\
        \      .grid{ padding: 10px !important; border-radius: 18px !important; }\n\
        \      .row{ padding: 10px 11px !important; border-radius: 16px !important;\
        \ }\n      .row > :nth-child(2){ font-size: 20px !important; min-width: 62px\
        \ !important; }\n      .row > :nth-child(1){ font-size: 12.5px !important;\
        \ }\n    }\n    /***** TESLA POPUP REFINEMENT (based on your HTML structure)\
        \ *****/\n    \n    /* 1) Remove inner dark title (e.g., PV/Battery) */\n\
        \    .wrap > .title{\n      display: none !important;\n    }\n    \n    /*\
        \ 2) Make panel/rows use full available width (kills right-side empty gap)\
        \ */\n    .wrap{\n      width: min(var(--popup-width), 95vw) !important;\n\
        \      max-width: min(var(--popup-width), 95vw) !important;\n    }\n    .grid{\n\
        \      width: 100% !important;\n      max-width: 100% !important;\n      display:\
        \ flex !important;\n      flex-direction: column !important;\n      align-items:\
        \ stretch !important;   /* critical: prevents centered/narrow rows */\n  \
        \  }\n    \n    /* 3) Row layout: label left, value+unit tight right */\n\
        \    .row{\n      width: 100% !important;\n      display: grid !important;\n\
        \      grid-template-columns: 1fr auto auto !important;\n      column-gap:\
        \ 10px !important;\n      align-items: center !important;\n    }\n    \n \
        \   /* 4) Typography: make labels bigger & consistent with values */\n   \
        \ .name{\n      font-size: 18px !important;\n      font-weight: 650 !important;\n\
        \      color: rgba(255,255,255,0.82) !important;\n      letter-spacing: 0.12px\
        \ !important;\n    }\n    .val{\n      font-size: 30px !important;\n     \
        \ font-weight: 800 !important;\n      line-height: 1 !important;\n      text-align:\
        \ right !important;\n      font-variant-numeric: tabular-nums !important;\n\
        \    }\n    .unit{\n      font-size: 16px !important;\n      font-weight:\
        \ 700 !important;\n      opacity: 0.65 !important;\n      letter-spacing:\
        \ 0.3px !important;\n      text-transform: uppercase !important;\n    }\n\
        \    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n      .name{\
        \ font-size: 17px !important; }\n      .val{ font-size: 28px !important; }\n\
        \      .unit{ font-size: 15px !important; }\n    }\n    /***** TESLA PILLS\
        \ + FULL-WIDTH PANEL (ALL POPUPS) *****/\n    .wrap{ width:100% !important;\
        \ box-sizing:border-box !important; padding:14px !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  rgba(12,14,16,0.86)\
        \ !important;\n      border:1px solid rgba(255,255,255,0.06) !important;\n\
        \      border-radius:20px !important;\n      box-shadow: 0 18px 50px rgba(0,0,0,0.45),\
        \ 0 0 18px rgba(80,180,255,0.14) !important;\n      backdrop-filter: blur(10px);\n\
        \    }\n    .wrap > .title{ display:none !important; }\n    .grid{ width:100%\
        \ !important; max-width:100% !important; display:flex !important; flex-direction:column\
        \ !important;\n      gap:10px !important; padding:0 !important; background:transparent\
        \ !important; border:none !important; box-shadow:none !important;\n    }\n\
        \    .row{ width:100% !important; display:grid !important; grid-template-columns:\
        \ 1fr auto auto !important; column-gap:10px !important;\n      align-items:center\
        \ !important; padding:12px 14px !important; border-radius:18px !important;\n\
        \      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.035)\
        \ 100%) !important;\n      border:1px solid rgba(255,255,255,0.10) !important;\n\
        \      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), inset 0 -1px 0 rgba(0,0,0,0.38)\
        \ !important;\n    }\n    .name{ font-size:18px !important; font-weight:650\
        \ !important; color:rgba(255,255,255,0.84) !important; }\n    .val{ font-size:30px\
        \ !important; font-weight:800 !important; line-height:1 !important; font-variant-numeric:\
        \ tabular-nums !important; text-align:right !important; }\n    .unit{ font-size:16px\
        \ !important; font-weight:700 !important; opacity:0.65 !important; letter-spacing:0.3px\
        \ !important; text-transform:uppercase !important; }\n    @media (max-width:600px){\n\
        \      .wrap{ padding:12px !important; border-radius:18px !important; }\n\
        \      .row{ padding:11px 12px !important; border-radius:16px !important;\
        \ }\n      .name{ font-size:17px !important; }\n      .val{ font-size:28px\
        \ !important; }\n      .unit{ font-size:15px !important; }\n    }\n    /*****\
        \ FIX: make panel + pills stretch full width (no left-column cutout) *****/\n\
        \    .wrap{\n      display:block !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n      flex:\
        \ 1 1 auto !important;\n    }\n    .grid{\n      display:flex !important;\n\
        \      flex-direction:column !important;\n      align-items:stretch !important;\n\
        \      justify-content:flex-start !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n    }\n\
        \    .row{\n      width:100% !important;\n      max-width:none !important;\n\
        \      min-width:0 !important;\n    }\n    \n    /* --- vNEXT: center panel\
        \ + prevent right-cut (global) --- */\n    .wrap{\nwidth: 100% !important;\n\
        display: flex !important;\njustify-content: center !important;\n    }\n  \
        \  .grid{\nwidth: 100% !important;\nmax-width: min(560px, 100%) !important;\n\
        \    }\n    .row{\nwidth: 100% !important;\nmax-width: 100% !important;\n\
        box-sizing: border-box !important;\ndisplay: grid !important;\ngrid-template-columns:\
        \ 1fr auto auto !important;\ncolumn-gap: 14px !important;\nalign-items: center\
        \ !important;\njustify-content: initial !important;\ngap: 0 !important;\n\
        overflow: visible !important;\n    }\n    .name{\nwhite-space: nowrap !important;\n\
        overflow: hidden !important;\ntext-overflow: ellipsis !important;\nmin-width:\
        \ 0 !important;\n    }\n    .val, .unit{\nwhite-space: nowrap !important;\n\
        \    }\n    .unit{ padding-right: 6px !important; }\n\n    /* Center the inner\
        \ panel within the popup */\n\n    .wrap{\n\n      max-width: 520px !important;\n\
        \n      margin: 0 auto !important;\n\n    }\n\n    /* ===== Typography + layout\
        \ (global override) ===== */\n    .wrap {\n      width: min(900px, 100%) !important;\n\
        \      margin: 0 auto !important;\n    }\n    .grid {\n      width: 100% !important;\n\
        \    }\n    .row {\n      display: grid !important;\n      grid-template-columns:\
        \ 1fr auto auto !important;\n      align-items: center !important;\n     \
        \ column-gap: 12px !important;\n      padding: 14px 18px !important;\n   \
        \   border-radius: 999px !important;\n    }\n    .name {\n      font-size:\
        \ clamp(14px, 2.1vw, 18px) !important;\n      font-weight: 750 !important;\n\
        \      letter-spacing: 0.08em !important;\n      text-transform: uppercase\
        \ !important;\n      opacity: 0.92 !important;\n    }\n    .val {\n      font-size:\
        \ clamp(28px, 4.2vw, 46px) !important;\n      font-weight: 850 !important;\n\
        \      letter-spacing: -0.02em !important;\n      font-variant-numeric: tabular-nums\
        \ !important;\n      line-height: 1 !important;\n      color: #f5a623 !important;\n\
        \    }\n    .unit {\n      font-size: clamp(13px, 1.9vw, 18px) !important;\n\
        \      font-weight: 750 !important;\n      letter-spacing: 0.06em !important;\n\
        \      text-transform: uppercase !important;\n      opacity: 0.55 !important;\n\
        \    }\n    </style>\n    <div class=\"wrap\">\n      <div class=\"title\"\
        >Grid</div>\n      <div class=\"grid\">\n        ${row(\"Grid Power\", fmtP(gridIn),\
        \ unitP(gridIn), t(gridIn), 0)}                                 \n       \
        \ ${row(\"Grid Line 1 voltage\", fmtP(gridL1V), \"V\", t(gridIn), 0)}\n  \
        \      ${row(\"Grid line 1 Amperage\", fmtP(gridL1A), \"A\", t(gridL1A), 1)}\n\
        \        ${row(\"Grid Line 2 voltage\", fmtP(gridL2V), \"V\", t(gridL2V),\
        \ 0)}\n        ${row(\"Grid line 2 Amperage\", fmtP(gridL2A), \"A\", t(gridL2A),\
        \ 1)}\n      </div>\n    </div>\n        `;\n      ]]]\n"
- type: custom:popup-card
  popup_card_id: home_popup
  title: Home / Load
  timeout: 0
  dismissable: true
  size: normal
  style: "\nha-dialog .mdc-dialog__content { padding: 0 !important; } ha-dialog .mdc-dialog__surface\
    \ { background: transparent !important; } ha-dialog::part(header) { display: none\
    \ !important; }\nbrowser-mod-popup::part(header) { display: none !important; }\n\
    ha-dialog .mdc-dialog__surface { border-radius: 26px !important; overflow: hidden\
    \ !important; width: min(var(--popup-width, 420px), 95vw) !important; max-width:\
    \ 95vw !important; }\n      @media (max-width: 800px) {\n  ha-dialog .mdc-dialog__surface\
    \ {\n    position: fixed !important; left: 0 !important; right: 0 !important;\
    \ bottom: 0 !important; top: auto !important;\n    margin: 0 !important; width:\
    \ 100vw !important; max-width: 100vw !important; border-radius: 26px 26px 0 0\
    \ !important;\n        }\n      }\n"
  card:
    type: custom:button-card
    triggers_update:
    - binary_sensor.anenji_inverter_der_alarm_active
    - sensor.anenji_inverter_battery_charge_power
    - sensor.anenji_inverter_battery_current
    - sensor.anenji_inverter_battery_power_signed
    - sensor.anenji_inverter_battery_soc
    - sensor.anenji_inverter_battery_voltage
    - sensor.anenji_inverter_fault_alarm
    - sensor.anenji_inverter_grid_export_power_filtered
    - sensor.anenji_inverter_grid_import_power_filtered
    - sensor.anenji_inverter_load_power_total_output
    - sensor.anenji_inverter_pv1_current
    - sensor.anenji_inverter_pv1_power
    - sensor.anenji_inverter_pv1_voltage
    - sensor.anenji_inverter_pv2_current
    - sensor.anenji_inverter_pv2_power
    - sensor.anenji_inverter_pv2_voltage
    - sensor.shellyem_c4d8d500468f_channel_1_power
    - sensor.shellyem_c4d8d500468f_channel_2_power
    update_interval: 1
    show_name: false
    show_icon: false
    show_state: false
    styles:
      card:
      - padding: 14px 14px 12px
      - border-radius: 0px
      - overflow: hidden
      - box-shadow: none
      - background: rgba(13,18,22,0.82)
      - border: none
      - color: '#fff'
      grid:
      - grid-template-areas: '"rows"'
      - grid-template-columns: 1fr
      - justify-items: center
      - align-items: start
      - text-align: left
      custom_fields:
        rows:
        - justify-self: center
        - align-self: start
        - text-align: left
        - width: 100%
        - max-width: 520px
    custom_fields:
      rows: "[[[\n  const H=hass;\n  const st=(eid)=>H?.states?.[eid]?.state;\n  const\
        \ num=(eid)=>{const v=parseFloat(st(eid)); return Number.isFinite(v)?v:0;};\n\
        \n  const fmtP=(w)=> (Math.abs(w)>=1000) ? (w/1000).toFixed(2) : String(Math.round(w));\n\
        \  const unitP=(w)=> (Math.abs(w)>=1000) ? \"kW\" : \"W\";\n  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));\n\
        \  const t=(w,maxW=12000)=>clamp(Math.abs(w)/maxW,0,1);\n\n  const homeP=num(\"\
        sensor.anenji_inverter_load_power_total\");\n  const homeL1V=num(\"sensor.anenji_inverter_mains_voltage_l1\"\
        );\n  const homeL1A=num(\"sensor.anenji_inverter_output_current_l1\");\n \
        \ const homeL2V=num(\"sensor.anenji_inverter_mains_voltage_l2\");\n  const\
        \ homeL2A=num(\"sensor.anenji_inverter_output_current_l2\");\n  \n  const\
        \ ch1=num(\"sensor.anenji_inverter_load_power_l1_output\");\n  const ch2=num(\"\
        sensor.anenji_inverter_load_power_l2_output\");\n  const la1=num(\"sensor.anenji_inverter_output_current_l1\"\
        );\n  const la2=num(\"sensor.anenji_inverter_output_current_l2\");\n\n  const\
        \ C=\"#f5a623\";\n  const ACCENT=\"#f5a623\";\n  const ACCENT_RGB=\"245,166,35\"\
        ;\n  const row=(label, value, unit, color=ACCENT, glow=0.25, idx=0)=>`\n \
        \   <div class=\"row\" data-i=\"${idx}\">\n      <div class=\"name\">${label}</div>\n\
        \      <div class=\"val\" style=\"color:${ACCENT}; text-shadow: 0 0 ${6+14*glow}px\
        \ rgba(245,166,35,${0.16+0.24*glow});\">${value}</div>\n      <div class=\"\
        unit\">${unit}</div>\n    </div>\n  `;\n\n  return `\n    <style>\n      /*\
        \ --- Popup header compact + remove big white area --- */\n      .wrap{background:\
        \ rgba(15,20,24,0.94) !important; padding: 12px !important; border-radius:\
        \ 22px !important; gap: 10px !important;}\n      .title{margin: 0 0 8px 0\
        \ !important; font-size: 18px !important; font-weight: 800 !important; letter-spacing:\
        \ .3px !important; color: #fff !important; text-align: center !important;\
        \ width: 100% !important;}\n\n      .wrap{display:flex;flex-direction:column;gap:10px;}\n\
        \      .title{font-weight:900;letter-spacing:.3px;font-size:14px;color:#fff;text-shadow:0\
        \ 0 10px rgba(255,255,255,0.22);}\n                                  :root{--popup-width:380px;}\n\
        \        @media (max-width: 600px){\n          :root{--popup-width:95vw;}\n\
        \        }\n        .grid{display:flex;flex-direction:column;gap:8px;}\n \
        \       /* --- Elegant compact list tweaks --- */\n                      \
        \              :root{--popup-width:380px;}\n        @media (max-width: 600px){\n\
        \          :root{--popup-width:95vw;}\n        }\n        .grid{\n       \
        \   max-width: var(--popup-width);\n          width: fit-content;\n      \
        \  }\n        .row{\n          padding: 10px 14px !important;\n          border-radius:\
        \ 18px !important;\n          border: 1px solid rgba(255,255,255,0.06) !important;\n\
        \          background: rgba(255,255,255,0.04) !important;\n          box-shadow:\
        \ inset 0 0 0 1px rgba(0,0,0,0.12);\n        }\n        .row + .row{\n   \
        \       margin-top: 10px !important;\n        }\n        .row > :nth-child(1){\n\
        \          font-size: 18px !important;\n          font-weight: 700 !important;\n\
        \          letter-spacing: 0.2px;\n        }\n        .row > :nth-child(2){\n\
        \          font-variant-numeric: tabular-nums;\n          font-size: 20px\
        \ !important;\n          font-weight: 800 !important;\n          margin-left:\
        \ 10px;\n        }\n        .row > :nth-child(3){\n          font-size: 16px\
        \ !important;\n          font-weight: 700 !important;\n          opacity:\
        \ 0.75 !important;\n          margin-left: 6px;\n        }\n        /* Make\
        \ the card title area feel tighter */\n        .title{\n          margin:\
        \ 0 0 12px 0 !important;\n          font-size: 20px !important;\n        \
        \  letter-spacing: 0.3px;\n        }\n        /* Reduce empty space on the\
        \ right by shrinking the outer container */\n        .wrap{\n          width:\
        \ fit-content;\n          max-width: var(--popup-width);\n        }\n    \
        \  .row{display:grid;\n        max-width: fit-content;grid-template-columns:\
        \ 1fr auto auto;\n        column-gap: 10px;align-items:baseline;gap:10px;padding:8px\
        \ 10px;border-radius:14px;background:rgba(255,255,255,0.04);border:1px solid\
        \ rgba(255,255,255,0.06);}\n      .name{color:rgba(255,255,255,0.80);font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}\n\
        \      .val{justify-self:start;font-weight:1000;font-size:14px;line-height:1;}\n\
        \      .unit{justify-self:start;color:rgba(255,255,255,0.55);font-weight:900;font-size:12px;letter-spacing:.2px;}\n\
        \      @media (max-width:768px){\n        .row{grid-template-columns:150px\
        \ 1fr 30px;padding:7px 9px;}\n        .name{font-size:12.5px;}\n        .val{font-size:13.5px;}\n\
        \        .unit{font-size:11.5px;}\n      }\n    /* --- FINAL spacing override\
        \ (tight label + value + unit) --- */\n    .row{\n      display: flex !important;\n\
        \      align-items: center !important;\n      justify-content: flex-start\
        \ !important;\n      gap: 14px !important;\n      width: fit-content !important;\n\
        \      max-width: var(--popup-width) !important;\n    }\n    .name{ flex:\
        \ 0 0 auto !important; }\n    .val{  flex: 0 0 auto !important; margin: 0\
        \ !important; }\n    .unit{ flex: 0 0 auto !important; margin: 0 !important;\
        \ opacity: 0.75 !important; }\n    /* --- Prevent parent stretch (key for\
        \ tight pills) --- */\n    .grid{\n      align-items: flex-start !important;\n\
        \    }\n    .row{\n      align-self: flex-start !important;\n    }\n    /*\
        \ --- Align values (fixed label width) --- */\n    :root{\n      --label-width:\
        \ 170px;\n    }\n    @media (max-width: 600px){\n      :root{\n        --label-width:\
        \ 140px;\n      }\n    }\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width)\
        \ !important;\n      width: var(--label-width) !important;\n      white-space:\
        \ nowrap !important;\n      overflow: hidden !important;\n      text-overflow:\
        \ ellipsis !important;\n    }\n    .row > :nth-child(2){\n      min-width:\
        \ 64px !important;\n      text-align: right !important;\n    }\n    /*****\
        \ INDUSTRIAL THEME *****/\n    :root{\n      --panel-bg: rgba(20,22,24,0.92);\n\
        \      --pill-bg: rgba(255,255,255,0.04);\n      --pill-border: rgba(255,255,255,0.10);\n\
        \      --text-dim: rgba(255,255,255,0.72);\n      --text-dimmer: rgba(255,255,255,0.55);\n\
        \      --shadow-soft: 0 10px 30px rgba(0,0,0,0.35);\n      --shadow-inset:\
        \ inset 0 1px 0 rgba(255,255,255,0.05), inset 0 -1px 0 rgba(0,0,0,0.25);\n\
        \    }\n    \n    .wrap{ width:100% !important; max-width:100% !important;\
        \ }\n    .grid{\n      width: 100% !important;\n      max-width: var(--popup-width)\
        \ !important;\n      background: var(--panel-bg) !important;\n      border:\
        \ 1px solid rgba(255,255,255,0.06) !important;\n      border-radius: 16px\
        \ !important;\n      padding: 14px 14px 12px !important;\n      box-shadow:\
        \ var(--shadow-soft) !important;\n    }\n    \n    .row{\n      width: 100%\
        \ !important;\n      display: flex !important;\n      align-items: center\
        \ !important;\n      gap: 10px !important;\n      padding: 12px 14px !important;\n\
        \      border-radius: 16px !important;\n      background: var(--pill-bg) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--shadow-inset) !important;\n    }\n    \n    .row > :nth-child(1){\n\
        \      flex: 0 0 var(--label-width) !important;\n      width: var(--label-width)\
        \ !important;\n      color: var(--text-dim) !important;\n      font-weight:\
        \ 700 !important;\n      letter-spacing: 0.2px !important;\n      text-transform:\
        \ uppercase !important;\n      font-size: 13px !important;\n    }\n    .row\
        \ > :nth-child(2){\n      font-variant-numeric: tabular-nums !important;\n\
        \      font-weight: 800 !important;\n      font-size: 22px !important;\n \
        \     line-height: 1 !important;\n    }\n    .row > :nth-child(3){\n     \
        \ color: var(--text-dimmer) !important;\n      font-weight: 700 !important;\n\
        \      font-size: 13px !important;\n      margin-left: 4px !important;\n \
        \     letter-spacing: 0.4px !important;\n      text-transform: uppercase !important;\n\
        \    }\n    \n    .row + .row{\n      margin-top: 10px !important;\n    }\n\
        \    \n    @media (max-width: 600px){\n      .grid{ padding: 12px !important;\
        \ border-radius: 14px !important; }\n      .row{ padding: 11px 12px !important;\
        \ border-radius: 14px !important; }\n      .row > :nth-child(2){ font-size:\
        \ 20px !important; }\n    }\n    /***** TESLA-STYLE UI (soft glow, glass pills,\
        \ tight rhythm) *****/\n    :root{\n      --panel-bg: rgba(12,14,16,0.82);\n\
        \      --panel-border: rgba(255,255,255,0.06);\n      --pill-bg: rgba(255,255,255,0.055);\n\
        \      --pill-bg-2: rgba(255,255,255,0.035);\n      --pill-border: rgba(255,255,255,0.08);\n\
        \      --text: rgba(255,255,255,0.92);\n      --text-dim: rgba(255,255,255,0.72);\n\
        \      --text-dimmer: rgba(255,255,255,0.55);\n      --shadow: 0 18px 50px\
        \ rgba(0,0,0,0.45);\n      --inset: inset 0 1px 0 rgba(255,255,255,0.07),\
        \ inset 0 -1px 0 rgba(0,0,0,0.35);\n      --glow: 0 0 18px rgba(80,180,255,0.14);\n\
        \      --radius: 18px;\n    }\n    \n    /* Panel */\n    .wrap{ width:100%\
        \ !important; max-width:100% !important; }\n    .grid{\n      width: 100%\
        \ !important;\n      max-width: var(--popup-width) !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  var(--panel-bg) !important;\n\
        \      border: 1px solid var(--panel-border) !important;\n      border-radius:\
        \ calc(var(--radius) + 2px) !important;\n      padding: 12px 12px 10px !important;\n\
        \      box-shadow: var(--shadow), var(--glow) !important;\n      backdrop-filter:\
        \ blur(10px);\n    }\n    \n    /* Rows (glass pills) */\n    .row{\n    \
        \  width: 100% !important;\n      display: flex !important;\n      align-items:\
        \ center !important;\n      gap: 10px !important;\n      padding: 10px 12px\
        \ !important;\n      border-radius: var(--radius) !important;\n      background:\
        \ linear-gradient(180deg, var(--pill-bg) 0%, var(--pill-bg-2) 100%) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--inset) !important;\n    }\n    \n    /* Tight rhythm */\n    .row\
        \ + .row{ margin-top: 8px !important; }\n    \n    /* Label / value / unit\
        \ */\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width) !important;\n\
        \      width: var(--label-width) !important;\n      color: var(--text-dim)\
        \ !important;\n      font-weight: 650 !important;\n      letter-spacing: 0.18px\
        \ !important;\n      font-size: 13px !important;\n      text-transform: none\
        \ !important;\n    }\n    .row > :nth-child(2){\n      color: var(--text)\
        \ !important;\n      font-variant-numeric: tabular-nums !important;\n    \
        \  font-weight: 800 !important;\n      font-size: 22px !important;\n     \
        \ line-height: 1 !important;\n      text-align: right !important;\n      min-width:\
        \ 68px !important;\n    }\n    .row > :nth-child(3){\n      color: var(--text-dimmer)\
        \ !important;\n      font-weight: 700 !important;\n      font-size: 12px !important;\n\
        \      letter-spacing: 0.3px !important;\n      text-transform: uppercase\
        \ !important;\n    }\n    \n    /* Subtle hover (desktop) */\n    @media (hover:hover){\n\
        \      .row:hover{\n        border-color: rgba(255,255,255,0.14) !important;\n\
        \        box-shadow: var(--inset), 0 0 18px rgba(255,255,255,0.06) !important;\n\
        \      }\n    }\n    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n\
        \      .grid{ padding: 10px !important; border-radius: 18px !important; }\n\
        \      .row{ padding: 10px 11px !important; border-radius: 16px !important;\
        \ }\n      .row > :nth-child(2){ font-size: 20px !important; min-width: 62px\
        \ !important; }\n      .row > :nth-child(1){ font-size: 12.5px !important;\
        \ }\n    }\n    /***** TESLA POPUP REFINEMENT (based on your HTML structure)\
        \ *****/\n    \n    /* 1) Remove inner dark title (e.g., PV/Battery) */\n\
        \    .wrap > .title{\n      display: none !important;\n    }\n    \n    /*\
        \ 2) Make panel/rows use full available width (kills right-side empty gap)\
        \ */\n    .wrap{\n      width: min(var(--popup-width), 95vw) !important;\n\
        \      max-width: min(var(--popup-width), 95vw) !important;\n    }\n    .grid{\n\
        \      width: 100% !important;\n      max-width: 100% !important;\n      display:\
        \ flex !important;\n      flex-direction: column !important;\n      align-items:\
        \ stretch !important;   /* critical: prevents centered/narrow rows */\n  \
        \  }\n    \n    /* 3) Row layout: label left, value+unit tight right */\n\
        \    .row{\n      width: 100% !important;\n      display: grid !important;\n\
        \      grid-template-columns: 1fr auto auto !important;\n      column-gap:\
        \ 10px !important;\n      align-items: center !important;\n    }\n    \n \
        \   /* 4) Typography: make labels bigger & consistent with values */\n   \
        \ .name{\n      font-size: 18px !important;\n      font-weight: 650 !important;\n\
        \      color: rgba(255,255,255,0.82) !important;\n      letter-spacing: 0.12px\
        \ !important;\n    }\n    .val{\n      font-size: 30px !important;\n     \
        \ font-weight: 800 !important;\n      line-height: 1 !important;\n      text-align:\
        \ right !important;\n      font-variant-numeric: tabular-nums !important;\n\
        \    }\n    .unit{\n      font-size: 16px !important;\n      font-weight:\
        \ 700 !important;\n      opacity: 0.65 !important;\n      letter-spacing:\
        \ 0.3px !important;\n      text-transform: uppercase !important;\n    }\n\
        \    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n      .name{\
        \ font-size: 17px !important; }\n      .val{ font-size: 28px !important; }\n\
        \      .unit{ font-size: 15px !important; }\n    }\n    /***** TESLA PILLS\
        \ + FULL-WIDTH PANEL (ALL POPUPS) *****/\n    .wrap{ width:100% !important;\
        \ box-sizing:border-box !important; padding:14px !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  rgba(12,14,16,0.86)\
        \ !important;\n      border:1px solid rgba(255,255,255,0.06) !important;\n\
        \      border-radius:20px !important;\n      box-shadow: 0 18px 50px rgba(0,0,0,0.45),\
        \ 0 0 18px rgba(80,180,255,0.14) !important;\n      backdrop-filter: blur(10px);\n\
        \    }\n    .wrap > .title{ display:none !important; }\n    .grid{ width:100%\
        \ !important; max-width:100% !important; display:flex !important; flex-direction:column\
        \ !important;\n      gap:10px !important; padding:0 !important; background:transparent\
        \ !important; border:none !important; box-shadow:none !important;\n    }\n\
        \    .row{ width:100% !important; display:grid !important; grid-template-columns:\
        \ 1fr auto auto !important; column-gap:10px !important;\n      align-items:center\
        \ !important; padding:12px 14px !important; border-radius:18px !important;\n\
        \      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.035)\
        \ 100%) !important;\n      border:1px solid rgba(255,255,255,0.10) !important;\n\
        \      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), inset 0 -1px 0 rgba(0,0,0,0.38)\
        \ !important;\n    }\n    .name{ font-size:18px !important; font-weight:650\
        \ !important; color:rgba(255,255,255,0.84) !important; }\n    .val{ font-size:30px\
        \ !important; font-weight:800 !important; line-height:1 !important; font-variant-numeric:\
        \ tabular-nums !important; text-align:right !important; }\n    .unit{ font-size:16px\
        \ !important; font-weight:700 !important; opacity:0.65 !important; letter-spacing:0.3px\
        \ !important; text-transform:uppercase !important; }\n    @media (max-width:600px){\n\
        \      .wrap{ padding:12px !important; border-radius:18px !important; }\n\
        \      .row{ padding:11px 12px !important; border-radius:16px !important;\
        \ }\n      .name{ font-size:17px !important; }\n      .val{ font-size:28px\
        \ !important; }\n      .unit{ font-size:15px !important; }\n    }\n    /*****\
        \ FIX: make panel + pills stretch full width (no left-column cutout) *****/\n\
        \    .wrap{\n      display:block !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n      flex:\
        \ 1 1 auto !important;\n    }\n    .grid{\n      display:flex !important;\n\
        \      flex-direction:column !important;\n      align-items:stretch !important;\n\
        \      justify-content:flex-start !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n    }\n\
        \    .row{\n      width:100% !important;\n      max-width:none !important;\n\
        \      min-width:0 !important;\n    }\n    \n    /* --- vNEXT: center panel\
        \ + prevent right-cut (global) --- */\n    .wrap{\nwidth: 100% !important;\n\
        display: flex !important;\njustify-content: center !important;\n    }\n  \
        \  .grid{\nwidth: 100% !important;\nmax-width: min(560px, 100%) !important;\n\
        \    }\n    .row{\nwidth: 100% !important;\nmax-width: 100% !important;\n\
        box-sizing: border-box !important;\ndisplay: grid !important;\ngrid-template-columns:\
        \ 1fr auto auto !important;\ncolumn-gap: 14px !important;\nalign-items: center\
        \ !important;\njustify-content: initial !important;\ngap: 0 !important;\n\
        overflow: visible !important;\n    }\n    .name{\nwhite-space: nowrap !important;\n\
        overflow: hidden !important;\ntext-overflow: ellipsis !important;\nmin-width:\
        \ 0 !important;\n    }\n    .val, .unit{\nwhite-space: nowrap !important;\n\
        \    }\n    .unit{ padding-right: 6px !important; }\n\n    /* Center the inner\
        \ panel within the popup */\n\n    .wrap{\n\n      max-width: 520px !important;\n\
        \n      margin: 0 auto !important;\n\n    }\n\n    /* ===== Typography + layout\
        \ (global override) ===== */\n    .wrap {\n      width: min(900px, 100%) !important;\n\
        \      margin: 0 auto !important;\n    }\n    .grid {\n      width: 100% !important;\n\
        \    }\n    .row {\n      display: grid !important;\n      grid-template-columns:\
        \ 1fr auto auto !important;\n      align-items: center !important;\n     \
        \ column-gap: 12px !important;\n      padding: 14px 18px !important;\n   \
        \   border-radius: 999px !important;\n    }\n    .name {\n      font-size:\
        \ clamp(14px, 2.1vw, 18px) !important;\n      font-weight: 750 !important;\n\
        \      letter-spacing: 0.08em !important;\n      text-transform: uppercase\
        \ !important;\n      opacity: 0.92 !important;\n    }\n    .val {\n      font-size:\
        \ clamp(28px, 4.2vw, 46px) !important;\n      font-weight: 850 !important;\n\
        \      letter-spacing: -0.02em !important;\n      font-variant-numeric: tabular-nums\
        \ !important;\n      line-height: 1 !important;\n      color: #f5a623 !important;\n\
        \    }\n    .unit {\n      font-size: clamp(13px, 1.9vw, 18px) !important;\n\
        \      font-weight: 750 !important;\n      letter-spacing: 0.06em !important;\n\
        \      text-transform: uppercase !important;\n      opacity: 0.55 !important;\n\
        \    }\n    </style>\n    <div class=\"wrap\">\n      <div class=\"title\"\
        >Home / Load</div>\n      <div class=\"grid\">\n        ${row(\"Home Power\"\
        , fmtP(homeP), unitP(homeP), t(homeP), 0)}\n        ${row(\"Line 1 Voltage\"\
        ,  fmtP(homeL1V),   \"V\",   t(homeL1V),   1)}\n        ${row(\"Line 1 Amperage\"\
        ,  fmtP(homeL1A),   \"A\",   t(la1),   2)}\n        ${row(\"Line 2 Voltage\"\
        ,  fmtP(homeL2V),   \"V\",   t(ch2),   2)}                        \n     \
        \   ${row(\"Line 2 Amperage\",  fmtP(homeL2A),   \"A\",   t(la2),   2)}\n\
        \      </div>\n    </div>\n        `;\n      ]]]\n"
- type: custom:popup-card
  popup_card_id: dcac_popup
  title: DC/AC
  timeout: 0
  dismissable: true
  size: normal
  style: "\nha-dialog .mdc-dialog__content { padding: 0 !important; } ha-dialog .mdc-dialog__surface\
    \ { background: transparent !important; } ha-dialog::part(header) { display: none\
    \ !important; }\nbrowser-mod-popup::part(header) { display: none !important; }\n\
    ha-dialog .mdc-dialog__surface { border-radius: 26px !important; overflow: hidden\
    \ !important; width: min(var(--popup-width, 420px), 95vw) !important; max-width:\
    \ 95vw !important; }\n      @media (max-width: 800px) {\n  ha-dialog .mdc-dialog__surface\
    \ {\n    position: fixed !important; left: 0 !important; right: 0 !important;\
    \ bottom: 0 !important; top: auto !important;\n    margin: 0 !important; width:\
    \ 100vw !important; max-width: 100vw !important; border-radius: 26px 26px 0 0\
    \ !important;\n        }\n      }\n"
  card:
    type: custom:button-card
    triggers_update:
    - binary_sensor.anenji_inverter_der_alarm_active
    - sensor.anenji_inverter_battery_charge_power
    - sensor.anenji_inverter_battery_current
    - sensor.anenji_inverter_battery_power_signed
    - sensor.anenji_inverter_battery_soc
    - sensor.anenji_inverter_battery_voltage
    - sensor.anenji_inverter_fault_alarm
    - sensor.anenji_inverter_grid_export_power_filtered
    - sensor.anenji_inverter_grid_import_power_filtered
    - sensor.anenji_inverter_load_power_total_output
    - sensor.anenji_inverter_pv1_current
    - sensor.anenji_inverter_pv1_power
    - sensor.anenji_inverter_pv1_voltage
    - sensor.anenji_inverter_pv2_current
    - sensor.anenji_inverter_pv2_power
    - sensor.anenji_inverter_pv2_voltage
    - sensor.shellyem_c4d8d500468f_channel_1_power
    - sensor.shellyem_c4d8d500468f_channel_2_power
    update_interval: 1
    show_name: false
    show_icon: false
    show_state: false
    styles:
      card:
      - padding: 14px 14px 12px
      - border-radius: 0px
      - overflow: hidden
      - box-shadow: none
      - background: rgba(13,18,22,0.82)
      - border: none
      - color: '#fff'
      grid:
      - grid-template-areas: '"rows"'
      - grid-template-columns: 1fr
      - justify-items: center
      - align-items: start
      - text-align: left
      custom_fields:
        rows:
        - justify-self: center
        - align-self: start
        - text-align: left
        - width: 100%
        - max-width: 520px
    custom_fields:
      rows: "[[[\n  const H=hass;\n  const st=(eid)=>H?.states?.[eid]?.state;\n  const\
        \ num=(eid)=>{const v=parseFloat(st(eid)); return Number.isFinite(v)?v:0;};\n\
        \n  const fmtP=(w)=> (Math.abs(w)>=1000) ? (w/1000).toFixed(2) : String(Math.round(w));\n\
        \  const unitP=(w)=> (Math.abs(w)>=1000) ? \"kW\" : \"W\";\n\n  const pv=num(\"\
        sensor.anenji_inverter_pv1_power\");\n  const batt=num(\"sensor.anenji_inverter_battery_power_signed\"\
        );\n  const home=num(\"sensor.anenji_inverter_load_power_total_output\");\n\
        \  const gi=num(\"sensor.anenji_inverter_grid_import_power_filtered\");\n\
        \  const ge=num(\"sensor.anenji_inverter_grid_export_power_filtered\");\n\n\
        \  const ACCENT=\"#f5a623\";\n  const ACCENT_RGB=\"245,166,35\";\n  const\
        \ row=(label, value, unit, color=ACCENT, glow=0.25, idx=0)=>`\n    <div class=\"\
        row\" data-i=\"${idx}\">\n      <div class=\"name\">${label}</div>\n     \
        \ <div class=\"val\" style=\"color:${ACCENT}; text-shadow: 0 0 ${6+14*glow}px\
        \ rgba(245,166,35,${0.16+0.24*glow});\">${value}</div>\n      <div class=\"\
        unit\">${unit}</div>\n    </div>\n  `;\n\n  return `\n    <style>\n      /*\
        \ --- Popup header compact + remove big white area --- */\n      .wrap{background:\
        \ rgba(15,20,24,0.94) !important; padding: 12px !important; border-radius:\
        \ 22px !important; gap: 10px !important;}\n      .title{margin: 0 0 8px 0\
        \ !important; font-size: 18px !important; font-weight: 800 !important; letter-spacing:\
        \ .3px !important; color: #fff !important; text-align: center !important;\
        \ width: 100% !important;}\n\n      .wrap{display:flex;flex-direction:column;gap:10px;}\n\
        \      .title{font-weight:900;letter-spacing:.3px;font-size:14px;color:#fff;text-shadow:0\
        \ 0 10px rgba(255,255,255,0.22);}\n                                  :root{--popup-width:380px;}\n\
        \        @media (max-width: 600px){\n          :root{--popup-width:95vw;}\n\
        \        }\n        .grid{display:flex;flex-direction:column;gap:8px;}\n \
        \       /* --- Elegant compact list tweaks --- */\n                      \
        \              :root{--popup-width:380px;}\n        @media (max-width: 600px){\n\
        \          :root{--popup-width:95vw;}\n        }\n        .grid{\n       \
        \   max-width: var(--popup-width);\n          width: fit-content;\n      \
        \  }\n        .row{\n          padding: 10px 14px !important;\n          border-radius:\
        \ 18px !important;\n          border: 1px solid rgba(255,255,255,0.06) !important;\n\
        \          background: rgba(255,255,255,0.04) !important;\n          box-shadow:\
        \ inset 0 0 0 1px rgba(0,0,0,0.12);\n        }\n        .row + .row{\n   \
        \       margin-top: 10px !important;\n        }\n        .row > :nth-child(1){\n\
        \          font-size: 18px !important;\n          font-weight: 700 !important;\n\
        \          letter-spacing: 0.2px;\n        }\n        .row > :nth-child(2){\n\
        \          font-variant-numeric: tabular-nums;\n          font-size: 20px\
        \ !important;\n          font-weight: 800 !important;\n          margin-left:\
        \ 10px;\n        }\n        .row > :nth-child(3){\n          font-size: 16px\
        \ !important;\n          font-weight: 700 !important;\n          opacity:\
        \ 0.75 !important;\n          margin-left: 6px;\n        }\n        /* Make\
        \ the card title area feel tighter */\n        .title{\n          margin:\
        \ 0 0 12px 0 !important;\n          font-size: 20px !important;\n        \
        \  letter-spacing: 0.3px;\n        }\n        /* Reduce empty space on the\
        \ right by shrinking the outer container */\n        .wrap{\n          width:\
        \ fit-content;\n          max-width: var(--popup-width);\n        }\n    \
        \  .row{display:grid;\n        max-width: fit-content;grid-template-columns:\
        \ 1fr auto auto;\n        column-gap: 10px;align-items:baseline;gap:10px;padding:8px\
        \ 10px;border-radius:14px;background:rgba(255,255,255,0.04);border:1px solid\
        \ rgba(255,255,255,0.06);}\n      .name{color:rgba(255,255,255,0.80);font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}\n\
        \      .val{justify-self:start;font-weight:1000;font-size:14px;line-height:1;}\n\
        \      .unit{justify-self:start;color:rgba(255,255,255,0.55);font-weight:900;font-size:12px;letter-spacing:.2px;}\n\
        \      @media (max-width:768px){\n        .row{grid-template-columns:150px\
        \ 1fr 30px;padding:7px 9px;}\n        .name{font-size:12.5px;}\n        .val{font-size:13.5px;}\n\
        \        .unit{font-size:11.5px;}\n      }\n    /* --- FINAL spacing override\
        \ (tight label + value + unit) --- */\n    .row{\n      display: flex !important;\n\
        \      align-items: center !important;\n      justify-content: flex-start\
        \ !important;\n      gap: 14px !important;\n      width: fit-content !important;\n\
        \      max-width: var(--popup-width) !important;\n    }\n    .name{ flex:\
        \ 0 0 auto !important; }\n    .val{  flex: 0 0 auto !important; margin: 0\
        \ !important; }\n    .unit{ flex: 0 0 auto !important; margin: 0 !important;\
        \ opacity: 0.75 !important; }\n    /* --- Prevent parent stretch (key for\
        \ tight pills) --- */\n    .grid{\n      align-items: flex-start !important;\n\
        \    }\n    .row{\n      align-self: flex-start !important;\n    }\n    /*\
        \ --- Align values (fixed label width) --- */\n    :root{\n      --label-width:\
        \ 170px;\n    }\n    @media (max-width: 600px){\n      :root{\n        --label-width:\
        \ 140px;\n      }\n    }\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width)\
        \ !important;\n      width: var(--label-width) !important;\n      white-space:\
        \ nowrap !important;\n      overflow: hidden !important;\n      text-overflow:\
        \ ellipsis !important;\n    }\n    .row > :nth-child(2){\n      min-width:\
        \ 64px !important;\n      text-align: right !important;\n    }\n    /*****\
        \ INDUSTRIAL THEME *****/\n    :root{\n      --panel-bg: rgba(20,22,24,0.92);\n\
        \      --pill-bg: rgba(255,255,255,0.04);\n      --pill-border: rgba(255,255,255,0.10);\n\
        \      --text-dim: rgba(255,255,255,0.72);\n      --text-dimmer: rgba(255,255,255,0.55);\n\
        \      --shadow-soft: 0 10px 30px rgba(0,0,0,0.35);\n      --shadow-inset:\
        \ inset 0 1px 0 rgba(255,255,255,0.05), inset 0 -1px 0 rgba(0,0,0,0.25);\n\
        \    }\n    \n    .wrap{ width:100% !important; max-width:100% !important;\
        \ }\n    .grid{\n      width: 100% !important;\n      max-width: var(--popup-width)\
        \ !important;\n      background: var(--panel-bg) !important;\n      border:\
        \ 1px solid rgba(255,255,255,0.06) !important;\n      border-radius: 16px\
        \ !important;\n      padding: 14px 14px 12px !important;\n      box-shadow:\
        \ var(--shadow-soft) !important;\n    }\n    \n    .row{\n      width: 100%\
        \ !important;\n      display: flex !important;\n      align-items: center\
        \ !important;\n      gap: 10px !important;\n      padding: 12px 14px !important;\n\
        \      border-radius: 16px !important;\n      background: var(--pill-bg) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--shadow-inset) !important;\n    }\n    \n    .row > :nth-child(1){\n\
        \      flex: 0 0 var(--label-width) !important;\n      width: var(--label-width)\
        \ !important;\n      color: var(--text-dim) !important;\n      font-weight:\
        \ 700 !important;\n      letter-spacing: 0.2px !important;\n      text-transform:\
        \ uppercase !important;\n      font-size: 13px !important;\n    }\n    .row\
        \ > :nth-child(2){\n      font-variant-numeric: tabular-nums !important;\n\
        \      font-weight: 800 !important;\n      font-size: 22px !important;\n \
        \     line-height: 1 !important;\n    }\n    .row > :nth-child(3){\n     \
        \ color: var(--text-dimmer) !important;\n      font-weight: 700 !important;\n\
        \      font-size: 13px !important;\n      margin-left: 4px !important;\n \
        \     letter-spacing: 0.4px !important;\n      text-transform: uppercase !important;\n\
        \    }\n    \n    .row + .row{\n      margin-top: 10px !important;\n    }\n\
        \    \n    @media (max-width: 600px){\n      .grid{ padding: 12px !important;\
        \ border-radius: 14px !important; }\n      .row{ padding: 11px 12px !important;\
        \ border-radius: 14px !important; }\n      .row > :nth-child(2){ font-size:\
        \ 20px !important; }\n    }\n    /***** TESLA-STYLE UI (soft glow, glass pills,\
        \ tight rhythm) *****/\n    :root{\n      --panel-bg: rgba(12,14,16,0.82);\n\
        \      --panel-border: rgba(255,255,255,0.06);\n      --pill-bg: rgba(255,255,255,0.055);\n\
        \      --pill-bg-2: rgba(255,255,255,0.035);\n      --pill-border: rgba(255,255,255,0.08);\n\
        \      --text: rgba(255,255,255,0.92);\n      --text-dim: rgba(255,255,255,0.72);\n\
        \      --text-dimmer: rgba(255,255,255,0.55);\n      --shadow: 0 18px 50px\
        \ rgba(0,0,0,0.45);\n      --inset: inset 0 1px 0 rgba(255,255,255,0.07),\
        \ inset 0 -1px 0 rgba(0,0,0,0.35);\n      --glow: 0 0 18px rgba(80,180,255,0.14);\n\
        \      --radius: 18px;\n    }\n    \n    /* Panel */\n    .wrap{ width:100%\
        \ !important; max-width:100% !important; }\n    .grid{\n      width: 100%\
        \ !important;\n      max-width: var(--popup-width) !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  var(--panel-bg) !important;\n\
        \      border: 1px solid var(--panel-border) !important;\n      border-radius:\
        \ calc(var(--radius) + 2px) !important;\n      padding: 12px 12px 10px !important;\n\
        \      box-shadow: var(--shadow), var(--glow) !important;\n      backdrop-filter:\
        \ blur(10px);\n    }\n    \n    /* Rows (glass pills) */\n    .row{\n    \
        \  width: 100% !important;\n      display: flex !important;\n      align-items:\
        \ center !important;\n      gap: 10px !important;\n      padding: 10px 12px\
        \ !important;\n      border-radius: var(--radius) !important;\n      background:\
        \ linear-gradient(180deg, var(--pill-bg) 0%, var(--pill-bg-2) 100%) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--inset) !important;\n    }\n    \n    /* Tight rhythm */\n    .row\
        \ + .row{ margin-top: 8px !important; }\n    \n    /* Label / value / unit\
        \ */\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width) !important;\n\
        \      width: var(--label-width) !important;\n      color: var(--text-dim)\
        \ !important;\n      font-weight: 650 !important;\n      letter-spacing: 0.18px\
        \ !important;\n      font-size: 13px !important;\n      text-transform: none\
        \ !important;\n    }\n    .row > :nth-child(2){\n      color: var(--text)\
        \ !important;\n      font-variant-numeric: tabular-nums !important;\n    \
        \  font-weight: 800 !important;\n      font-size: 22px !important;\n     \
        \ line-height: 1 !important;\n      text-align: right !important;\n      min-width:\
        \ 68px !important;\n    }\n    .row > :nth-child(3){\n      color: var(--text-dimmer)\
        \ !important;\n      font-weight: 700 !important;\n      font-size: 12px !important;\n\
        \      letter-spacing: 0.3px !important;\n      text-transform: uppercase\
        \ !important;\n    }\n    \n    /* Subtle hover (desktop) */\n    @media (hover:hover){\n\
        \      .row:hover{\n        border-color: rgba(255,255,255,0.14) !important;\n\
        \        box-shadow: var(--inset), 0 0 18px rgba(255,255,255,0.06) !important;\n\
        \      }\n    }\n    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n\
        \      .grid{ padding: 10px !important; border-radius: 18px !important; }\n\
        \      .row{ padding: 10px 11px !important; border-radius: 16px !important;\
        \ }\n      .row > :nth-child(2){ font-size: 20px !important; min-width: 62px\
        \ !important; }\n      .row > :nth-child(1){ font-size: 12.5px !important;\
        \ }\n    }\n    /***** TESLA POPUP REFINEMENT (based on your HTML structure)\
        \ *****/\n    \n    /* 1) Remove inner dark title (e.g., PV/Battery) */\n\
        \    .wrap > .title{\n      display: none !important;\n    }\n    \n    /*\
        \ 2) Make panel/rows use full available width (kills right-side empty gap)\
        \ */\n    .wrap{\n      width: min(var(--popup-width), 95vw) !important;\n\
        \      max-width: min(var(--popup-width), 95vw) !important;\n    }\n    .grid{\n\
        \      width: 100% !important;\n      max-width: 100% !important;\n      display:\
        \ flex !important;\n      flex-direction: column !important;\n      align-items:\
        \ stretch !important;   /* critical: prevents centered/narrow rows */\n  \
        \  }\n    \n    /* 3) Row layout: label left, value+unit tight right */\n\
        \    .row{\n      width: 100% !important;\n      display: grid !important;\n\
        \      grid-template-columns: 1fr auto auto !important;\n      column-gap:\
        \ 10px !important;\n      align-items: center !important;\n    }\n    \n \
        \   /* 4) Typography: make labels bigger & consistent with values */\n   \
        \ .name{\n      font-size: 18px !important;\n      font-weight: 650 !important;\n\
        \      color: rgba(255,255,255,0.82) !important;\n      letter-spacing: 0.12px\
        \ !important;\n    }\n    .val{\n      font-size: 30px !important;\n     \
        \ font-weight: 800 !important;\n      line-height: 1 !important;\n      text-align:\
        \ right !important;\n      font-variant-numeric: tabular-nums !important;\n\
        \    }\n    .unit{\n      font-size: 16px !important;\n      font-weight:\
        \ 700 !important;\n      opacity: 0.65 !important;\n      letter-spacing:\
        \ 0.3px !important;\n      text-transform: uppercase !important;\n    }\n\
        \    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n      .name{\
        \ font-size: 17px !important; }\n      .val{ font-size: 28px !important; }\n\
        \      .unit{ font-size: 15px !important; }\n    }\n    /***** TESLA PILLS\
        \ + FULL-WIDTH PANEL (ALL POPUPS) *****/\n    .wrap{ width:100% !important;\
        \ box-sizing:border-box !important; padding:14px !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  rgba(12,14,16,0.86)\
        \ !important;\n      border:1px solid rgba(255,255,255,0.06) !important;\n\
        \      border-radius:20px !important;\n      box-shadow: 0 18px 50px rgba(0,0,0,0.45),\
        \ 0 0 18px rgba(80,180,255,0.14) !important;\n      backdrop-filter: blur(10px);\n\
        \    }\n    .wrap > .title{ display:none !important; }\n    .grid{ width:100%\
        \ !important; max-width:100% !important; display:flex !important; flex-direction:column\
        \ !important;\n      gap:10px !important; padding:0 !important; background:transparent\
        \ !important; border:none !important; box-shadow:none !important;\n    }\n\
        \    .row{ width:100% !important; display:grid !important; grid-template-columns:\
        \ 1fr auto auto !important; column-gap:10px !important;\n      align-items:center\
        \ !important; padding:12px 14px !important; border-radius:18px !important;\n\
        \      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.035)\
        \ 100%) !important;\n      border:1px solid rgba(255,255,255,0.10) !important;\n\
        \      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), inset 0 -1px 0 rgba(0,0,0,0.38)\
        \ !important;\n    }\n    .name{ font-size:18px !important; font-weight:650\
        \ !important; color:rgba(255,255,255,0.84) !important; }\n    .val{ font-size:30px\
        \ !important; font-weight:800 !important; line-height:1 !important; font-variant-numeric:\
        \ tabular-nums !important; text-align:right !important; }\n    .unit{ font-size:16px\
        \ !important; font-weight:700 !important; opacity:0.65 !important; letter-spacing:0.3px\
        \ !important; text-transform:uppercase !important; }\n    @media (max-width:600px){\n\
        \      .wrap{ padding:12px !important; border-radius:18px !important; }\n\
        \      .row{ padding:11px 12px !important; border-radius:16px !important;\
        \ }\n      .name{ font-size:17px !important; }\n      .val{ font-size:28px\
        \ !important; }\n      .unit{ font-size:15px !important; }\n    }\n    /*****\
        \ FIX: make panel + pills stretch full width (no left-column cutout) *****/\n\
        \    .wrap{\n      display:block !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n      flex:\
        \ 1 1 auto !important;\n    }\n    .grid{\n      display:flex !important;\n\
        \      flex-direction:column !important;\n      align-items:stretch !important;\n\
        \      justify-content:flex-start !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n    }\n\
        \    .row{\n      width:100% !important;\n      max-width:none !important;\n\
        \      min-width:0 !important;\n    }\n    \n    /* --- vNEXT: center panel\
        \ + prevent right-cut (global) --- */\n    .wrap{\nwidth: 100% !important;\n\
        display: flex !important;\njustify-content: center !important;\n    }\n  \
        \  .grid{\nwidth: 100% !important;\nmax-width: min(560px, 100%) !important;\n\
        \    }\n    .row{\nwidth: 100% !important;\nmax-width: 100% !important;\n\
        box-sizing: border-box !important;\ndisplay: grid !important;\ngrid-template-columns:\
        \ 1fr auto auto !important;\ncolumn-gap: 14px !important;\nalign-items: center\
        \ !important;\njustify-content: initial !important;\ngap: 0 !important;\n\
        overflow: visible !important;\n    }\n    .name{\nwhite-space: nowrap !important;\n\
        overflow: hidden !important;\ntext-overflow: ellipsis !important;\nmin-width:\
        \ 0 !important;\n    }\n    .val, .unit{\nwhite-space: nowrap !important;\n\
        \    }\n    .unit{ padding-right: 6px !important; }\n\n    /* Center the inner\
        \ panel within the popup */\n\n    .wrap{\n\n      max-width: 520px !important;\n\
        \n      margin: 0 auto !important;\n\n    }\n\n    /* ===== Typography + layout\
        \ (global override) ===== */\n    .wrap {\n      width: min(900px, 100%) !important;\n\
        \      margin: 0 auto !important;\n    }\n    .grid {\n      width: 100% !important;\n\
        \    }\n    .row {\n      display: grid !important;\n      grid-template-columns:\
        \ 1fr auto auto !important;\n      align-items: center !important;\n     \
        \ column-gap: 12px !important;\n      padding: 14px 18px !important;\n   \
        \   border-radius: 999px !important;\n    }\n    .name {\n      font-size:\
        \ clamp(14px, 2.1vw, 18px) !important;\n      font-weight: 750 !important;\n\
        \      letter-spacing: 0.08em !important;\n      text-transform: uppercase\
        \ !important;\n      opacity: 0.92 !important;\n    }\n    .val {\n      font-size:\
        \ clamp(28px, 4.2vw, 46px) !important;\n      font-weight: 850 !important;\n\
        \      letter-spacing: -0.02em !important;\n      font-variant-numeric: tabular-nums\
        \ !important;\n      line-height: 1 !important;\n      color: #f5a623 !important;\n\
        \    }\n    .unit {\n      font-size: clamp(13px, 1.9vw, 18px) !important;\n\
        \      font-weight: 750 !important;\n      letter-spacing: 0.06em !important;\n\
        \      text-transform: uppercase !important;\n      opacity: 0.55 !important;\n\
        \    }\n    </style>\n    <div class=\"wrap\">\n      <div class=\"title\"\
        >DC/AC</div>\n      <div class=\"grid\">\n        ${row(\"PV Power\",    \
        \   fmtP(pv),   unitP(pv),   \"#f5a623\", 0)}\n        ${row(\"Battery Power\"\
        ,  fmtP(batt), unitP(batt), \"#ff4ea1\", 1)}\n        ${row(\"Home Power\"\
        ,     fmtP(home), unitP(home), \"#34d3c6\", 2)}\n        ${row(\"Grid Import\"\
        ,    fmtP(gi),   unitP(gi),   \"#4da3ff\", 3)}\n        ${row(\"Grid Export\"\
        ,    fmtP(ge),   unitP(ge),   \"#4da3ff\", 4)}\n      </div>\n    </div>\n\
        \        `;\n      ]]]\n"
- type: custom:popup-card
  popup_card_id: alarm_popup
  title: Inverter Status / Alarm
  timeout: 0
  dismissable: true
  size: normal
  style: "\nha-dialog .mdc-dialog__content { padding: 0 !important; } ha-dialog .mdc-dialog__surface\
    \ { background: transparent !important; } ha-dialog::part(header) { display: none\
    \ !important; }\nbrowser-mod-popup::part(header) { display: none !important; }\n\
    ha-dialog .mdc-dialog__surface { border-radius: 26px !important; overflow: hidden\
    \ !important; width: min(var(--popup-width, 420px), 95vw) !important; max-width:\
    \ 95vw !important; }\n      @media (max-width: 800px) {\n  ha-dialog .mdc-dialog__surface\
    \ {\n    position: fixed !important; left: 0 !important; right: 0 !important;\
    \ bottom: 0 !important; top: auto !important;\n    margin: 0 !important; width:\
    \ 100vw !important; max-width: 100vw !important; border-radius: 26px 26px 0 0\
    \ !important;\n        }\n      }\n"
  card:
    type: custom:button-card
    triggers_update:
    - binary_sensor.anenji_inverter_der_alarm_active
    - sensor.anenji_inverter_battery_charge_power
    - sensor.anenji_inverter_battery_current
    - sensor.anenji_inverter_battery_power_signed
    - sensor.anenji_inverter_battery_soc
    - sensor.anenji_inverter_battery_voltage
    - sensor.anenji_inverter_fault_alarm
    - sensor.anenji_inverter_grid_export_power_filtered
    - sensor.anenji_inverter_grid_import_power_filtered
    - sensor.anenji_inverter_load_power_total_output
    - sensor.anenji_inverter_pv1_current
    - sensor.anenji_inverter_pv1_power
    - sensor.anenji_inverter_pv1_voltage
    - sensor.anenji_inverter_pv2_current
    - sensor.anenji_inverter_pv2_power
    - sensor.anenji_inverter_pv2_voltage
    - sensor.shellyem_c4d8d500468f_channel_1_power
    - sensor.shellyem_c4d8d500468f_channel_2_power
    update_interval: 1
    show_name: false
    show_icon: false
    show_state: false
    styles:
      card:
      - padding: 14px 14px 12px
      - border-radius: 0px
      - overflow: hidden
      - box-shadow: none
      - background: rgba(13,18,22,0.82)
      - border: none
      - color: '#fff'
      grid:
      - grid-template-areas: '"rows"'
      - grid-template-columns: 1fr
      - justify-items: center
      - align-items: start
      - text-align: left
      custom_fields:
        rows:
        - justify-self: center
        - align-self: start
        - text-align: left
        - width: 100%
        - max-width: 520px
    custom_fields:
      rows: "[[[\n  const H=hass;\n  const state=(eid)=>H?.states?.[eid]?.state ??\
        \ \"—\";\n\n  const fault = state(\"sensor.anenji_inverter_fault_alarm\");\n\
        \  const der   = state(\"binary_sensor.anenji_inverter_der_alarm_active\"\
        );\n\n  const ACCENT=\"#f5a623\";\n  const ACCENT_RGB=\"245,166,35\";\n  const\
        \ row=(label, value, unit, color=ACCENT, glow=0.25, idx=0)=>`\n    <div class=\"\
        row\" data-i=\"${idx}\">\n      <div class=\"name\">${label}</div>\n     \
        \ <div class=\"val\" style=\"color:${ACCENT}; text-shadow: 0 0 ${6+14*glow}px\
        \ rgba(245,166,35,${0.16+0.24*glow});\">${value}</div>\n      <div class=\"\
        unit\">${unit}</div>\n    </div>\n  `;\n\n  return `\n    <style>\n      /*\
        \ --- Popup header compact + remove big white area --- */\n      .wrap{background:\
        \ rgba(15,20,24,0.94) !important; padding: 12px !important; border-radius:\
        \ 22px !important; gap: 10px !important;}\n      .title{margin: 0 0 8px 0\
        \ !important; font-size: 18px !important; font-weight: 800 !important; letter-spacing:\
        \ .3px !important; color: #fff !important; text-align: center !important;\
        \ width: 100% !important;}\n\n      .wrap{display:flex;flex-direction:column;gap:10px;}\n\
        \      .title{font-weight:900;letter-spacing:.3px;font-size:14px;color:#fff;text-shadow:0\
        \ 0 10px rgba(255,255,255,0.22);}\n                                  :root{--popup-width:380px;}\n\
        \        @media (max-width: 600px){\n          :root{--popup-width:95vw;}\n\
        \        }\n        .grid{display:flex;flex-direction:column;gap:8px;}\n \
        \     .row{display:grid;\n        max-width: fit-content;grid-template-columns:\
        \ 1fr auto auto;\n        column-gap: 10px;align-items:baseline;gap:10px;padding:8px\
        \ 10px;border-radius:14px;background:rgba(255,255,255,0.04);border:1px solid\
        \ rgba(255,255,255,0.06);}\n      .name{color:rgba(255,255,255,0.80);font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}\n\
        \      .val{justify-self:start;font-weight:1000;font-size:14px;line-height:1;color:#fff;text-shadow:0\
        \ 0 10px rgba(255,255,255,0.18);}\n      .unit{justify-self:start;color:rgba(255,255,255,0.55);font-weight:900;font-size:12px;letter-spacing:.2px;}\n\
        \      @media (max-width:768px){\n        .row{grid-template-columns:150px\
        \ 1fr 30px;padding:7px 9px;}\n        .name{font-size:12.5px;}\n        .val{font-size:13.5px;}\n\
        \        .unit{font-size:11.5px;}\n      }\n    /* --- FINAL spacing override\
        \ (tight label + value + unit) --- */\n    .row{\n      display: flex !important;\n\
        \      align-items: center !important;\n      justify-content: flex-start\
        \ !important;\n      gap: 14px !important;\n      width: fit-content !important;\n\
        \      max-width: var(--popup-width) !important;\n    }\n    .name{ flex:\
        \ 0 0 auto !important; }\n    .val{  flex: 0 0 auto !important; margin: 0\
        \ !important; }\n    .unit{ flex: 0 0 auto !important; margin: 0 !important;\
        \ opacity: 0.75 !important; }\n    /* --- Prevent parent stretch (key for\
        \ tight pills) --- */\n    .grid{\n      align-items: flex-start !important;\n\
        \    }\n    .row{\n      align-self: flex-start !important;\n    }\n    /*\
        \ --- Align values (fixed label width) --- */\n    :root{\n      --label-width:\
        \ 170px;\n    }\n    @media (max-width: 600px){\n      :root{\n        --label-width:\
        \ 140px;\n      }\n    }\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width)\
        \ !important;\n      width: var(--label-width) !important;\n      white-space:\
        \ nowrap !important;\n      overflow: hidden !important;\n      text-overflow:\
        \ ellipsis !important;\n    }\n    .row > :nth-child(2){\n      min-width:\
        \ 64px !important;\n      text-align: right !important;\n    }\n    /*****\
        \ INDUSTRIAL THEME *****/\n    :root{\n      --panel-bg: rgba(20,22,24,0.92);\n\
        \      --pill-bg: rgba(255,255,255,0.04);\n      --pill-border: rgba(255,255,255,0.10);\n\
        \      --text-dim: rgba(255,255,255,0.72);\n      --text-dimmer: rgba(255,255,255,0.55);\n\
        \      --shadow-soft: 0 10px 30px rgba(0,0,0,0.35);\n      --shadow-inset:\
        \ inset 0 1px 0 rgba(255,255,255,0.05), inset 0 -1px 0 rgba(0,0,0,0.25);\n\
        \    }\n    \n    .wrap{ width:100% !important; max-width:100% !important;\
        \ }\n    .grid{\n      width: 100% !important;\n      max-width: var(--popup-width)\
        \ !important;\n      background: var(--panel-bg) !important;\n      border:\
        \ 1px solid rgba(255,255,255,0.06) !important;\n      border-radius: 16px\
        \ !important;\n      padding: 14px 14px 12px !important;\n      box-shadow:\
        \ var(--shadow-soft) !important;\n    }\n    \n    .row{\n      width: 100%\
        \ !important;\n      display: flex !important;\n      align-items: center\
        \ !important;\n      gap: 10px !important;\n      padding: 12px 14px !important;\n\
        \      border-radius: 16px !important;\n      background: var(--pill-bg) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--shadow-inset) !important;\n    }\n    \n    .row > :nth-child(1){\n\
        \      flex: 0 0 var(--label-width) !important;\n      width: var(--label-width)\
        \ !important;\n      color: var(--text-dim) !important;\n      font-weight:\
        \ 700 !important;\n      letter-spacing: 0.2px !important;\n      text-transform:\
        \ uppercase !important;\n      font-size: 13px !important;\n    }\n    .row\
        \ > :nth-child(2){\n      font-variant-numeric: tabular-nums !important;\n\
        \      font-weight: 800 !important;\n      font-size: 22px !important;\n \
        \     line-height: 1 !important;\n    }\n    .row > :nth-child(3){\n     \
        \ color: var(--text-dimmer) !important;\n      font-weight: 700 !important;\n\
        \      font-size: 13px !important;\n      margin-left: 4px !important;\n \
        \     letter-spacing: 0.4px !important;\n      text-transform: uppercase !important;\n\
        \    }\n    \n    .row + .row{\n      margin-top: 10px !important;\n    }\n\
        \    \n    @media (max-width: 600px){\n      .grid{ padding: 12px !important;\
        \ border-radius: 14px !important; }\n      .row{ padding: 11px 12px !important;\
        \ border-radius: 14px !important; }\n      .row > :nth-child(2){ font-size:\
        \ 20px !important; }\n    }\n    /***** TESLA-STYLE UI (soft glow, glass pills,\
        \ tight rhythm) *****/\n    :root{\n      --panel-bg: rgba(12,14,16,0.82);\n\
        \      --panel-border: rgba(255,255,255,0.06);\n      --pill-bg: rgba(255,255,255,0.055);\n\
        \      --pill-bg-2: rgba(255,255,255,0.035);\n      --pill-border: rgba(255,255,255,0.08);\n\
        \      --text: rgba(255,255,255,0.92);\n      --text-dim: rgba(255,255,255,0.72);\n\
        \      --text-dimmer: rgba(255,255,255,0.55);\n      --shadow: 0 18px 50px\
        \ rgba(0,0,0,0.45);\n      --inset: inset 0 1px 0 rgba(255,255,255,0.07),\
        \ inset 0 -1px 0 rgba(0,0,0,0.35);\n      --glow: 0 0 18px rgba(80,180,255,0.14);\n\
        \      --radius: 18px;\n    }\n    \n    /* Panel */\n    .wrap{ width:100%\
        \ !important; max-width:100% !important; }\n    .grid{\n      width: 100%\
        \ !important;\n      max-width: var(--popup-width) !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  var(--panel-bg) !important;\n\
        \      border: 1px solid var(--panel-border) !important;\n      border-radius:\
        \ calc(var(--radius) + 2px) !important;\n      padding: 12px 12px 10px !important;\n\
        \      box-shadow: var(--shadow), var(--glow) !important;\n      backdrop-filter:\
        \ blur(10px);\n    }\n    \n    /* Rows (glass pills) */\n    .row{\n    \
        \  width: 100% !important;\n      display: flex !important;\n      align-items:\
        \ center !important;\n      gap: 10px !important;\n      padding: 10px 12px\
        \ !important;\n      border-radius: var(--radius) !important;\n      background:\
        \ linear-gradient(180deg, var(--pill-bg) 0%, var(--pill-bg-2) 100%) !important;\n\
        \      border: 1px solid var(--pill-border) !important;\n      box-shadow:\
        \ var(--inset) !important;\n    }\n    \n    /* Tight rhythm */\n    .row\
        \ + .row{ margin-top: 8px !important; }\n    \n    /* Label / value / unit\
        \ */\n    .row > :nth-child(1){\n      flex: 0 0 var(--label-width) !important;\n\
        \      width: var(--label-width) !important;\n      color: var(--text-dim)\
        \ !important;\n      font-weight: 650 !important;\n      letter-spacing: 0.18px\
        \ !important;\n      font-size: 13px !important;\n      text-transform: none\
        \ !important;\n    }\n    .row > :nth-child(2){\n      color: var(--text)\
        \ !important;\n      font-variant-numeric: tabular-nums !important;\n    \
        \  font-weight: 800 !important;\n      font-size: 22px !important;\n     \
        \ line-height: 1 !important;\n      text-align: right !important;\n      min-width:\
        \ 68px !important;\n    }\n    .row > :nth-child(3){\n      color: var(--text-dimmer)\
        \ !important;\n      font-weight: 700 !important;\n      font-size: 12px !important;\n\
        \      letter-spacing: 0.3px !important;\n      text-transform: uppercase\
        \ !important;\n    }\n    \n    /* Subtle hover (desktop) */\n    @media (hover:hover){\n\
        \      .row:hover{\n        border-color: rgba(255,255,255,0.14) !important;\n\
        \        box-shadow: var(--inset), 0 0 18px rgba(255,255,255,0.06) !important;\n\
        \      }\n    }\n    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n\
        \      .grid{ padding: 10px !important; border-radius: 18px !important; }\n\
        \      .row{ padding: 10px 11px !important; border-radius: 16px !important;\
        \ }\n      .row > :nth-child(2){ font-size: 20px !important; min-width: 62px\
        \ !important; }\n      .row > :nth-child(1){ font-size: 12.5px !important;\
        \ }\n    }\n    /***** TESLA POPUP REFINEMENT (based on your HTML structure)\
        \ *****/\n    \n    /* 1) Remove inner dark title (e.g., PV/Battery) */\n\
        \    .wrap > .title{\n      display: none !important;\n    }\n    \n    /*\
        \ 2) Make panel/rows use full available width (kills right-side empty gap)\
        \ */\n    .wrap{\n      width: min(var(--popup-width), 95vw) !important;\n\
        \      max-width: min(var(--popup-width), 95vw) !important;\n    }\n    .grid{\n\
        \      width: 100% !important;\n      max-width: 100% !important;\n      display:\
        \ flex !important;\n      flex-direction: column !important;\n      align-items:\
        \ stretch !important;   /* critical: prevents centered/narrow rows */\n  \
        \  }\n    \n    /* 3) Row layout: label left, value+unit tight right */\n\
        \    .row{\n      width: 100% !important;\n      display: grid !important;\n\
        \      grid-template-columns: 1fr auto auto !important;\n      column-gap:\
        \ 10px !important;\n      align-items: center !important;\n    }\n    \n \
        \   /* 4) Typography: make labels bigger & consistent with values */\n   \
        \ .name{\n      font-size: 18px !important;\n      font-weight: 650 !important;\n\
        \      color: rgba(255,255,255,0.82) !important;\n      letter-spacing: 0.12px\
        \ !important;\n    }\n    .val{\n      font-size: 30px !important;\n     \
        \ font-weight: 800 !important;\n      line-height: 1 !important;\n      text-align:\
        \ right !important;\n      font-variant-numeric: tabular-nums !important;\n\
        \    }\n    .unit{\n      font-size: 16px !important;\n      font-weight:\
        \ 700 !important;\n      opacity: 0.65 !important;\n      letter-spacing:\
        \ 0.3px !important;\n      text-transform: uppercase !important;\n    }\n\
        \    \n    /* Mobile tuning */\n    @media (max-width: 600px){\n      .name{\
        \ font-size: 17px !important; }\n      .val{ font-size: 28px !important; }\n\
        \      .unit{ font-size: 15px !important; }\n    }\n    /***** TESLA PILLS\
        \ + FULL-WIDTH PANEL (ALL POPUPS) *****/\n    .wrap{ width:100% !important;\
        \ box-sizing:border-box !important; padding:14px !important;\n      background:\
        \ radial-gradient(120% 140% at 10% 0%, rgba(80,180,255,0.10) 0%, rgba(255,255,255,0.00)\
        \ 42%),\n                  linear-gradient(180deg, rgba(255,255,255,0.05)\
        \ 0%, rgba(255,255,255,0.02) 100%),\n                  rgba(12,14,16,0.86)\
        \ !important;\n      border:1px solid rgba(255,255,255,0.06) !important;\n\
        \      border-radius:20px !important;\n      box-shadow: 0 18px 50px rgba(0,0,0,0.45),\
        \ 0 0 18px rgba(80,180,255,0.14) !important;\n      backdrop-filter: blur(10px);\n\
        \    }\n    .wrap > .title{ display:none !important; }\n    .grid{ width:100%\
        \ !important; max-width:100% !important; display:flex !important; flex-direction:column\
        \ !important;\n      gap:10px !important; padding:0 !important; background:transparent\
        \ !important; border:none !important; box-shadow:none !important;\n    }\n\
        \    .row{ width:100% !important; display:grid !important; grid-template-columns:\
        \ 1fr auto auto !important; column-gap:10px !important;\n      align-items:center\
        \ !important; padding:12px 14px !important; border-radius:18px !important;\n\
        \      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.035)\
        \ 100%) !important;\n      border:1px solid rgba(255,255,255,0.10) !important;\n\
        \      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), inset 0 -1px 0 rgba(0,0,0,0.38)\
        \ !important;\n    }\n    .name{ font-size:18px !important; font-weight:650\
        \ !important; color:rgba(255,255,255,0.84) !important; }\n    .val{ font-size:30px\
        \ !important; font-weight:800 !important; line-height:1 !important; font-variant-numeric:\
        \ tabular-nums !important; text-align:right !important; }\n    .unit{ font-size:16px\
        \ !important; font-weight:700 !important; opacity:0.65 !important; letter-spacing:0.3px\
        \ !important; text-transform:uppercase !important; }\n    @media (max-width:600px){\n\
        \      .wrap{ padding:12px !important; border-radius:18px !important; }\n\
        \      .row{ padding:11px 12px !important; border-radius:16px !important;\
        \ }\n      .name{ font-size:17px !important; }\n      .val{ font-size:28px\
        \ !important; }\n      .unit{ font-size:15px !important; }\n    }\n    /*****\
        \ FIX: make panel + pills stretch full width (no left-column cutout) *****/\n\
        \    .wrap{\n      display:block !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n      flex:\
        \ 1 1 auto !important;\n    }\n    .grid{\n      display:flex !important;\n\
        \      flex-direction:column !important;\n      align-items:stretch !important;\n\
        \      justify-content:flex-start !important;\n      width:100% !important;\n\
        \      max-width:none !important;\n      min-width:0 !important;\n    }\n\
        \    .row{\n      width:100% !important;\n      max-width:none !important;\n\
        \      min-width:0 !important;\n    }\n    \n    /* --- vNEXT: center panel\
        \ + prevent right-cut (global) --- */\n    .wrap{\nwidth: 100% !important;\n\
        display: flex !important;\njustify-content: center !important;\n    }\n  \
        \  .grid{\nwidth: 100% !important;\nmax-width: min(560px, 100%) !important;\n\
        \    }\n    .row{\nwidth: 100% !important;\nmax-width: 100% !important;\n\
        box-sizing: border-box !important;\ndisplay: grid !important;\ngrid-template-columns:\
        \ 1fr auto auto !important;\ncolumn-gap: 14px !important;\nalign-items: center\
        \ !important;\njustify-content: initial !important;\ngap: 0 !important;\n\
        overflow: visible !important;\n    }\n    .name{\nwhite-space: nowrap !important;\n\
        overflow: hidden !important;\ntext-overflow: ellipsis !important;\nmin-width:\
        \ 0 !important;\n    }\n    .val, .unit{\nwhite-space: nowrap !important;\n\
        \    }\n    .unit{ padding-right: 6px !important; }\n\n    /* Center the inner\
        \ panel within the popup */\n\n    .wrap{\n\n      max-width: 520px !important;\n\
        \n      margin: 0 auto !important;\n\n    }\n\n    /* ===== Typography + layout\
        \ (global override) ===== */\n    .wrap {\n      width: min(900px, 100%) !important;\n\
        \      margin: 0 auto !important;\n    }\n    .grid {\n      width: 100% !important;\n\
        \    }\n    .row {\n      display: grid !important;\n      grid-template-columns:\
        \ 1fr auto auto !important;\n      align-items: center !important;\n     \
        \ column-gap: 12px !important;\n      padding: 14px 18px !important;\n   \
        \   border-radius: 999px !important;\n    }\n    .name {\n      font-size:\
        \ clamp(14px, 2.1vw, 18px) !important;\n      font-weight: 750 !important;\n\
        \      letter-spacing: 0.08em !important;\n      text-transform: uppercase\
        \ !important;\n      opacity: 0.92 !important;\n    }\n    .val {\n      font-size:\
        \ clamp(28px, 4.2vw, 46px) !important;\n      font-weight: 850 !important;\n\
        \      letter-spacing: -0.02em !important;\n      font-variant-numeric: tabular-nums\
        \ !important;\n      line-height: 1 !important;\n      color: #f5a623 !important;\n\
        \    }\n    .unit {\n      font-size: clamp(13px, 1.9vw, 18px) !important;\n\
        \      font-weight: 750 !important;\n      letter-spacing: 0.06em !important;\n\
        \      text-transform: uppercase !important;\n      opacity: 0.55 !important;\n\
        \    }\n    </style>\n    <div class=\"wrap\">\n      <div class=\"title\"\
        >Inverter Status / Alarm</div>\n      <div class=\"grid\">\n        ${row(\"\
        Fault Alarm\", fault, 1)}\n      </div>\n    </div>\n        `;\n      ]]]\n"
    ha-dialog .mdc-dialog__content { padding: 0 !important; }
    browser-mod-popup { padding: 0 !important; }

